<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é¤…ã¤ãã‚²ãƒ¼ãƒ  - é¤…ã‚’ã¤ã‘ï¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Zen Maru Gothic", "Arial", sans-serif;
        font-weight: 700;
        background: linear-gradient(180deg, #dc143c 0%, #dc143c 50%, #fff 50%, #fff 100%);
        background-size: 100px 100px;
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: repeating-linear-gradient(90deg, #dc143c 0px, #dc143c 200px, #fff 200px, #fff 400px);
      }

      #game-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      #video-container {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 200px;
        height: 150px;
        border: 3px solid #8b4513;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        background: #000;
        z-index: 1000;
        display: none;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(139, 69, 19, 0.95);
        padding: 30px;
        border-radius: 12px;
        border: 3px solid #ffd700;
        text-align: center;
        z-index: 10000;
        color: white;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #654321;
        border-top: 4px solid #ffd700;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
      #score-display {
        display: none;
      }

      /* ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ‘ãƒãƒ« */
      #info {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        padding: 20px 24px;
        border-radius: 20px;
        z-index: 1000;
        padding-block: 50px;
        padding-inline: 42px;
      }

      .info-icon {
        font-size: 40px;
        margin-right: 6px;
      }

      #info h1 {
        font-size: 17px;
        color: #000;
        margin-bottom: 24px;
        font-weight: bold;
      }

      #info p {
        font-size: 13px;
        color: #6b4423;
        margin: 6px 0;
        opacity: 0.9;
      }

      #mochi-count {
        font-size: 24px;
        color: #e7141b;
        font-weight: 900;
      }

      .info-remaining {
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 16px;
      }

      /* å®Œæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
      #complete-message {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        font-weight: bold;
        color: #212121;
        z-index: 5000;
        animation: completeAppear 0.8s ease-out;
        white-space: nowrap;
        background-color: #fff;
        padding: 10px 20px;
        border-radius: 12px;
      }

      #complete-message.hidden {
        display: none;
      }

      @keyframes completeAppear {
        0% {
          transform: translate(-50%, -50%) scale(0);
          opacity: 0;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.2);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
      }

      #growth-bar-container {
        width: 100%;
        height: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        margin-top: 10px;
        overflow: hidden;
      }

      #growth-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #fff, #ffd700);
        border-radius: 6px;
        transition: width 0.3s ease-out;
      }

      #growth-text {
        font-size: 14px;
        margin-top: 5px;
        color: rgba(255, 255, 255, 0.8);
      }

      /* æŒ‡ç¤ºãƒ†ã‚­ã‚¹ãƒˆ */
      #instruction {
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        font-weight: bold;
        color: #fff;
        padding: 10px;
        border-radius: 10px;
        background-color: #6f6f6f;
        z-index: 100;
        overflow: hidden;
      }

      /* æ‰‹ã®ä½ç½®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
      #hand-indicator {
        position: fixed;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 215, 0, 0.5);
        border: 4px solid #ffd700;
        pointer-events: none;
        z-index: 999;
        transform: translate(-50%, -50%);
        display: none;
      }

      #hand-indicator.active {
        display: block;
      }

      /* ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
      .hit-effect {
        position: fixed;
        font-size: 60px;
        pointer-events: none;
        z-index: 9000;
        animation: hitPop 0.6s ease-out forwards;
      }

      @keyframes hitPop {
        0% {
          transform: translate(-50%, -50%) scale(0);
          opacity: 1;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -80%) scale(1);
          opacity: 0;
        }
      }

      /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« */
      #tutorial-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 20000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #tutorial-modal.hidden {
        display: none;
      }

      .tutorial-content {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        color: white;
        border: #fff solid 1px;
      }

      .tutorial-content h1 {
        font-size: 32px;
        color: #fff;
        margin-bottom: 30px;
      }

      .slides-container {
        position: relative;
        width: 100%;
        height: 320px;
        overflow: hidden;
      }

      .slide {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.5s ease,
          transform 0.5s ease;
      }

      .slide.active {
        opacity: 1;
        transform: translateX(0);
      }

      .slide.prev {
        opacity: 0;
        transform: translateX(-100%);
      }

      .slide-subtitle {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .hand-icons {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 25px;
      }

      .hand-icon {
        width: 100px;
        height: 120px;
      }

      .hand-icon svg {
        width: 100%;
        height: 100%;
        fill: white;
      }

      .arrow-icon {
        font-size: 30px;
        color: rgba(255, 255, 255, 0.7);
      }

      .gesture-demo {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-bottom: 25px;
      }

      .gesture-hand {
        font-size: 80px;
        animation: handSwing 1.5s ease-in-out infinite;
      }

      .gesture-arrow {
        font-size: 40px;
        color: rgba(255, 255, 255, 0.8);
        margin-top: -10px;
        animation: arrowBounce 1.5s ease-in-out infinite;
      }

      @keyframes handSwing {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(40px);
        }
      }

      @keyframes arrowBounce {
        0%,
        100% {
          opacity: 0.5;
          transform: translateY(0);
        }
        50% {
          opacity: 1;
          transform: translateY(20px);
        }
      }

      .slide-description {
        font-size: 18px;
        line-height: 1.8;
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
      }

      .slide .icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .slide .text {
        font-size: 20px;
        line-height: 1.6;
        text-align: center;
      }

      .slide .text strong {
        color: #ffd700;
        font-size: 24px;
      }

      .slide-indicators {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 25px 0;
      }

      .slide-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition:
          background 0.3s,
          transform 0.3s;
      }

      .slide-indicator.active {
        background: #ffd700;
        transform: scale(1.2);
      }

      .tutorial-button {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        color: #2a1a0a;
        background: #fff;
        border: none;
        border-radius: 2px;
        cursor: pointer;
      }

      .tutorial-button:active {
        transform: scale(0.98);
      }

      @media (max-width: 768px) {
        .tutorial-content {
          padding: 25px;
        }
        .tutorial-content h1 {
          font-size: 24px;
        }
        .slides-container {
          height: 280px;
        }
        .slide-subtitle {
          font-size: 20px;
        }
        .hand-icon {
          width: 70px;
          height: 90px;
        }
        .slide-description {
          font-size: 15px;
        }
        .slide .icon {
          font-size: 60px;
        }
        .slide .text {
          font-size: 16px;
        }
        .slide .text strong {
          font-size: 20px;
        }
        .tutorial-button {
          font-size: 20px;
          padding: 12px 40px;
        }
      }

      /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
      #debug-info {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }

      /* è£…é£¾ç”»åƒ */
      .decoration-image {
        position: fixed;
        bottom: 20px;
        z-index: 50;
        pointer-events: none;
      }

      #kadomatsu {
        left: 53px;
        height: calc(400 / 1440 * 100vw);
        width: auto;
      }

      #shishimai {
        right: 20px;
        height: calc(342 / 1440 * 100vw);
        width: auto;
      }
    </style>
  </head>
  <body>
    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tutorial-modal">
      <div class="tutorial-content">
        <h1>é¤…ã¤ãã‚²ãƒ¼ãƒ </h1>
        <!-- SVGã‚·ãƒ³ãƒœãƒ«å®šç¾© -->
        <svg style="display: none">
          <symbol id="iconHandOpen" viewBox="0 0 100 100">
            <path
              d="M50 10 L50 35 M35 15 L35 40 M65 15 L65 40 M25 25 L25 45 M75 25 L75 45 M20 45 Q15 50 15 60 L15 75 Q15 85 25 90 L75 90 Q85 85 85 75 L85 60 Q85 50 80 45 L80 25 Q80 20 75 20 L75 45 L65 45 L65 15 Q65 10 60 10 L60 35 L50 35 L50 10 Q50 5 45 5 L45 35 L35 35 L35 15 Q35 10 30 10 L30 40 L25 40 L25 25 Q25 20 20 20 L20 45 Z"
            ></path>
          </symbol>
          <symbol id="iconHandDown" viewBox="0 0 100 100">
            <path
              d="M30 20 Q25 20 25 25 L25 55 Q25 60 30 60 L70 60 Q75 60 75 55 L75 25 Q75 20 70 20 L30 20 Z M35 25 L35 55 M45 25 L45 55 M55 25 L55 55 M65 25 L65 55 M50 60 L50 70 M40 70 L60 70 L50 85 Z"
            ></path>
          </symbol>
        </svg>

        <div class="slides-container">
          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰1: æ“ä½œæ–¹æ³• -->
          <div class="slide active" data-slide="0">
            <div class="slide-subtitle">é¤…ã®ã¤ãæ–¹</div>
            <div class="gesture-demo">
              <div class="gesture-hand">ğŸ–ï¸</div>
              <div class="gesture-arrow">â†“</div>
            </div>
            <div class="slide-description">æ‰‹ã‚’ä¸Šã‹ã‚‰ä¸‹ã«<br />å‹¢ã„ã‚ˆãæŒ¯ã‚Šä¸‹ã‚ã—ã¾ã™</div>
          </div>

          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰2: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ« -->
          <div class="slide" data-slide="1">
            <div class="slide-subtitle">é¤…ã‚’å®Œæˆã•ã›ã‚ˆã†ï¼</div>
            <div class="icon">ğŸ¡</div>
            <div class="slide-description">
              é¤…ã‚’ã¤ãã¨æˆé•·ã—ã¦ã„ãã¾ã™<br />100%ã«ãªã£ãŸã‚‰å®Œæˆï¼<br />ç¾å‘³ã—ã„ã‚‚ã®ã«å¤‰åŒ–ã—ã¾ã™
            </div>
          </div>
        </div>
        <div class="slide-indicators">
          <div class="slide-indicator active" data-slide="0"></div>
          <div class="slide-indicator" data-slide="1"></div>
        </div>
        <button id="next-button" class="tutorial-button">æ¬¡ã¸</button>
        <button id="start-button" class="tutorial-button" style="display: none">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div id="loading" class="hidden">
      <div class="spinner"></div>
      <p>ã‚«ãƒ¡ãƒ©ã‚’æº–å‚™ä¸­...</p>
    </div>

    <div id="container">
      <canvas id="game-canvas"></canvas>

      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ‘ãƒãƒ« -->
      <div id="info">
        <h1><span class="info-icon">ğŸ¡</span>é¤…ã¤ãã‚²ãƒ¼ãƒ </h1>
        <p>æ‰‹ã‚’æŒ¯ã‚Šä¸‹ã‚ã—ã¦é¤…ã‚’ã¤ã“ã†ï¼</p>
        <p class="info-remaining"><span class="info-icon">ğŸ¯</span>ã¤ãå›æ•° <span id="mochi-count">0</span> å›</p>
      </div>

      <div id="score-display">
        <div id="growth-bar-container">
          <div id="growth-bar"></div>
        </div>
        <div id="growth-text">é¤…ã®æˆé•·: 0%</div>
      </div>

      <!-- å®Œæˆè¡¨ç¤º -->
      <div id="complete-message" class="hidden">ğŸ å‡ºæ¥ä¸ŠãŒã‚Šï¼ ğŸ</div>

      <div id="instruction">é¤…ã‚’ã¤ã‘ï¼ï¼ï¼</div>

      <div id="hand-indicator"></div>

      <div id="debug-info"></div>

      <!-- è£…é£¾ç”»åƒ -->
      <img id="kadomatsu" class="decoration-image" src="mochitsuki_game-images/kadomatsu.png" alt="é–€æ¾" />
      <img id="shishimai" class="decoration-image" src="mochitsuki_game-images/shishimai.png" alt="ç…å­èˆ" />
    </div>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const loading = document.getElementById("loading");
      const gameCanvas = document.getElementById("game-canvas");
      const gameCtx = gameCanvas.getContext("2d");
      const handIndicator = document.getElementById("hand-indicator");
      const debugInfo = document.getElementById("debug-info");
      const completeMessage = document.getElementById("complete-message");

      let handLandmarker = null;
      let lastVideoTime = -1;

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
      let lastHitTime = 0;
      let isComplete = false;
      let completeDish = ""; // "oshiruko" or "ozoni"

      // æ‰‹ã®å‹•ãæ¤œå‡ºç”¨
      let handYHistory = [];
      const HISTORY_LENGTH = 10;
      let canHit = true;
      let lastHandY = 0;

      // æ‰‹ã®ä½ç½®ï¼ˆæµã‚’è¿½å¾“ã•ã›ã‚‹ç”¨ï¼‰
      let handScreenX = window.innerWidth / 2;
      let handScreenY = window.innerHeight * 0.3;
      let smoothHandX = handScreenX;
      let smoothHandY = handScreenY;

      // è‡¼ã®ä½ç½®ï¼ˆç”»é¢ä¸­å¤®ä¸‹éƒ¨ï¼‰
      const usuPosition = {
        x: window.innerWidth / 2,
        y: window.innerHeight * 0.7,
      };

      // é¤…ã®çŠ¶æ…‹ï¼ˆã‚‚ã¡ã‚‚ã¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
      const mochi = {
        baseWidth: 90, // åˆæœŸã‚µã‚¤ã‚º
        baseHeight: 70, // ã‚ˆã‚Šä¸¸ã
        currentWidth: 90,
        currentHeight: 70,
        squashAmount: 0, // æ½°ã‚Œå…·åˆ (0-1)
        squashVelocity: 0, // æ½°ã‚Œã®é€Ÿåº¦ï¼ˆãƒãƒç”¨ï¼‰
        wobble: 0, // ã·ã‚‹ã·ã‚‹æºã‚Œ
        wobbleSpeed: 0,
        offsetY: 0, // ä¸Šä¸‹ã®è·³ã­
        offsetYVelocity: 0,
        growth: 0, // æˆé•·åº¦ï¼ˆ0ã€œ1ã€å©ãã»ã©å¢—ãˆã‚‹ï¼‰
        targetGrowth: 0, // ç›®æ¨™æˆé•·åº¦
      };

      // æµã®çŠ¶æ…‹
      const kine = {
        x: window.innerWidth / 2,
        y: window.innerHeight * 0.3,
        rotation: -30,
        targetY: window.innerHeight * 0.3,
        isHitting: false,
        hitProgress: 0,
      };

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆã‚‚ã¡ç²’ï¼‰
      let particles = [];

      // ãŠã—ã‚‹ã“ç”¨ã®å°è±†ä½ç½®ï¼ˆäº‹å‰ç”Ÿæˆï¼‰
      const azukiBeans = [];
      for (let i = 0; i < 12; i++) {
        azukiBeans.push({
          offsetX: (Math.random() - 0.5) * 140,
          offsetY: (Math.random() - 0.5) * 30,
          sizeX: 4 + Math.random() * 3,
          sizeY: 3 + Math.random() * 2,
          rotation: Math.random(),
        });
      }

      // ç”»åƒã®èª­ã¿è¾¼ã¿
      const kineImage = new Image();
      kineImage.src = "mochitsuki_game-images/kine.png";

      const usuImage = new Image();
      usuImage.src = "mochitsuki_game-images/usu.png";

      const oshirukoImage = new Image();
      oshirukoImage.src = "mochitsuki_game-images/oshiruko.png";

      const zouniImage = new Image();
      zouniImage.src = "mochitsuki_game-images/zouni.png";

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
      function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        gameCanvas.width = window.innerWidth * dpr;
        gameCanvas.height = window.innerHeight * dpr;
        gameCanvas.style.width = window.innerWidth + "px";
        gameCanvas.style.height = window.innerHeight + "px";
        gameCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

        // è‡¼ã®ä½ç½®ã‚’æ›´æ–°
        usuPosition.x = window.innerWidth / 2;
        usuPosition.y = window.innerHeight * 0.7;
      }

      // é¤…ã‚’ã¤ãã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      function hitMochi(speed) {
        const now = Date.now();
        if (now - lastHitTime < 250) return;
        if (isComplete) return; // å®Œæˆå¾Œã¯å©ã‘ãªã„
        lastHitTime = now;

        // é¤…ã‚’æˆé•·ã•ã›ã‚‹ï¼ˆå©ãã»ã©å¤§ãããªã‚‹ï¼‰
        const growthIncrease = 0.08 + speed * 0.04; // ã‚¹ãƒ”ãƒ¼ãƒ‰ã«å¿œã˜ã¦æˆé•·ï¼ˆå¢—åŠ é‡UPï¼‰
        mochi.targetGrowth = Math.min(mochi.targetGrowth + growthIncrease, 1.0);

        // é¤…ã‚’å¼·ãæ½°ã™ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ»å¤§ããå¤‰å½¢ï¼‰
        const squashIntensity = Math.min(speed * 0.6, 1.0);
        mochi.squashAmount = squashIntensity;
        mochi.squashVelocity = -squashIntensity * 0.8; // ãƒãƒã®åå‹•ï¼ˆå¼·ã‚ï¼‰
        mochi.wobbleSpeed = Math.min(speed * 3, 12); // æºã‚Œï¼ˆå¤§ããï¼‰

        // é¤…ãŒä¸‹ã«æ²ˆã‚“ã§ã‹ã‚‰è·³ã­è¿”ã‚‹ï¼ˆå¤§ããï¼‰
        mochi.offsetY = Math.min(15 + speed * 4, 40);
        mochi.offsetYVelocity = -Math.min(speed * 4, 15);

        // ç²˜ã‚Šæ°—ã®ç³¸ã‚’ç”Ÿæˆï¼ˆæµãŒé›¢ã‚Œã‚‹æ™‚ã«ä¼¸ã³ã‚‹ï¼‰
        createStickyStrings(usuPosition.x, usuPosition.y - 50, speed);

        // ç”»é¢æºã‚Œï¼ˆå¼·ã‚ï¼‰
        shakeScreen(Math.min(speed * 5, 20));

        // æµã®ãƒ’ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        kine.isHitting = true;
        kine.hitProgress = 0;
      }

      // ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
      function showHitEffect(x, y, emoji) {
        const effect = document.createElement("div");
        effect.className = "hit-effect";
        effect.textContent = emoji;
        effect.style.left = `${x}px`;
        effect.style.top = `${y}px`;
        document.body.appendChild(effect);
        setTimeout(() => effect.remove(), 600);
      }

      // é¤…ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆï¼ˆã‚‚ã¡ã‚‚ã¡ã—ãŸç²’ï¼‰
      function createMochiParticles(x, y, count) {
        for (let i = 0; i < count; i++) {
          const angle = Math.PI + (Math.random() - 0.5) * Math.PI * 0.8;
          const speed = 3 + Math.random() * 6;
          particles.push({
            x: x + (Math.random() - 0.5) * 60,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed - 3,
            life: 1,
            size: 8 + Math.random() * 12,
            stretch: 1,
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: (Math.random() - 0.5) * 0.2,
          });
        }
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ›´æ–°
      function updateParticles() {
        particles = particles.filter((p) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.3;
          p.vx *= 0.98;
          p.life -= 0.015;
          p.rotation += p.rotationSpeed;
          // ä¼¸ã³ç¸®ã¿ï¼ˆã‚‚ã¡ã‚‚ã¡æ„Ÿï¼‰
          p.stretch = 1 + Math.abs(p.vy) * 0.05;
          return p.life > 0;
        });
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æç”»ï¼ˆã‚‚ã¡ã‚‚ã¡ã—ãŸå½¢ï¼‰
      function drawParticles() {
        particles.forEach((p) => {
          gameCtx.save();
          gameCtx.globalAlpha = p.life;
          gameCtx.translate(p.x, p.y);
          gameCtx.rotate(p.rotation);
          gameCtx.scale(1 / p.stretch, p.stretch);

          // ã‚‚ã¡ç²’ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
          const gradient = gameCtx.createRadialGradient(0, 0, 0, 0, 0, p.size);
          gradient.addColorStop(0, "rgba(255, 255, 255, 1)");
          gradient.addColorStop(0.7, "rgba(250, 245, 235, 1)");
          gradient.addColorStop(1, "rgba(240, 230, 210, 0.8)");

          gameCtx.fillStyle = gradient;
          gameCtx.beginPath();
          gameCtx.ellipse(0, 0, p.size * 0.8, p.size, 0, 0, Math.PI * 2);
          gameCtx.fill();

          gameCtx.restore();
        });
        gameCtx.globalAlpha = 1;
      }

      // ç”»é¢æºã‚Œ
      function shakeScreen(intensity = 10) {
        const container = document.getElementById("container");
        const duration = 100;
        const startTime = Date.now();

        function shake() {
          const elapsed = Date.now() - startTime;
          if (elapsed < duration) {
            const remaining = 1 - elapsed / duration;
            const offsetX = (Math.random() - 0.5) * intensity * remaining;
            const offsetY = (Math.random() - 0.5) * intensity * remaining;
            container.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            requestAnimationFrame(shake);
          } else {
            container.style.transform = "";
          }
        }
        shake();
      }

      // æˆé•·ãƒãƒ¼ã®è¦ç´ 
      const growthBar = document.getElementById("growth-bar");
      const growthText = document.getElementById("growth-text");

      // é¤…ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
      function updateMochi() {
        // æˆé•·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã˜ã‚ã˜ã‚å¤§ãããªã‚‹ï¼‰
        mochi.growth += (mochi.targetGrowth - mochi.growth) * 0.05;

        // ç›®æ¨™ãŒ100%ã«é”ã—ã¦ã„ãŸã‚‰ã€growthã‚‚100%ã«ã‚¹ãƒŠãƒƒãƒ—
        if (mochi.targetGrowth >= 1.0 && mochi.growth > 0.98) {
          mochi.growth = 1.0;
        }

        // æˆé•·ãƒãƒ¼ã‚’æ›´æ–°
        const growthPercent = Math.floor(mochi.growth * 100);
        growthBar.style.width = growthPercent + "%";
        growthText.textContent = `é¤…ã®æˆé•·: ${growthPercent}%`;

        // é€²æ—ã«å¿œã˜ã¦æŒ‡ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
        const instruction = document.getElementById("instruction");
        if (growthPercent < 25) {
          instruction.textContent = "é¤…ã‚’ã¤ã‘ï¼";
        } else if (growthPercent < 50) {
          instruction.textContent = "ã‚‚ã£ã¨ã¤ã‘ï¼";
        } else if (growthPercent < 75) {
          instruction.textContent = "ã‚‚ã†å°‘ã—ã¤ã‘ï¼";
        } else if (growthPercent < 100) {
          instruction.textContent = "ã‚ã¨ã¡ã‚‡ã£ã¨ï¼";
        }

        // å®Œæˆåˆ¤å®šï¼ˆ100%ã«é”ã—ãŸã‚‰ï¼‰
        if (mochi.targetGrowth >= 1.0 && mochi.growth >= 1.0 && !isComplete) {
          isComplete = true;
          // ãƒ©ãƒ³ãƒ€ãƒ ã§ãŠã—ã‚‹ã“ã‹ãŠé›‘ç…®ã‚’é¸æŠ
          completeDish = Math.random() < 0.5 ? "oshiruko" : "ozoni";
          const dishName = completeDish === "oshiruko" ? "ãŠã—ã‚‹ã“" : "ãŠé›‘ç…®";
          completeMessage.innerHTML = `ğŸ ${dishName}ã®å‡ºæ¥ä¸ŠãŒã‚Šï¼ ğŸ`;
          completeMessage.classList.remove("hidden");
          // UIã‚’éè¡¨ç¤º
          document.getElementById("instruction").style.display = "none";
          document.getElementById("score-display").style.display = "none";
        }

        // æˆé•·ã«å¿œã˜ãŸãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºï¼ˆæœ€å¤§2å€ã«ï¼‰
        const growthScale = 1 + mochi.growth * 1.0;
        mochi.baseWidth = 115 * growthScale;
        mochi.baseHeight = 90 * growthScale;

        // ãƒãƒç‰©ç†ï¼šæ½°ã‚Œã‹ã‚‰ã®å¾©å¸°ï¼ˆå¤§ããè·³ã­è¿”ã‚‹ï¼‰
        const springK = 0.12; // ãƒãƒå®šæ•°ï¼ˆã—ã£ã‹ã‚Šæˆ»ã‚‹ï¼‰
        const damping = 0.85; // æ¸›è¡°

        // ãƒãƒã®åŠ›ã§æˆ»ã‚‹
        mochi.squashVelocity += -mochi.squashAmount * springK;
        mochi.squashVelocity *= damping;
        mochi.squashAmount += mochi.squashVelocity;

        // å°ã•ããªã£ãŸã‚‰æ­¢ã‚ã‚‹
        if (Math.abs(mochi.squashAmount) < 0.005 && Math.abs(mochi.squashVelocity) < 0.005) {
          mochi.squashAmount = 0;
          mochi.squashVelocity = 0;
        }

        // ä¸Šä¸‹ã®è·³ã­ï¼ˆç²˜ã‚Šæ°—ã®ã‚ã‚‹ãƒãƒï¼‰
        mochi.offsetYVelocity += -mochi.offsetY * 0.12;
        mochi.offsetYVelocity *= 0.92;
        mochi.offsetY += mochi.offsetYVelocity;

        if (Math.abs(mochi.offsetY) < 0.5 && Math.abs(mochi.offsetYVelocity) < 0.5) {
          mochi.offsetY = 0;
          mochi.offsetYVelocity = 0;
        }

        // ã·ã‚‹ã·ã‚‹æºã‚Œï¼ˆç²˜ã‚Šæ°—ãŒã‚ã‚‹ã®ã§ã‚†ã£ãã‚Šåã¾ã‚‹ï¼‰
        mochi.wobble += mochi.wobbleSpeed;
        mochi.wobbleSpeed *= 0.94;

        const wobbleEffect = Math.sin(mochi.wobble) * mochi.wobbleSpeed * 0.03 * (1 + mochi.growth * 0.5);

        // ã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆæ½°ã‚Œã‚‹ã¨æ¨ªã«åºƒãŒã‚‹ï¼‰
        const clampedSquash = Math.max(0, Math.min(mochi.squashAmount, 1));
        const squashScale = 1 + clampedSquash * 0.6; // æ¨ªã¸ã®åºƒãŒã‚Š
        const stretchScale = 1 - clampedSquash * 0.3; // ç¸¦ã®æ½°ã‚Œ

        const clampedWobble = Math.max(-10, Math.min(wobbleEffect * 20, 10));
        mochi.currentWidth = mochi.baseWidth * squashScale + clampedWobble;
        mochi.currentHeight = mochi.baseHeight * stretchScale + Math.abs(clampedWobble) * 0.3;
      }

      // è‡¼ã‚’æç”»
      function drawUsu() {
        const x = usuPosition.x;
        const y = usuPosition.y;

        // è‡¼ã®ç”»åƒãŒã‚ã‚Œã°ä½¿ç”¨
        if (usuImage.complete && usuImage.naturalWidth > 0) {
          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ
          const imgWidth = usuImage.naturalWidth;
          const imgHeight = usuImage.naturalHeight;
          const aspectRatio = imgWidth / imgHeight;

          const usuHeight = 340;
          const usuWidth = usuHeight * aspectRatio;

          // è‡¼ã®å½±
          gameCtx.fillStyle = "rgba(0, 0, 0, 0.15)";
          gameCtx.beginPath();
          gameCtx.ellipse(x, y + usuHeight * 0.35, usuWidth * 0.45, 30, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // è‡¼ã®ç”»åƒã‚’æç”»
          const usuY = y - usuHeight * 0.3;
          gameCtx.drawImage(usuImage, x - usuWidth / 2, usuY, usuWidth, usuHeight);

          // é¤…ã‚’æç”»ï¼ˆè‡¼ã®ä¸­å¤®ä¸Šéƒ¨ã«é…ç½®ï¼‰
          // è‡¼ã®ä¸Šç«¯ã‹ã‚‰å°‘ã—ä¸‹ã®ä½ç½®ã«é¤…ã‚’é…ç½®
          const mochiY = usuY + usuHeight * 0.25;
          drawMochi(x, mochiY);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šCanvasæç”»
          // è‡¼ã®å½±
          gameCtx.fillStyle = "rgba(0, 0, 0, 0.2)";
          gameCtx.beginPath();
          gameCtx.ellipse(x, y + 80, 130, 35, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // è‡¼ï¼ˆå††æŸ±å½¢ï¼‰- åº•é¢
          gameCtx.fillStyle = "#a08050";
          gameCtx.beginPath();
          gameCtx.ellipse(x, y + 70, 125, 40, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // è‡¼ã®å´é¢ï¼ˆæœ¨ç›®é¢¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
          const sideGradient = gameCtx.createLinearGradient(x - 125, 0, x + 125, 0);
          sideGradient.addColorStop(0, "#8b7355");
          sideGradient.addColorStop(0.3, "#c4a35a");
          sideGradient.addColorStop(0.5, "#d4b896");
          sideGradient.addColorStop(0.7, "#c4a35a");
          sideGradient.addColorStop(1, "#8b7355");
          gameCtx.fillStyle = sideGradient;
          gameCtx.fillRect(x - 125, y - 10, 250, 80);

          // è‡¼ã®ä¸Šé¢
          const topGradient = gameCtx.createRadialGradient(x, y - 10, 0, x, y - 10, 125);
          topGradient.addColorStop(0, "#e8d4b8");
          topGradient.addColorStop(0.7, "#d4b896");
          topGradient.addColorStop(1, "#b8956e");
          gameCtx.fillStyle = topGradient;
          gameCtx.beginPath();
          gameCtx.ellipse(x, y - 10, 125, 40, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // è‡¼ã®å†…å´ï¼ˆãã¼ã¿ï¼‰
          gameCtx.fillStyle = "#8b7355";
          gameCtx.beginPath();
          gameCtx.ellipse(x, y - 5, 90, 28, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // é¤…ã‚’æç”»
          drawMochi(x, y - 25);
        }
      }

      // ç²˜ã‚Šæ°—ã®ã‚ã‚‹ç³¸ã‚’æç”»
      let stickyStrings = [];

      function createStickyStrings(x, y, intensity) {
        const count = Math.floor(2 + intensity * 3);
        for (let i = 0; i < count; i++) {
          stickyStrings.push({
            x: x + (Math.random() - 0.5) * 40,
            y: y,
            targetY: y - 30 - Math.random() * 40,
            length: 20 + Math.random() * 30,
            thickness: 2 + Math.random() * 3,
            life: 1,
            wobble: Math.random() * Math.PI * 2,
            wobbleSpeed: 0.1 + Math.random() * 0.1,
          });
        }
      }

      function updateStickyStrings() {
        stickyStrings = stickyStrings.filter((s) => {
          s.life -= 0.025;
          s.wobble += s.wobbleSpeed;
          s.length *= 0.96; // å¾ã€…ã«ç¸®ã‚€
          return s.life > 0;
        });
      }

      function drawStickyStrings(baseX, baseY) {
        stickyStrings.forEach((s) => {
          gameCtx.save();
          gameCtx.globalAlpha = s.life * 0.8;

          const wobbleX = Math.sin(s.wobble) * 3 * s.life;

          // ç²˜ã‚Šæ°—ã®ã‚ã‚‹ç³¸ï¼ˆãƒ™ã‚¸ã‚§æ›²ç·šã§è¡¨ç¾ï¼‰
          const gradient = gameCtx.createLinearGradient(s.x, baseY, s.x, s.targetY);
          gradient.addColorStop(0, "rgba(255, 253, 248, 0.9)");
          gradient.addColorStop(0.5, "rgba(250, 245, 235, 0.7)");
          gradient.addColorStop(1, "rgba(245, 240, 230, 0.3)");

          gameCtx.strokeStyle = gradient;
          gameCtx.lineWidth = s.thickness * s.life;
          gameCtx.lineCap = "round";

          gameCtx.beginPath();
          gameCtx.moveTo(s.x, baseY);
          gameCtx.quadraticCurveTo(s.x + wobbleX, baseY - s.length * 0.5, s.x + wobbleX * 2, baseY - s.length * s.life);
          gameCtx.stroke();

          gameCtx.restore();
        });
      }

      // é¤…ã‚’æç”»ï¼ˆã‚‚ã¡ã‚‚ã¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
      function drawMochi(x, baseY) {
        gameCtx.save();

        // offsetYã‚’é©ç”¨ï¼ˆå©ã„ãŸæ™‚ã«æ²ˆã‚€ï¼‰- å¤§ããå‹•ã
        const clampedOffsetY = Math.max(-50, Math.min(mochi.offsetY, 50));
        const y = baseY + clampedOffsetY;

        // ç¾åœ¨ã®å¤‰å½¢é‡ï¼ˆå¤§ããå¤‰å½¢ï¼‰
        const squash = Math.max(0, Math.min(mochi.squashAmount, 1));
        const wobbleAmt = Math.sin(mochi.wobble) * Math.min(mochi.wobbleSpeed, 10) * 0.8;

        // é¤…ã®ã‚µã‚¤ã‚ºï¼ˆæ¨ªé•·ã®ä¸¸é¤…ï¼‰
        const baseW = mochi.currentWidth * 0.5;
        const baseH = mochi.currentWidth * 0.28; // æ¨ªå¹…åŸºæº–ã§é«˜ã•ã‚’æ±ºã‚ã‚‹ï¼ˆå¸¸ã«æ¨ªé•·ï¼‰

        // ä¼¸ã³ç¸®ã¿ï¼ˆå¤§ããå¤‰å½¢ã—ã¦å©ã„ã¦ã„ã‚‹æ„Ÿã‚’å‡ºã™ï¼‰
        const stretchPhase = Math.sin(mochi.wobble * 0.3) * wobbleAmt * 0.25;
        const w = baseW * (1 + squash * 0.8 + stretchPhase); // æ¨ªã«å¤§ããåºƒãŒã‚‹
        const h = baseH * (1 - squash * 0.4 - stretchPhase * 0.3); // ç¸¦ã«æ½°ã‚Œã‚‹

        // ç²˜ã‚Šæ°—ã®ç³¸ã‚’æ›´æ–°ãƒ»æç”»
        updateStickyStrings();
        drawStickyStrings(x, y - h * 0.3);

        // é¤…æœ¬ä½“ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰- æˆé•·ã§è‰²ãŒå¤‰åŒ–
        // æœ€åˆã¯ãã™ã‚“ã è‰² â†’ å©ãã»ã©ç™½ããƒ„ãƒ¤ãŒå‡ºã‚‹
        const colorProgress = mochi.growth;
        const baseColor = Math.floor(245 + colorProgress * 10); // 245â†’255
        const midColor = Math.floor(235 + colorProgress * 15); // 235â†’250
        const edgeColor = Math.floor(220 + colorProgress * 20); // 220â†’240

        const mochiGradient = gameCtx.createRadialGradient(x - w * 0.2, y - h * 0.3, 0, x, y, Math.max(w, h) * 1.2);
        mochiGradient.addColorStop(0, `rgb(${baseColor}, ${baseColor}, ${baseColor})`);
        mochiGradient.addColorStop(0.4, `rgb(${midColor}, ${midColor - 2}, ${midColor - 5})`);
        mochiGradient.addColorStop(0.7, `rgb(${edgeColor}, ${edgeColor - 5}, ${edgeColor - 12})`);
        mochiGradient.addColorStop(1, `rgb(${edgeColor - 15}, ${edgeColor - 20}, ${edgeColor - 30})`);

        gameCtx.fillStyle = mochiGradient;

        // é¤…ã®å½¢çŠ¶ï¼ˆæˆé•·ã«å¿œã˜ã¦å¤‰åŒ–ï¼‰
        // æœ€åˆã¯ã‚´ãƒ„ã‚´ãƒ„ â†’ å©ãã»ã©æ»‘ã‚‰ã‹ã§ãã‚Œã„ãªä¸¸ã«
        gameCtx.beginPath();

        // æˆé•·åº¦ã«å¿œã˜ãŸå½¢çŠ¶ã®å¤‰åŒ–
        const roughness = Math.max(0, 1 - mochi.growth * 1.8); // æˆé•·ã§æ€¥é€Ÿã«æ»‘ã‚‰ã‹ã«

        // å®Œæˆã«è¿‘ã¥ãã»ã©ãã‚Œã„ãªä¸¸é¤…ã«
        if (mochi.growth > 0.85) {
          // å®Œæˆæ™‚ã¯ãã‚Œã„ãªä¸¸é¤…ï¼ˆæ¨ªé•·æ¥•å††ï¼‰
          const finalW = w * (1 + squash * 0.3);
          const finalH = h * (1 - squash * 0.2);
          gameCtx.ellipse(x, y, finalW, finalH, 0, 0, Math.PI * 2);
        } else {
          // æˆé•·ä¸­ã¯å°‘ã—ã‚´ãƒ„ã‚´ãƒ„ï¼ˆã§ã‚‚æ¨ªé•·ï¼‰
          const points = 16;
          const angleStep = (Math.PI * 2) / points;

          for (let i = 0; i <= points; i++) {
            const angle = i * angleStep;

            // ã‚´ãƒ„ã‚´ãƒ„æ„Ÿï¼ˆæˆé•·ã§æ¸›å°‘ï¼‰
            const bumpiness = Math.sin(angle * 4) * roughness * 5;
            const irregularity = Math.cos(angle * 7 + i * 0.5) * roughness * 3;

            // æºã‚ŒåŠ¹æœï¼ˆæˆé•·ã§æ¸›å°‘ï¼‰
            const wobbleOffset = Math.sin(mochi.wobble + i * 0.5) * wobbleAmt * (1 - mochi.growth * 0.5);

            // ã‚µã‚¤ã‚ºï¼ˆæ¨ªé•·ã‚’ç¶­æŒï¼‰
            const rx = w + wobbleOffset + bumpiness + irregularity;
            const ry = h + wobbleOffset * 0.3 + bumpiness * 0.3;

            const px = x + Math.cos(angle) * rx;
            const py = y + Math.sin(angle) * ry;

            if (i === 0) {
              gameCtx.moveTo(px, py);
            } else {
              const prevAngle = (i - 1) * angleStep;
              const cpAngle = prevAngle + angleStep * 0.5;
              const cpRx = w + Math.sin(cpAngle * 4) * roughness * 3;
              const cpRy = h;
              const cpx = x + Math.cos(cpAngle) * cpRx * 1.02;
              const cpy = y + Math.sin(cpAngle) * cpRy * 1.02;

              gameCtx.quadraticCurveTo(cpx, cpy, px, py);
            }
          }
          gameCtx.closePath();
        }
        gameCtx.fill();

        // é¤…ã®è¼ªéƒ­ï¼ˆè–„ã„å½±ï¼‰
        gameCtx.strokeStyle = "rgba(210, 200, 180, 0.25)";
        gameCtx.lineWidth = 2;
        gameCtx.stroke();

        // é¤…ã®è†¨ã‚‰ã¿è¡¨ç¾ï¼ˆãƒ‰ãƒ¼ãƒ çŠ¶ï¼‰
        const bulgeH = h * 0.5 * (1 + mochi.growth * 0.4);
        const bulgeGradient = gameCtx.createRadialGradient(x - w * 0.1, y - h * 0.35, 0, x, y - h * 0.2, w * 0.9);
        bulgeGradient.addColorStop(0, "rgba(255, 255, 255, 0.9)");
        bulgeGradient.addColorStop(0.5, "rgba(253, 250, 245, 0.5)");
        bulgeGradient.addColorStop(1, "rgba(248, 244, 238, 0)");

        gameCtx.fillStyle = bulgeGradient;
        gameCtx.beginPath();
        gameCtx.ellipse(x, y - h * 0.15, w * 0.8, bulgeH, 0, 0, Math.PI * 2);
        gameCtx.fill();

        // é¤…ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã¤ã‚„ã¤ã‚„æ„Ÿãƒ»å¤§ãã‚ï¼‰
        gameCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
        gameCtx.beginPath();
        gameCtx.ellipse(x - w * 0.2, y - h * 0.3, w * 0.4, h * 0.2, -0.3, 0, Math.PI * 2);
        gameCtx.fill();

        // å°ã•ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
        gameCtx.fillStyle = "rgba(255, 255, 255, 0.95)";
        gameCtx.beginPath();
        gameCtx.ellipse(x - w * 0.35, y - h * 0.35, w * 0.12, h * 0.08, 0, 0, Math.PI * 2);
        gameCtx.fill();

        // å©ã„ãŸæ™‚ã®ã¸ã“ã¿è¡¨ç¾
        if (squash > 0.1) {
          gameCtx.fillStyle = `rgba(230, 220, 200, ${squash * 0.5})`;
          gameCtx.beginPath();
          gameCtx.ellipse(x, y - h * 0.05, w * 0.35 * squash, h * 0.2 * squash, 0, 0, Math.PI * 2);
          gameCtx.fill();
        }

        // æˆé•·ã—ãŸã‚‰é¤…ãŒç››ã‚Šä¸ŠãŒã‚‹è¡¨ç¾
        if (mochi.growth > 0.25) {
          const riseAmount = (mochi.growth - 0.25) * 0.6;
          gameCtx.fillStyle = "rgba(255, 253, 250, 0.5)";
          gameCtx.beginPath();
          gameCtx.ellipse(x, y - h * 0.25, w * 0.4 * riseAmount, h * 0.35 * riseAmount, 0, 0, Math.PI * 2);
          gameCtx.fill();
        }

        gameCtx.restore();
      }

      // æµã‚’æç”»
      function drawKine() {
        // æ‰‹ã®ä½ç½®ã«ã‚¹ãƒ ãƒ¼ã‚ºã«è¿½å¾“
        smoothHandX += (handScreenX - smoothHandX) * 0.2;
        smoothHandY += (handScreenY - smoothHandY) * 0.2;

        kine.x = smoothHandX;
        kine.y = smoothHandY;

        // ãƒ’ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (kine.isHitting) {
          kine.hitProgress += 0.12;
          if (kine.hitProgress >= 1) {
            kine.isHitting = false;
            kine.hitProgress = 0;
          }
        }

        // æµã®è§’åº¦ï¼ˆæ‰‹ã®å‹•ãã«å¿œã˜ã¦ï¼‰
        const baseRotation = -25;
        const hitRotation = kine.isHitting ? Math.sin(kine.hitProgress * Math.PI) * 30 : 0;
        kine.rotation = baseRotation + hitRotation;

        gameCtx.save();
        gameCtx.translate(kine.x, kine.y);
        gameCtx.rotate((kine.rotation * Math.PI) / 180);

        // æµã®ç”»åƒãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°æç”»
        if (kineImage.complete && kineImage.naturalWidth > 0) {
          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦æç”»
          const imgWidth = kineImage.naturalWidth;
          const imgHeight = kineImage.naturalHeight;
          const aspectRatio = imgWidth / imgHeight;

          // é«˜ã•ã‚’åŸºæº–ã«ã‚µã‚¤ã‚ºã‚’æ±ºã‚ã‚‹
          const kineHeight = 300;
          const kineWidth = kineHeight * aspectRatio;

          // æµã®å…ˆç«¯ï¼ˆä¸‹å´ï¼‰ã‚’åŸºæº–ã«æç”»
          gameCtx.drawImage(
            kineImage,
            -kineWidth / 2,
            -kineHeight * 0.15, // å°‘ã—ä¸Šã«ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            kineWidth,
            kineHeight
          );
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæµã‚’æç”»
          // æµã®é ­éƒ¨åˆ†ï¼ˆæ‰“ã¤éƒ¨åˆ†ï¼‰
          const headGradient = gameCtx.createLinearGradient(-40, 0, 40, 0);
          headGradient.addColorStop(0, "#a08060");
          headGradient.addColorStop(0.3, "#d4b896");
          headGradient.addColorStop(0.7, "#d4b896");
          headGradient.addColorStop(1, "#a08060");

          gameCtx.fillStyle = headGradient;
          gameCtx.beginPath();
          gameCtx.ellipse(0, 10, 40, 30, 0, 0, Math.PI * 2);
          gameCtx.fill();

          // æµã®æŒã¡æ‰‹
          const handleGradient = gameCtx.createLinearGradient(-15, 0, 15, 0);
          handleGradient.addColorStop(0, "#8b7355");
          handleGradient.addColorStop(0.5, "#c49a6c");
          handleGradient.addColorStop(1, "#8b7355");

          gameCtx.fillStyle = handleGradient;
          gameCtx.fillRect(-15, -15, 30, -140);

          // æŒã¡æ‰‹ã®ç«¯
          gameCtx.fillStyle = "#d4a574";
          gameCtx.beginPath();
          gameCtx.ellipse(0, -155, 18, 12, 0, 0, Math.PI * 2);
          gameCtx.fill();
        }

        gameCtx.restore();
      }

      // ãŠã—ã‚‹ã“ã‚’æç”»ï¼ˆç”»åƒä½¿ç”¨ï¼‰
      function drawOshiruko(x, y) {
        if (oshirukoImage.complete && oshirukoImage.naturalWidth > 0) {
          const imgWidth = oshirukoImage.naturalWidth;
          const imgHeight = oshirukoImage.naturalHeight;
          const aspectRatio = imgWidth / imgHeight;

          const displayHeight = 300;
          const displayWidth = displayHeight * aspectRatio;

          gameCtx.drawImage(oshirukoImage, x - displayWidth / 2, y - displayHeight / 2, displayWidth, displayHeight);
        }
      }

      // ãŠé›‘ç…®ã‚’æç”»ï¼ˆç”»åƒä½¿ç”¨ï¼‰
      function drawOzoni(x, y) {
        if (zouniImage.complete && zouniImage.naturalWidth > 0) {
          const imgWidth = zouniImage.naturalWidth;
          const imgHeight = zouniImage.naturalHeight;
          const aspectRatio = imgWidth / imgHeight;

          const displayHeight = 300;
          const displayWidth = displayHeight * aspectRatio;

          gameCtx.drawImage(zouniImage, x - displayWidth / 2, y - displayHeight / 2, displayWidth, displayHeight);
        }
      }

      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
      function render() {
        gameCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        updateMochi();

        // å®Œæˆå¾Œã¯æ–™ç†ã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯é¤…ã¤ã
        if (isComplete && completeDish) {
          const dishX = window.innerWidth / 2;
          const dishY = window.innerHeight * 0.7; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹ã«è¡¨ç¤º
          if (completeDish === "oshiruko") {
            drawOshiruko(dishX, dishY);
          } else {
            drawOzoni(dishX, dishY);
          }
        } else {
          drawUsu();
          drawKine();
        }

        requestAnimationFrame(render);
      }

      // æ‰‹ã®å‹•ãã‚’æ¤œå‡º
      function detectHandMotion(landmarks) {
        const wrist = landmarks[0];
        const handY = wrist.y;
        const handX = wrist.x;

        // ç”»é¢åº§æ¨™ã«å¤‰æ›
        handScreenX = (1 - handX) * window.innerWidth;
        handScreenY = handY * window.innerHeight;

        // å±¥æ­´ã«è¿½åŠ 
        handYHistory.push({ y: handY, time: Date.now() });
        if (handYHistory.length > HISTORY_LENGTH) {
          handYHistory.shift();
        }

        // é€Ÿåº¦ã‚’è¨ˆç®—
        let velocity = 0;
        if (handYHistory.length >= 2) {
          const recent = handYHistory[handYHistory.length - 1];
          const old = handYHistory[0];
          const timeDiff = (recent.time - old.time) / 1000;
          if (timeDiff > 0) {
            velocity = (recent.y - old.y) / timeDiff;
          }
        }

        // æ‰‹ã®ä½ç½®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯ä½¿ã‚ãªã„ï¼ˆéè¡¨ç¤ºã®ã¾ã¾ï¼‰

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        debugInfo.innerHTML = `
          é€Ÿåº¦: ${velocity.toFixed(2)}<br>
          ãƒ’ãƒƒãƒˆå¯èƒ½: ${canHit ? "YES" : "NO"}
        `;

        // æŒ¯ã‚Šä¸‹ã‚ã—åˆ¤å®šï¼ˆè‡¼ã¨ã®è·é›¢ã¯æ’¤å»ƒã€ç”»é¢ã©ã“ã§ã‚‚OKï¼‰
        const VELOCITY_THRESHOLD = 1.2;

        if (velocity > VELOCITY_THRESHOLD && canHit) {
          hitMochi(velocity);
          canHit = false;
        }

        // æ‰‹ãŒä¸Šã«æˆ»ã£ãŸã‚‰å†åº¦ãƒ’ãƒƒãƒˆå¯èƒ½ã«
        if (velocity < -0.3 && !canHit) {
          canHit = true;
        }

        lastHandY = handY;
      }

      // MediaPipeåˆæœŸåŒ–
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.5,
          minHandPresenceConfidence: 0.5,
          minTrackingConfidence: 0.5,
        });
      }

      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // æ‰‹ã®éª¨æ ¼ã‚’æç”»
          canvasCtx.strokeStyle = "#ffd700";
          canvasCtx.lineWidth = 2;

          const connections = [
            [0, 1],
            [1, 2],
            [2, 3],
            [3, 4],
            [0, 5],
            [5, 6],
            [6, 7],
            [7, 8],
            [0, 9],
            [9, 10],
            [10, 11],
            [11, 12],
            [0, 13],
            [13, 14],
            [14, 15],
            [15, 16],
            [0, 17],
            [17, 18],
            [18, 19],
            [19, 20],
            [5, 9],
            [9, 13],
            [13, 17],
          ];

          connections.forEach(([start, end]) => {
            const startPoint = landmarks[start];
            const endPoint = landmarks[end];
            canvasCtx.beginPath();
            canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
            canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
            canvasCtx.stroke();
          });

          detectHandMotion(landmarks);
        }

        canvasCtx.restore();
      }

      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—: " + error.message;
        }
      }

      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
      const tutorialModal = document.getElementById("tutorial-modal");
      const startButton = document.getElementById("start-button");
      const nextButton = document.getElementById("next-button");
      const slides = document.querySelectorAll(".slide");
      const indicators = document.querySelectorAll(".slide-indicator");
      let currentSlide = 0;
      const totalSlides = slides.length;

      function goToSlide(index) {
        // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’prevã«
        slides[currentSlide].classList.remove("active");
        slides[currentSlide].classList.add("prev");
        indicators[currentSlide].classList.remove("active");

        // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’activeã«
        currentSlide = index;
        slides[currentSlide].classList.remove("prev");
        slides[currentSlide].classList.add("active");
        indicators[currentSlide].classList.add("active");

        // æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ãªã‚‰ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (currentSlide === totalSlides - 1) {
          nextButton.style.display = "none";
          startButton.style.display = "inline-block";
        }
      }

      nextButton.addEventListener("click", () => {
        if (currentSlide < totalSlides - 1) {
          goToSlide(currentSlide + 1);
        }
      });

      startButton.addEventListener("click", () => {
        tutorialModal.classList.add("hidden");
        loading.classList.remove("hidden");
        startCamera();
      });

      // åˆæœŸåŒ–
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      render();
    </script>
  </body>
</html>
