<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é¡”ãƒ‘ãƒ¼ãƒ„åˆ†å‰²ãƒ‡ãƒ¢</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 20px;
      }

      .main-area {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      #video-container {
        position: relative;
        width: 640px;
        height: 480px;
        border: 3px solid white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        background: #000;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      .parts-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        flex: 1;
        min-width: 300px;
      }

      .parts-panel h2 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .parts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .part-item {
        text-align: center;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 10px;
      }

      .part-item h3 {
        font-size: 14px;
        color: #333;
        margin-bottom: 8px;
      }

      .part-item canvas {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        max-width: 100%;
      }

      #capture-btn {
        display: block;
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      #capture-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      #status {
        margin-top: 15px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        color: #666;
      }

      #status.active {
        background: #d4edda;
        color: #155724;
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 10000;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .download-links {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }

      .download-links a {
        padding: 8px 12px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 12px;
      }

      .download-links a:hover {
        background: #764ba2;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p>ã‚«ãƒ¡ãƒ©ã¨MediaPipeã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div class="container">
      <h1>ğŸ­ é¡”ãƒ‘ãƒ¼ãƒ„åˆ†å‰²ãƒ‡ãƒ¢</h1>

      <div class="main-area">
        <div id="video-container">
          <video id="input_video" autoplay playsinline></video>
          <canvas id="output_canvas"></canvas>
        </div>

        <div class="parts-panel">
          <h2>ğŸ“· æ¤œå‡ºã•ã‚ŒãŸãƒ‘ãƒ¼ãƒ„</h2>
          <div class="parts-grid">
            <div class="part-item">
              <h3>ğŸ‘ å·¦ç›®</h3>
              <canvas id="left-eye" width="120" height="60"></canvas>
            </div>
            <div class="part-item">
              <h3>ğŸ‘ å³ç›®</h3>
              <canvas id="right-eye" width="120" height="60"></canvas>
            </div>
            <div class="part-item">
              <h3>ğŸ‘ƒ é¼»</h3>
              <canvas id="nose" width="100" height="100"></canvas>
            </div>
            <div class="part-item">
              <h3>ğŸ‘„ å£</h3>
              <canvas id="mouth" width="120" height="60"></canvas>
            </div>
            <div class="part-item">
              <h3>ğŸ¤¨ å·¦çœ‰</h3>
              <canvas id="left-eyebrow" width="120" height="40"></canvas>
            </div>
            <div class="part-item">
              <h3>ğŸ¤¨ å³çœ‰</h3>
              <canvas id="right-eyebrow" width="120" height="40"></canvas>
            </div>
          </div>

          <button id="capture-btn">ğŸ“¸ ãƒ‘ãƒ¼ãƒ„ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ä¿å­˜</button>
          <div id="download-links" class="download-links"></div>
          <div id="status">å¾…æ©Ÿä¸­...</div>
        </div>
      </div>
    </div>

    <script type="module">
      import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const status = document.getElementById("status");
      const loading = document.getElementById("loading");
      const captureBtn = document.getElementById("capture-btn");
      const downloadLinks = document.getElementById("download-links");

      // ãƒ‘ãƒ¼ãƒ„ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹
      const partCanvases = {
        leftEye: document.getElementById("left-eye"),
        rightEye: document.getElementById("right-eye"),
        nose: document.getElementById("nose"),
        mouth: document.getElementById("mouth"),
        leftEyebrow: document.getElementById("left-eyebrow"),
        rightEyebrow: document.getElementById("right-eyebrow"),
      };

      let faceLandmarker = null;
      let lastVideoTime = -1;
      let currentLandmarks = null;

      // FaceMeshã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      const FACE_PARTS = {
        leftEye: [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246],
        rightEye: [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398],
        nose: [1, 2, 98, 327, 168, 6, 197, 195, 5, 4, 19, 94, 370],
        mouth: [61, 146, 91, 181, 84, 17, 314, 405, 321, 375, 291, 308, 324, 318, 402, 317, 14, 87, 178, 88, 95],
        leftEyebrow: [70, 63, 105, 66, 107, 55, 65, 52, 53, 46],
        rightEyebrow: [300, 293, 334, 296, 336, 285, 295, 282, 283, 276],
      };

      // MediaPipe Face Landmarkerã®åˆæœŸåŒ–
      async function initializeFaceLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numFaces: 1,
          minFaceDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5,
        });

        console.log("Face LandmarkeråˆæœŸåŒ–å®Œäº†");
      }

      // ãƒ‘ãƒ¼ãƒ„ã®ç¯„å›²ã‚’è¨ˆç®—
      function getPartBounds(landmarks, indices, padding = 10) {
        const points = indices.map((i) => landmarks[i]);
        const xs = points.map((p) => p.x * videoElement.videoWidth);
        const ys = points.map((p) => p.y * videoElement.videoHeight);

        return {
          minX: Math.max(0, Math.min(...xs) - padding),
          maxX: Math.min(videoElement.videoWidth, Math.max(...xs) + padding),
          minY: Math.max(0, Math.min(...ys) - padding),
          maxY: Math.min(videoElement.videoHeight, Math.max(...ys) + padding),
        };
      }

      // ãƒ‘ãƒ¼ãƒ„ã‚’åˆ‡ã‚Šå‡ºã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
      function extractPart(landmarks, partName, indices) {
        const canvas = partCanvases[partName];
        const ctx = canvas.getContext("2d");
        const bounds = getPartBounds(landmarks, indices);

        const width = bounds.maxX - bounds.minX;
        const height = bounds.maxY - bounds.minY;

        // ãƒŸãƒ©ãƒ¼åè»¢ã‚’è€ƒæ…®ã—ã¦åˆ‡ã‚Šå‡ºã—
        const mirroredX = videoElement.videoWidth - bounds.maxX;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(
          videoElement,
          mirroredX, bounds.minY, width, height,
          0, 0, canvas.width, canvas.height
        );
      }

      // é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’å‡¦ç†
      function processFaceLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.faceLandmarks && results.faceLandmarks.length > 0) {
          const landmarks = results.faceLandmarks[0];
          currentLandmarks = landmarks;

          // é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
          canvasCtx.fillStyle = "#00ff00";
          landmarks.forEach((landmark) => {
            const x = landmark.x * canvasElement.width;
            const y = landmark.y * canvasElement.height;
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 1, 0, 2 * Math.PI);
            canvasCtx.fill();
          });

          // å„ãƒ‘ãƒ¼ãƒ„ã‚’å¼·èª¿è¡¨ç¤º
          Object.entries(FACE_PARTS).forEach(([partName, indices]) => {
            const color = getPartColor(partName);
            canvasCtx.strokeStyle = color;
            canvasCtx.lineWidth = 2;

            canvasCtx.beginPath();
            indices.forEach((index, i) => {
              const x = landmarks[index].x * canvasElement.width;
              const y = landmarks[index].y * canvasElement.height;
              if (i === 0) {
                canvasCtx.moveTo(x, y);
              } else {
                canvasCtx.lineTo(x, y);
              }
            });
            canvasCtx.closePath();
            canvasCtx.stroke();

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‘ãƒ¼ãƒ„ã‚’åˆ‡ã‚Šå‡ºã—
            extractPart(landmarks, partName, indices);
          });

          status.textContent = "é¡”ã‚’æ¤œå‡ºä¸­ âœ“";
          status.classList.add("active");
        } else {
          currentLandmarks = null;
          status.textContent = "é¡”ãŒè¦‹ãˆã¾ã›ã‚“...";
          status.classList.remove("active");
        }

        canvasCtx.restore();
      }

      // ãƒ‘ãƒ¼ãƒ„ã”ã¨ã®è‰²
      function getPartColor(partName) {
        const colors = {
          leftEye: "#ff6b6b",
          rightEye: "#ff6b6b",
          nose: "#4ecdc4",
          mouth: "#ffe66d",
          leftEyebrow: "#95e1d3",
          rightEyebrow: "#95e1d3",
        };
        return colors[partName] || "#ffffff";
      }

      // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ä¿å­˜
      captureBtn.addEventListener("click", () => {
        if (!currentLandmarks) {
          alert("é¡”ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return;
        }

        downloadLinks.innerHTML = "";

        Object.entries(partCanvases).forEach(([partName, canvas]) => {
          const link = document.createElement("a");
          link.href = canvas.toDataURL("image/png");
          link.download = `${partName}.png`;
          link.textContent = partName;
          downloadLinks.appendChild(link);
        });

        status.textContent = "ã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†ï¼ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜";
      });

      // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
      async function startCamera() {
        await initializeFaceLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            console.log("ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†");

            function onFrame() {
              if (!faceLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = faceLandmarker.detectForVideo(videoElement, startTimeMs);
                processFaceLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", error);
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—: " + error.message;
        }
      }

      startCamera();
    </script>
  </body>
</html>
