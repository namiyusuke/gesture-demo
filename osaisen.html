<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãŠè³½éŠ­ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ - ä¸¦æ²³ç¨²è·</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Zen Kaku Gothic New", "Arial", sans-serif;
        font-weight: 700;
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      /* èƒŒæ™¯ç”»åƒ */
      #background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url("osaisen-images/osaisen-bg.jpg") center center / cover no-repeat;
        z-index: -2;
      }

      #video-container {
        position: fixed;
        top: 100px;
        right: 20px;
        width: 240px;
        height: 180px;
        border: 3px solid #ffd700;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        background: #000;
        z-index: 1000;
        display: none;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
        opacity: 0;
        visibility: hidden;
      }

      /* ç¥ç¤¾ã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
      #shrine-area {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: calc(100% - 80px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }

      /* é³¥å±…ç”»åƒ */
      #torii-image {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 100%;
        max-width: 900px;
        z-index: 5;
      }

      /* è³½éŠ­ç®±ã‚¨ãƒªã‚¢ */
      #saisenbox-area {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        transition: transform 0.3s ease;
      }

      #saisenbox-image {
        width: 250px;
        transition: transform 0.5s ease;
      }

      /* çŠ¬ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
      #dog-character {
        position: absolute;
        bottom: 100px;
        left: calc(50% - 280px);
        width: 140px;
        height: auto;
        z-index: 25;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #dog-character.active {
        opacity: 1;
      }

      #dog-character.blocking {
        animation: dogRun 2.5s ease-in-out forwards;
      }

      @keyframes dogRun {
        0% {
          transform: translateX(0) translateY(0) scaleX(1);
        }
        10% {
          transform: translateX(40px) translateY(-8px) scaleX(1);
        }
        20% {
          transform: translateX(90px) translateY(0) scaleX(1);
        }
        30% {
          transform: translateX(150px) translateY(-8px) scaleX(1);
        }
        40% {
          transform: translateX(210px) translateY(0) scaleX(1);
        }
        50% {
          transform: translateX(280px) translateY(-5px) scaleX(1);
        }
        60% {
          transform: translateX(350px) translateY(0) scaleX(1);
        }
        70% {
          transform: translateX(400px) translateY(-8px) scaleX(1);
        }
        80% {
          transform: translateX(460px) translateY(0) scaleX(1);
        }
        90% {
          transform: translateX(510px) translateY(-5px) scaleX(1);
        }
        100% {
          transform: translateX(560px) translateY(0) scaleX(1);
        }
      }

      /* çŒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆé‚ªé­”å½¹ï¼‰ */
      #cat-character {
        position: absolute;
        bottom: 80px;
        left: calc(50% + 60px);
        width: 120px;
        height: auto;
        z-index: 30;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: all 0.3s ease;
        transform: translateY(50px);
      }

      #cat-character.active {
        opacity: 1;
        transform: translateY(0);
      }

      #cat-character.blocking {
        animation: catBlock 0.3s ease-in-out infinite;
      }

      @keyframes catBlock {
        0%,
        100% {
          transform: translateX(0) rotate(0deg) scale(1);
        }
        25% {
          transform: translateX(-50px) rotate(-15deg) scale(1.1);
        }
        50% {
          transform: translateX(0) rotate(0deg) scale(1.2);
        }
        75% {
          transform: translateX(50px) rotate(15deg) scale(1.1);
        }
      }

      /* éˆ´ */
      #bell {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 60px;
        z-index: 15;
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        transition: transform 0.1s;
      }

      #bell.ringing {
        animation: ring 0.5s ease-in-out;
      }

      @keyframes ring {
        0%,
        100% {
          transform: translateX(-50%) rotate(0deg);
        }
        20% {
          transform: translateX(-50%) rotate(20deg);
        }
        40% {
          transform: translateX(-50%) rotate(-20deg);
        }
        60% {
          transform: translateX(-50%) rotate(15deg);
        }
        80% {
          transform: translateX(-50%) rotate(-15deg);
        }
      }

      /* æ‰‹ã®ä½ç½®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
      #hand-indicator {
        position: fixed;
        width: 60px;
        height: 60px;
        font-size: 50px;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        transition: transform 0.05s;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      /* å°éŠ­ */
      .coin {
        position: fixed;
        font-size: 40px;
        pointer-events: none;
        z-index: 500;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
      }

      /* æˆåŠŸæ™‚ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
      #success-light {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle at 50% 70%,
          rgba(255, 215, 0, 0.9) 0%,
          rgba(255, 140, 0, 0.5) 30%,
          transparent 60%
        );
        opacity: 0;
        pointer-events: none;
        z-index: 100;
        transition: opacity 0.3s;
      }

      #success-light.active {
        animation: lightBurst 1.5s ease-out;
      }

      @keyframes lightBurst {
        0% {
          opacity: 0;
          background: radial-gradient(
            circle at 50% 70%,
            rgba(255, 255, 255, 1) 0%,
            rgba(255, 215, 0, 0.9) 20%,
            transparent 50%
          );
        }
        10% {
          opacity: 1;
          background: radial-gradient(
            circle at 50% 70%,
            rgba(255, 255, 255, 1) 0%,
            rgba(255, 215, 0, 0.9) 30%,
            transparent 60%
          );
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 0;
        }
      }

      /* ç´™å¹é›ª */
      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        pointer-events: none;
        z-index: 1600;
        animation: confettiFall 3s ease-out forwards;
      }

      @keyframes confettiFall {
        0% {
          opacity: 1;
          transform: translateY(0) rotate(0deg) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(400px) rotate(720deg) scale(0.5);
        }
      }

      /* æ”¾å°„çŠ¶å…‰ç·š */
      .light-ray {
        position: fixed;
        width: 4px;
        height: 150px;
        background: linear-gradient(to top, rgba(255, 215, 0, 0.8), transparent);
        pointer-events: none;
        z-index: 90;
        transform-origin: bottom center;
        animation: rayBurst 1s ease-out forwards;
      }

      @keyframes rayBurst {
        0% {
          opacity: 1;
          transform: scaleY(0);
        }
        30% {
          opacity: 1;
          transform: scaleY(1);
        }
        100% {
          opacity: 0;
          transform: scaleY(1.5);
        }
      }

      /* åºƒãŒã‚‹ãƒªãƒ³ã‚° */
      .success-ring {
        position: fixed;
        border: 4px solid rgba(255, 215, 0, 0.8);
        border-radius: 50%;
        pointer-events: none;
        z-index: 95;
        animation: ringExpand 1s ease-out forwards;
      }

      @keyframes ringExpand {
        0% {
          width: 20px;
          height: 20px;
          opacity: 1;
        }
        100% {
          width: 400px;
          height: 400px;
          opacity: 0;
        }
      }

      /* èŠ±ç«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
      .firework {
        position: fixed;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 1550;
        animation: fireworkBurst 1.2s ease-out forwards;
      }

      @keyframes fireworkBurst {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(1);
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate(var(--fx), var(--fy)) scale(0.3);
        }
      }

      /* å…‰ã®ç²’å­ */
      .light-particle {
        position: fixed;
        width: 10px;
        height: 10px;
        background: radial-gradient(circle, #fff 0%, #ffd700 50%, transparent 100%);
        border-radius: 50%;
        pointer-events: none;
        z-index: 150;
        animation: particleRise 2s ease-out forwards;
      }

      @keyframes particleRise {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-200px) scale(0);
        }
      }

      /* ãŠã¿ãã˜ */
      #omikuji-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #omikuji-overlay.show {
        display: flex;
        opacity: 1;
      }

      #omikuji-paper {
        width: 80%;
        max-width: 500px;
        border-radius: 12px;
        text-align: center;
        transform: scale(0) rotate(-10deg);
        display: flex;
        flex-direction: column;
        align-items: center;
        column-gap: 20px;
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      #result-image {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      #omikuji-overlay.show #omikuji-paper {
        transform: scale(1) rotate(0deg);
      }

      /* å¤±æ•—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      #fail-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20000;
      }

      #fail-overlay.show {
        display: flex;
      }

      #fail-paper {
        background: #fff;
        border-radius: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        color: #000;
        padding: 85px 40px;
        position: relative;
        overflow: hidden;
        transform: scale(0) rotate(-10deg);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      #fail-overlay.show #fail-paper {
        transform: scale(1) rotate(0deg);
      }

      #fail-title {
        font-size: 36px;
        font-weight: bold;
        color: #000;
        margin-bottom: 30px;
      }

      #fail-reason {
        font-size: 48px;
        font-weight: 900;
        color: #000;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      #close-fail {
        padding: 15px 40px;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        background-color: #e7141b;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        margin-top: 50px;
      }

      #close-fail:active {
        transform: scale(0.98);
      }

      #omikuji-result {
        font-size: 72px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      #omikuji-message {
        font-size: 16px;
        color: #333;
        line-height: 1.8;
        white-space: pre-line;
      }

      #close-omikuji {
        margin-top: 30px;
        padding: 12px 35px;
        font-size: 16px;
        background: #c41e3a;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      #close-omikuji:hover {
        background: #a01830;
        transform: scale(1.05);
      }

      /* èª¬æ˜ãƒ‘ãƒãƒ« */
      #info {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        border-radius: 20px;
        z-index: 1000;
      }

      .info-icon {
        font-size: 40px;
        margin-right: 6px;
      }

      #info h1 {
        font-size: 17px;
        color: #000;
        margin-bottom: 10px;
        font-weight: bold;
      }
      #coin-count {
        font-size: 24px;
        color: #e7141b;
        font-weight: 900;
      }
      .info-remaining {
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 16px;
      }

      #status {
        margin-top: 12px;
        padding: 8px 12px;
        background: #f0f0f0;
        border-radius: 6px;
        font-weight: bold;
        color: #666;
        text-align: center;
        font-size: 14px;
      }

      #status.active {
        background: #d4edda;
        color: #155724;
      }

      #status.throwing {
        background: #fff3cd;
        color: #856404;
      }

      #status.blocked {
        background: #f8d7da;
        color: #721c24;
      }

      /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
      #score-display {
        display: none;
      }

      /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 10000;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #c41e3a;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
      .particle {
        position: fixed;
        pointer-events: none;
        border-radius: 50%;
        animation: particleBurst 1s ease-out forwards;
        z-index: 1500;
      }

      @keyframes particleBurst {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(var(--tx), var(--ty)) scale(0);
        }
      }

      /* å¤±æ•—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
      .miss-effect {
        position: fixed;
        font-size: 28px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        z-index: 1500;
        white-space: nowrap;
        transform: translate(-50%, -50%);
        animation: missAnim 2s ease-out forwards;
      }

      @keyframes missAnim {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(0.5);
        }
        20% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.2);
        }
        40% {
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100%) scale(1);
        }
      }

      /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« */
      #tutorial-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 20000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #tutorial-modal.hidden {
        display: none;
      }

      .tutorial-content {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        color: white;
        border: #fff solid 1px;
      }

      .tutorial-content h1 {
        font-size: 32px;
        color: #fff;
        margin-bottom: 30px;
      }

      .slides-container {
        position: relative;
        width: 100%;
        height: 320px;
        overflow: hidden;
      }

      .slide {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.5s ease,
          transform 0.5s ease;
      }

      .slide.active {
        opacity: 1;
        transform: translateX(0);
      }

      .slide.prev {
        opacity: 0;
        transform: translateX(-100%);
      }

      .slide-subtitle {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .slide .icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .slide-description {
        font-size: 18px;
        line-height: 1.8;
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
      }

      .slide-note {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 15px;
      }

      .slide-indicators {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 25px 0;
      }

      .slide-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition:
          background 0.3s,
          transform 0.3s;
      }

      .slide-indicator.active {
        background: #ffd700;
        transform: scale(1.2);
      }

      .tutorial-button {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        color: #2a1a0a;
        background: #fff;
        border: none;
        border-radius: 2px;
        cursor: pointer;
      }

      .tutorial-button:active {
        transform: scale(0.98);
      }
      .info {
        padding-top: 46px;
        padding-bottom: 120px;
        padding-inline: 42px;
        text-align: center;
      }
      .info-ttl {
        color: #000;
        font-size: 24px;
      }
      .info-text {
        color: #000;
      }
      .info-dog-character {
        position: absolute;
        bottom: 10px;
        left: 10px;
        width: 80px;
        height: auto;
      }
      .info-cat-character {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 80px;
        height: auto;
      }
    </style>
  </head>
  <body>
    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tutorial-modal">
      <div class="tutorial-content">
        <h1>ãŠè³½éŠ­ã‚²ãƒ¼ãƒ </h1>
        <div class="slides-container">
          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰1: æ‰‹ã‚’ä¸Šã’ã‚‹ -->
          <div class="slide active" data-slide="0">
            <div class="slide-subtitle">æ‰‹ã‚’ä¸Šã’ã¦æº–å‚™</div>
            <div class="icon">ğŸ–ï¸</div>
            <div class="slide-description">ç”»é¢ã«å‘ã‹ã£ã¦<br />æ‰‹ã‚’ä¸Šã«ä¸Šã’ã¦ãã ã•ã„</div>
          </div>

          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰2: æŒ¯ã‚Šä¸‹ã‚ã—ã¦æŠ•ã’ã‚‹ -->
          <div class="slide" data-slide="1">
            <div class="slide-subtitle">æŒ¯ã‚Šä¸‹ã‚ã—ã¦æŠ•ã’ã‚‹</div>
            <div class="icon">ğŸ’¨</div>
            <div class="slide-description">å‹¢ã„ã‚ˆãæ‰‹ã‚’æŒ¯ã‚Šä¸‹ã‚ã™ã¨<br />ãŠè³½éŠ­ãŒé£›ã‚“ã§ã„ãã¾ã™</div>
            <div class="slide-note">å¼·ã•ã¨æ–¹å‘ã§ã‚³ã‚¤ãƒ³ã®è»Œé“ãŒå¤‰ã‚ã‚Šã¾ã™</div>
          </div>

          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰3: è³½éŠ­ç®±ã‚’ç‹™ãŠã† -->
          <div class="slide" data-slide="2">
            <div class="slide-subtitle">è³½éŠ­ç®±ã‚’ç‹™ãŠã†ï¼</div>
            <div class="icon">ğŸ</div>
            <div class="slide-description">ã†ã¾ãå…¥ã‚Œã°çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br />çŒ«ã‚„çŠ¬ã«é‚ªé­”ã•ã‚Œã‚‹ã“ã¨ã‚‚...!?</div>
          </div>
        </div>
        <div class="slide-indicators">
          <div class="slide-indicator active" data-slide="0"></div>
          <div class="slide-indicator" data-slide="1"></div>
          <div class="slide-indicator" data-slide="2"></div>
        </div>
        <button id="next-button" class="tutorial-button">æ¬¡ã¸</button>
        <button id="start-button" class="tutorial-button" style="display: none">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div id="loading" class="hidden">
      <div class="spinner"></div>
      <p>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</p>
    </div>

    <div id="background"></div>
    <div id="success-light"></div>

    <div id="container">
      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ‘ãƒãƒ« -->
      <div id="info" class="info">
        <h1 class="info-ttl">ãŠè³½éŠ­ã‚’æŠ•ã’å…¥ã‚Œã‚ï¼</h1>
        <p class="info-text">çŠ¬ã‚„çŒ«ãŒé‚ªé­”ã—ã¾ã™</p>
        <img class="info-dog-character" src="osaisen-images/dog.png" alt="çŠ¬" />
        <img class="info-cat-character" src="osaisen-images/cat.png" alt="çŒ«" />
      </div>

      <div id="hand-indicator">âœ‹</div>

      <div id="shrine-area">
        <img id="torii-image" src="osaisen-images/tobira.png" alt="é³¥å±…" />
        <div id="saisenbox-area">
          <img id="saisenbox-image" src="osaisen-images/box.png" alt="è³½éŠ­ç®±" />
        </div>

        <img id="dog-character" src="osaisen-images/dog.png" alt="çŠ¬" />
        <img id="cat-character" src="osaisen-images/cat.png" alt="çŒ«" />
      </div>
    </div>

    <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="omikuji-overlay">
      <div id="omikuji-paper">
        <img id="result-image" src="" alt="çµæœ" />
        <button id="close-omikuji">ã‚‚ã†ä¸€åº¦æŠ•ã’ã‚‹</button>
      </div>
    </div>

    <!-- å¤±æ•—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="fail-overlay">
      <div id="fail-paper">
        <div id="fail-title">æ®‹å¿µï¼</div>
        <div id="fail-reason"></div>
        <button id="close-fail">ã‚‚ã†ä¸€åº¦æŠ•ã’ã‚‹</button>
      </div>
    </div>

    <!-- éŸ³å£°ç”Ÿæˆ -->
    <script>
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBellSound() {
        const oscillator1 = audioCtx.createOscillator();
        const oscillator2 = audioCtx.createOscillator();
        const oscillator3 = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator1.type = "sine";
        oscillator1.frequency.setValueAtTime(2500, audioCtx.currentTime);
        oscillator1.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.8);

        oscillator2.type = "sine";
        oscillator2.frequency.setValueAtTime(3500, audioCtx.currentTime);
        oscillator2.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.8);

        oscillator3.type = "triangle";
        oscillator3.frequency.setValueAtTime(1800, audioCtx.currentTime);
        oscillator3.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.6);

        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);

        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        oscillator3.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator1.start();
        oscillator2.start();
        oscillator3.start();
        oscillator1.stop(audioCtx.currentTime + 1.2);
        oscillator2.stop(audioCtx.currentTime + 1.2);
        oscillator3.stop(audioCtx.currentTime + 1.2);
      }

      function playCoinSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sine";
        oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);

        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
      }

      function playMeowSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sawtooth";
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
        oscillator.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.4);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
      }

      function playMissSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
      }
    </script>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const handIndicator = document.getElementById("hand-indicator");
      const status = document.getElementById("status");
      const loading = document.getElementById("loading");
      const bell = document.getElementById("bell");
      const saisenboxArea = document.getElementById("saisenbox-area");
      const omikujiOverlay = document.getElementById("omikuji-overlay");
      const resultImage = document.getElementById("result-image");
      const closeOmikuji = document.getElementById("close-omikuji");
      const failOverlay = document.getElementById("fail-overlay");
      const failReason = document.getElementById("fail-reason");
      const closeFail = document.getElementById("close-fail");
      const successLight = document.getElementById("success-light");
      const catCharacter = document.getElementById("cat-character");
      const dogCharacter = document.getElementById("dog-character");
      const scoreElement = document.getElementById("score");

      let handLandmarker = null;
      let lastVideoTime = -1;

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
      let handYHistory = [];
      let handXHistory = [];
      const historyLength = 10;
      let canThrow = true;
      let throwCooldown = false;
      let score = 0;
      let throwCount = 0;

      // çŒ«ã®é‚ªé­”æ©Ÿèƒ½
      let catActive = false;
      let catBlockingActive = false;

      // çŠ¬ã®é‚ªé­”æ©Ÿèƒ½
      let dogActive = false;
      let dogBlockingActive = false;

      // é‚ªé­”ã‚­ãƒ£ãƒ©ã®å‡ºç¾é »åº¦ï¼ˆã‹ãªã‚Šé«˜ã‚ï¼‰
      let interferenceChance = 0.7;

      // çµæœç”»åƒï¼ˆ10æšï¼‰
      const resultImages = [
        "osaisen-images/result01.jpg",
        "osaisen-images/result02.jpg",
        "osaisen-images/result03.jpg",
        "osaisen-images/result04.jpg",
        "osaisen-images/result05.jpg",
        "osaisen-images/result06.jpg",
        "osaisen-images/result07.jpg",
        "osaisen-images/result08.jpg",
        "osaisen-images/result09.jpg",
        "osaisen-images/result10.jpg",
      ];

      // ã‚³ã‚¤ãƒ³ã‚’æ¨ªå–ã‚Šã™ã‚‹å‹•ç‰©ã®æƒ…å ±
      let interceptor = null; // { type: 'cat' | 'dog', timing: number, x: number, y: number }

      // çŒ«ãŒã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦ã‚³ã‚¤ãƒ³ã‚’å–ã‚‹
      function catIntercept(targetX, targetY, callback) {
        catActive = true;

        // çŒ«ã®é–‹å§‹ä½ç½®ï¼ˆå·¦å³ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
        const fromLeft = Math.random() < 0.5;
        const startX = fromLeft ? targetX - 150 : targetX + 150;

        catCharacter.style.left = `${startX}px`;
        catCharacter.style.bottom = "auto";
        catCharacter.style.top = `${targetY + 50}px`;
        catCharacter.style.transform = fromLeft ? "scaleX(1)" : "scaleX(-1)";

        catCharacter.classList.add("active");

        // ã‚¸ãƒ£ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
          catCharacter.style.transition = "all 0.3s ease-out";
          catCharacter.style.left = `${targetX - 60}px`;
          catCharacter.style.top = `${targetY - 30}px`;
          catBlockingActive = true;
        }, 50);

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚³ã‚¤ãƒ³ã‚’å–ã£ãŸï¼‰
        setTimeout(() => {
          callback();
        }, 300);

        // çŒ«ãŒå»ã‚‹
        setTimeout(() => {
          catCharacter.style.transition = "all 0.4s ease-in";
          catCharacter.style.top = `${targetY + 200}px`;
          catCharacter.style.opacity = "0";
        }, 600);

        setTimeout(() => {
          catCharacter.classList.remove("active");
          catCharacter.style.transition = "";
          catCharacter.style.opacity = "";
          catCharacter.style.transform = "";
          catActive = false;
          catBlockingActive = false;
        }, 1000);
      }

      // çŠ¬ãŒã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦ã‚³ã‚¤ãƒ³ã‚’å–ã‚‹
      function dogIntercept(targetX, targetY, callback) {
        dogActive = true;

        // çŠ¬ã®é–‹å§‹ä½ç½®ï¼ˆå·¦å³ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
        const fromLeft = Math.random() < 0.5;
        const startX = fromLeft ? targetX - 150 : targetX + 150;

        dogCharacter.style.left = `${startX}px`;
        dogCharacter.style.bottom = "auto";
        dogCharacter.style.top = `${targetY + 50}px`;
        dogCharacter.style.transform = fromLeft ? "scaleX(1)" : "scaleX(-1)";

        dogCharacter.classList.add("active");

        // ã‚¸ãƒ£ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
          dogCharacter.style.transition = "all 0.3s ease-out";
          dogCharacter.style.left = `${targetX - 70}px`;
          dogCharacter.style.top = `${targetY - 30}px`;
          dogBlockingActive = true;
        }, 50);

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚³ã‚¤ãƒ³ã‚’å–ã£ãŸï¼‰
        setTimeout(() => {
          callback();
        }, 300);

        // çŠ¬ãŒå»ã‚‹
        setTimeout(() => {
          dogCharacter.style.transition = "all 0.4s ease-in";
          dogCharacter.style.top = `${targetY + 200}px`;
          dogCharacter.style.opacity = "0";
        }, 600);

        setTimeout(() => {
          dogCharacter.classList.remove("active");
          dogCharacter.style.transition = "";
          dogCharacter.style.opacity = "";
          dogCharacter.style.transform = "";
          dogActive = false;
          dogBlockingActive = false;
        }, 1000);
      }

      // ãŠã¿ãã˜ã‚’é–‰ã˜ã‚‹
      closeOmikuji.addEventListener("click", () => {
        omikujiOverlay.classList.remove("show");
        canThrow = true;
      });

      // å¤±æ•—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      closeFail.addEventListener("click", () => {
        failOverlay.classList.remove("show");
        canThrow = true;
        throwCooldown = false;
      });

      // MediaPipeåˆæœŸåŒ–
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.7,
          minHandPresenceConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });

        console.log("Hand LandmarkeråˆæœŸåŒ–å®Œäº†");
      }

      // æˆåŠŸæ™‚ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆè¯ã‚„ã‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
      function triggerSuccessEffect(x, y) {
        // å…‰ã®ãƒãƒ¼ã‚¹ãƒˆ
        successLight.classList.add("active");
        setTimeout(() => successLight.classList.remove("active"), 1500);

        // æ”¾å°„çŠ¶ã®å…‰ç·šã‚’ç”Ÿæˆ
        for (let i = 0; i < 12; i++) {
          const ray = document.createElement("div");
          ray.className = "light-ray";
          ray.style.left = `${x}px`;
          ray.style.top = `${y}px`;
          ray.style.transform = `rotate(${i * 30}deg)`;
          document.body.appendChild(ray);
          setTimeout(() => ray.remove(), 1000);
        }

        // åºƒãŒã‚‹ãƒªãƒ³ã‚°ã‚’è¤‡æ•°ç”Ÿæˆ
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const ring = document.createElement("div");
            ring.className = "success-ring";
            ring.style.left = `${x - 10}px`;
            ring.style.top = `${y - 10}px`;
            document.body.appendChild(ring);
            setTimeout(() => ring.remove(), 1000);
          }, i * 200);
        }

        // èŠ±ç«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆè¤‡æ•°å›çˆ†ç™ºï¼‰
        const fireworkColors = ["#ffd700", "#ff6347", "#ff69b4", "#00ff7f", "#00bfff", "#ff8c00"];
        for (let burst = 0; burst < 3; burst++) {
          setTimeout(() => {
            for (let i = 0; i < 20; i++) {
              const fw = document.createElement("div");
              fw.className = "firework";
              const angle = (i / 20) * Math.PI * 2;
              const distance = 80 + Math.random() * 80;
              fw.style.setProperty("--fx", `${Math.cos(angle) * distance}px`);
              fw.style.setProperty("--fy", `${Math.sin(angle) * distance}px`);
              fw.style.left = `${x}px`;
              fw.style.top = `${y}px`;
              fw.style.background = fireworkColors[Math.floor(Math.random() * fireworkColors.length)];
              fw.style.boxShadow = `0 0 6px ${fw.style.background}`;
              document.body.appendChild(fw);
              setTimeout(() => fw.remove(), 1200);
            }
          }, burst * 300);
        }

        // ç´™å¹é›ª
        const confettiColors = ["#ffd700", "#ff6b6b", "#4ecdc4", "#ffe66d", "#95e1d3", "#f38181"];
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = `${x + (Math.random() - 0.5) * 300}px`;
            confetti.style.top = `${y - 100 + Math.random() * 50}px`;
            confetti.style.background = confettiColors[Math.floor(Math.random() * confettiColors.length)];
            confetti.style.width = `${8 + Math.random() * 8}px`;
            confetti.style.height = `${8 + Math.random() * 8}px`;
            confetti.style.borderRadius = Math.random() > 0.5 ? "50%" : "2px";
            confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
          }, i * 30);
        }

        // å…‰ã®ç²’å­ã‚’ç”Ÿæˆï¼ˆå…ƒã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ–ï¼‰
        for (let i = 0; i < 30; i++) {
          setTimeout(() => {
            const particle = document.createElement("div");
            particle.className = "light-particle";
            particle.style.left = `${x + (Math.random() - 0.5) * 250}px`;
            particle.style.top = `${y + Math.random() * 50}px`;
            particle.style.width = `${8 + Math.random() * 12}px`;
            particle.style.height = particle.style.width;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
          }, i * 40);
        }
      }

      // å°éŠ­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¼·ã•ã¨æ–¹å‘ã«å¯¾å¿œï¼‰
      // power: 0.5ã€œ1.5ï¼ˆå¼±ã€œå¼·ï¼‰
      // direction: -1ã€œ+1ï¼ˆå·¦ã€œå³ï¼‰
      function throwCoin(startX, startY, power = 1, direction = 0) {
        throwCount++;

        const coin = document.createElement("div");
        coin.className = "coin";
        coin.textContent = "ğŸª™";
        coin.style.left = `${startX}px`;
        coin.style.top = `${startY}px`;
        document.body.appendChild(coin);

        // è³½éŠ­ç®±ã®ä½ç½®
        const boxRect = saisenboxArea.getBoundingClientRect();
        const boxCenterX = boxRect.left + boxRect.width / 2;
        const boxCenterY = boxRect.top + 30;

        // å¼·ã•ã«å¿œã˜ãŸå¼§ã®é«˜ã•
        const arcHeight = 80 + power * 100;

        // å¼·ã•ã«å¿œã˜ãŸé£›è·é›¢
        const distanceMultiplier = 0.5 + power * 0.5;

        // æ–¹å‘ã«å¿œã˜ãŸæ¨ªãšã‚Œ
        const horizontalOffset = direction * 120;

        // æœ€çµ‚ç€åœ°ç‚¹ã‚’è¨ˆç®—
        const finalLandX = boxCenterX + horizontalOffset;
        const finalLandY = boxCenterY + (1 - distanceMultiplier) * 150;

        // å½“ãŸã‚Šåˆ¤å®š
        const hitBoxLeft = boxRect.left + 30;
        const hitBoxRight = boxRect.right - 30;
        const isOnTargetX = finalLandX >= hitBoxLeft - 30 && finalLandX <= hitBoxRight + 30;
        const isOnTargetY = power >= 0.6 && power <= 1.4;
        const isOnTarget = isOnTargetX && isOnTargetY;

        // å¤±æ•—ç†ç”±
        let missReason = "";
        if (!isOnTargetX) {
          missReason = direction > 0 ? "å³ã«ãšã‚ŒãŸï¼" : "å·¦ã«ãšã‚ŒãŸï¼";
        } else if (power < 0.6) {
          missReason = "å¼±ã™ããŸï¼";
        } else if (power > 1.4) {
          missReason = "å¼·ã™ããŸï¼";
        }

        // å‹•ç‰©ãŒæ¨ªå–ã‚Šã™ã‚‹ã‹ã©ã†ã‹ï¼ˆæˆåŠŸæ™‚ã®ã¿ç™ºå‹•ã€70%ã®ç¢ºç‡ï¼‰
        const willIntercept = isOnTarget && Math.random() < interferenceChance;
        const interceptType = Math.random() < 0.5 ? "cat" : "dog";
        const interceptTiming = 0.4 + Math.random() * 0.3; // 40%ã€œ70%ã®ä½ç½®ã§æ¨ªå–ã‚Š
        let intercepted = false;
        let interceptTriggered = false;

        // æ”¾ç‰©ç·šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const duration = 500 + (1.5 - power) * 300;
        const rotation = 360 + power * 540;
        const startTime = Date.now();

        function animateCoin() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // æ”¾ç‰©ç·šã®è¨ˆç®—
          const x = startX + (finalLandX - startX) * progress;
          const y = startY + (finalLandY - startY) * progress - Math.sin(progress * Math.PI) * arcHeight;

          coin.style.left = `${x}px`;
          coin.style.top = `${y}px`;
          coin.style.transform = `rotate(${progress * rotation}deg) scale(${1 - progress * 0.3})`;

          // æ¨ªå–ã‚Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
          if (willIntercept && !interceptTriggered && progress >= interceptTiming) {
            interceptTriggered = true;
            const interceptX = x;
            const interceptY = y;

            if (interceptType === "cat") {
              catIntercept(interceptX, interceptY, () => {
                intercepted = true;
                coin.remove();
                showMissEffect(interceptX, interceptY, "çŒ«ã«å–ã‚‰ã‚ŒãŸï¼");
              });
            } else {
              dogIntercept(interceptX, interceptY, () => {
                intercepted = true;
                coin.remove();
                showMissEffect(interceptX, interceptY, "çŠ¬ã«å–ã‚‰ã‚ŒãŸï¼");
              });
            }
          }

          if (intercepted) {
            return; // æ¨ªå–ã‚Šã•ã‚ŒãŸã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
          }

          if (progress < 1) {
            requestAnimationFrame(animateCoin);
          } else {
            coin.remove();

            // æ¨ªå–ã‚ŠãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¦ã„ãŸã‚‰æˆåŠŸåˆ¤å®šã—ãªã„
            if (interceptTriggered) {
              return;
            }

            if (!isOnTarget) {
              // è³½éŠ­ç®±ã‚’å¤–ã—ãŸ
              showMissEffect(finalLandX, finalLandY, missReason);
            } else {
              // æˆåŠŸï¼
              createSparkles(boxCenterX, boxCenterY);
              triggerSuccessEffect(boxCenterX, boxCenterY);

              const accuracy = 1 - Math.abs(power - 1) * 2;
              const bonus = Math.floor(accuracy * 15);
              score += 10 + bonus;
              if (scoreElement) scoreElement.textContent = score;

              setTimeout(() => {
                showOmikuji();
              }, 2000);
            }
          }
        }

        animateCoin();
      }

      // å¤±æ•—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      function showMissEffect(x, y, reason) {
        failReason.textContent = reason;
        failOverlay.classList.add("show");
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      function createSparkles(x, y) {
        const colors = ["#ffd700", "#ffec8b", "#fff", "#ffa500", "#ff6347"];
        for (let i = 0; i < 20; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          const size = 5 + Math.random() * 10;
          const color = colors[Math.floor(Math.random() * colors.length)];
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          particle.style.setProperty("--tx", `${(Math.random() - 0.5) * 200}px`);
          particle.style.setProperty("--ty", `${(Math.random() - 0.5) * 200}px`);
          document.body.appendChild(particle);
          setTimeout(() => particle.remove(), 1000);
        }
      }

      // çµæœç”»åƒã‚’è¡¨ç¤º
      function showOmikuji() {
        const randomIndex = Math.floor(Math.random() * resultImages.length);
        const imagePath = resultImages[randomIndex] + "?t=" + Date.now();
        console.log("é¸ã°ã‚ŒãŸç”»åƒ:", randomIndex + 1, imagePath);
        resultImage.src = imagePath;
        omikujiOverlay.classList.add("show");
      }

      // æ‰‹ã®å‹•ãã‚’å‡¦ç†
      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // æ‰‹ã®éª¨æ ¼ã‚’æç”»
          drawHandSkeleton(landmarks);

          // æ‰‹é¦–ã®ä½ç½®ï¼ˆlandmark 0ï¼‰
          const wrist = landmarks[0];
          const handX = (1.0 - wrist.x) * window.innerWidth;
          const handY = wrist.y * window.innerHeight;

          // æ‰‹ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ç§»å‹•
          handIndicator.style.left = `${handX}px`;
          handIndicator.style.top = `${handY}px`;
          handIndicator.style.display = "block";

          // X,Yåº§æ¨™ã®å±¥æ­´ã‚’è¨˜éŒ²
          handYHistory.push(handY);
          handXHistory.push(handX);
          if (handYHistory.length > historyLength) {
            handYHistory.shift();
            handXHistory.shift();
          }

          // æŒ¯ã‚Šä¸‹ã‚ã—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’æ¤œå‡º
          if (handYHistory.length >= historyLength && canThrow && !throwCooldown) {
            const firstY = handYHistory[0];
            const lastY = handYHistory[handYHistory.length - 1];
            const firstX = handXHistory[0];
            const lastX = handXHistory[handXHistory.length - 1];

            const movementY = lastY - firstY; // ä¸‹æ–¹å‘ã®ç§»å‹•é‡
            const movementX = lastX - firstX; // å·¦å³ã®ç§»å‹•é‡ï¼ˆå³ãŒãƒ—ãƒ©ã‚¹ï¼‰

            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
            console.log(`Y: ${movementY.toFixed(0)}px, X: ${movementX.toFixed(0)}px`);

            // ä¸Šã‹ã‚‰ä¸‹ã¸ã®å‹•ãï¼ˆ100pxä»¥ä¸Šï¼‰ã‚’æ¤œå‡º
            if (movementY > 100 && firstY < window.innerHeight * 0.5) {
              canThrow = false;
              throwCooldown = true;

              // æŠ•ã’ã®å¼·ã•ã‚’è¨ˆç®—ï¼ˆ100ã€œ400pxã®å‹•ãã‚’0.5ã€œ1.5ã«å¤‰æ›ï¼‰
              const throwPower = Math.min(Math.max(movementY / 200, 0.5), 1.5);

              // æŠ•ã’ã®æ–¹å‘ã‚’è¨ˆç®—ï¼ˆ-200ã€œ+200pxã®å‹•ãã‚’-1ã€œ+1ã«å¤‰æ›ï¼‰
              const throwDirection = Math.min(Math.max(movementX / 200, -1), 1);

              if (status) {
                status.textContent = `æŠ•ã’ãŸï¼ğŸ’ª${(throwPower * 100).toFixed(0)}%`;
                status.className = "throwing";
              }

              // å°éŠ­ã‚’æŠ•ã’ã‚‹ï¼ˆå¼·ã•ã¨æ–¹å‘ã‚’æ¸¡ã™ï¼‰
              throwCoin(handX, handY, throwPower, throwDirection);

              // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
              setTimeout(() => {
                throwCooldown = false;
              }, 3000);
            }
          }

          // æ‰‹ãŒä¸Šã«ã‚ã‚‹ã¨ã
          if (handY < window.innerHeight * 0.5 && canThrow) {
            const currentMovement =
              handYHistory.length > 1 ? handYHistory[handYHistory.length - 1] - handYHistory[0] : 0;
            if (status) {
              status.textContent = `æº–å‚™OKï¼æŒ¯ã‚Šä¸‹ã‚ã—ã¦ï¼(${Math.max(0, currentMovement).toFixed(0)}px)`;
              status.className = "active";
            }
          } else if (canThrow && !throwCooldown) {
            if (status) {
              status.textContent = "æ‰‹ã‚’ä¸Šã«ä¸Šã’ã¦ãã ã•ã„";
              status.className = "";
            }
          }
        } else {
          handIndicator.style.display = "none";
          if (canThrow && status) {
            status.textContent = "æ‰‹ãŒè¦‹ãˆã¾ã›ã‚“...";
            status.className = "";
          }
          handYHistory = [];
          handXHistory = [];
        }

        canvasCtx.restore();
      }

      // æ‰‹ã®éª¨æ ¼ã‚’æç”»
      function drawHandSkeleton(landmarks) {
        canvasCtx.strokeStyle = "#ffd700";
        canvasCtx.lineWidth = 2;

        const connections = [
          [0, 1],
          [1, 2],
          [2, 3],
          [3, 4],
          [0, 5],
          [5, 6],
          [6, 7],
          [7, 8],
          [0, 9],
          [9, 10],
          [10, 11],
          [11, 12],
          [0, 13],
          [13, 14],
          [14, 15],
          [15, 16],
          [0, 17],
          [17, 18],
          [18, 19],
          [19, 20],
          [5, 9],
          [9, 13],
          [13, 17],
        ];

        connections.forEach(([start, end]) => {
          const startPoint = landmarks[start];
          const endPoint = landmarks[end];
          canvasCtx.beginPath();
          canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
          canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
          canvasCtx.stroke();
        });

        landmarks.forEach((landmark) => {
          const x = landmark.x * canvasElement.width;
          const y = landmark.y * canvasElement.height;
          canvasCtx.beginPath();
          canvasCtx.arc(x, y, 4, 0, 2 * Math.PI);
          canvasCtx.fillStyle = "#ffd700";
          canvasCtx.fill();
        });
      }

      // ã‚«ãƒ¡ãƒ©èµ·å‹•
      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            console.log("ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†");

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", error);
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—: " + error.message;
        }
      }

      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
      const tutorialModal = document.getElementById("tutorial-modal");
      const startButton = document.getElementById("start-button");
      const nextButton = document.getElementById("next-button");
      const slides = document.querySelectorAll(".slide");
      const indicators = document.querySelectorAll(".slide-indicator");
      let currentSlide = 0;
      const totalSlides = slides.length;

      function showSlide(index) {
        slides.forEach((slide, i) => {
          slide.classList.remove("active", "prev");
          if (i === index) {
            slide.classList.add("active");
          } else if (i < index) {
            slide.classList.add("prev");
          }
        });
        indicators.forEach((ind, i) => {
          ind.classList.toggle("active", i === index);
        });

        // æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ãªã‚‰ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (currentSlide === totalSlides - 1) {
          nextButton.style.display = "none";
          startButton.style.display = "inline-block";
        }
      }

      nextButton.addEventListener("click", () => {
        if (currentSlide < totalSlides - 1) {
          currentSlide++;
          showSlide(currentSlide);
        }
      });

      startButton.addEventListener("click", () => {
        tutorialModal.classList.add("hidden");
        loading.classList.remove("hidden");
        startCamera();
      });
    </script>
  </body>
</html>
