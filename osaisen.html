<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„ÅäË≥ΩÈä≠„Ç∏„Çß„Çπ„ÉÅ„É£„Éº - ‰∏¶Ê≤≥Á®≤Ëç∑</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Hiragino Kaku Gothic ProN", "„É°„Ç§„É™„Ç™", sans-serif;
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      /* ÈáëËâ≤„ÅÆÂ∏ÇÊùæÊ®°ÊßòËÉåÊôØ */
      #background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-conic-gradient(from 0deg at 50% 50%, #d4a017 0deg 90deg, #c49a15 90deg 180deg);
        background-size: 60px 60px;
        z-index: -2;
      }

      #top-banner h1 {
        color: #ffd700;
        font-size: 28px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-weight: bold;
      }

      #video-container {
        position: fixed;
        top: 100px;
        right: 20px;
        width: 240px;
        height: 180px;
        border: 3px solid #ffd700;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        background: #000;
        z-index: 1000;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* Á•ûÁ§æ„ÅÆ„É°„Ç§„É≥„Ç®„É™„Ç¢ */
      #shrine-area {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: calc(100% - 80px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }

      /* È≥•Â±ÖÁîªÂÉè */
      #torii-image {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 100%;

        z-index: 5;
      }

      /* Ë≥ΩÈä≠ÁÆ±„Ç®„É™„Ç¢ */
      #saisenbox-area {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        transition: transform 0.3s ease;
      }

      #saisenbox-image {
        width: 250px;
        transition: transform 0.5s ease;
      }

      /* Áä¨„Ç≠„É£„É©„ÇØ„Çø„Éº */
      #dog-character {
        position: absolute;
        bottom: 100px;
        left: calc(50% - 250px);
        width: 140px;
        height: auto;
        z-index: 25;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: all 0.3s ease;
      }

      #dog-character.active {
        opacity: 1;
      }

      #dog-character.blocking {
        animation: dogBlock 2s linear forwards;
      }

      @keyframes dogBlock {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(350px);
        }
      }

      /* Áå´„Ç≠„É£„É©„ÇØ„Çø„ÉºÔºàÈÇ™È≠îÂΩπÔºâ */
      #cat-character {
        position: absolute;
        bottom: 80px;
        left: calc(50% + 60px);
        width: 120px;
        height: auto;
        z-index: 30;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: all 0.3s ease;
        transform: translateY(50px);
      }

      #cat-character.active {
        opacity: 1;
        transform: translateY(0);
      }

      #cat-character.blocking {
        animation: catBlock 0.3s ease-in-out infinite;
      }

      @keyframes catBlock {
        0%,
        100% {
          transform: translateX(0) rotate(0deg) scale(1);
        }
        25% {
          transform: translateX(-50px) rotate(-15deg) scale(1.1);
        }
        50% {
          transform: translateX(0) rotate(0deg) scale(1.2);
        }
        75% {
          transform: translateX(50px) rotate(15deg) scale(1.1);
        }
      }

      /* Èà¥ */
      #bell {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 60px;
        z-index: 15;
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        transition: transform 0.1s;
      }

      #bell.ringing {
        animation: ring 0.5s ease-in-out;
      }

      @keyframes ring {
        0%,
        100% {
          transform: translateX(-50%) rotate(0deg);
        }
        20% {
          transform: translateX(-50%) rotate(20deg);
        }
        40% {
          transform: translateX(-50%) rotate(-20deg);
        }
        60% {
          transform: translateX(-50%) rotate(15deg);
        }
        80% {
          transform: translateX(-50%) rotate(-15deg);
        }
      }

      /* Êâã„ÅÆ‰ΩçÁΩÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
      #hand-indicator {
        position: fixed;
        width: 60px;
        height: 60px;
        font-size: 50px;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        transition: transform 0.05s;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      /* Â∞èÈä≠ */
      .coin {
        position: fixed;
        font-size: 40px;
        pointer-events: none;
        z-index: 500;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
      }

      /* ÊàêÂäüÊôÇ„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
      #success-light {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 70%, rgba(255, 215, 0, 0.8) 0%, transparent 50%);
        opacity: 0;
        pointer-events: none;
        z-index: 100;
        transition: opacity 0.3s;
      }

      #success-light.active {
        animation: lightBurst 1s ease-out;
      }

      @keyframes lightBurst {
        0% {
          opacity: 0;
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* ÂÖâ„ÅÆÁ≤íÂ≠ê */
      .light-particle {
        position: fixed;
        width: 10px;
        height: 10px;
        background: radial-gradient(circle, #fff 0%, #ffd700 50%, transparent 100%);
        border-radius: 50%;
        pointer-events: none;
        z-index: 150;
        animation: particleRise 2s ease-out forwards;
      }

      @keyframes particleRise {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-200px) scale(0);
        }
      }

      /* „Åä„Åø„Åè„Åò */
      #omikuji-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #omikuji-overlay.show {
        display: flex;
        opacity: 1;
      }

      #omikuji-paper {
        background: linear-gradient(180deg, #fff8e7 0%, #f5e6c8 100%);
        width: 220px;
        padding: 40px 30px;
        border-radius: 4px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0) rotate(-10deg);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid #d4a017;
      }

      #omikuji-overlay.show #omikuji-paper {
        transform: scale(1) rotate(0deg);
      }

      #omikuji-result {
        font-size: 72px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      #omikuji-message {
        font-size: 16px;
        color: #333;
        line-height: 1.8;
        white-space: pre-line;
      }

      #close-omikuji {
        margin-top: 30px;
        padding: 12px 35px;
        font-size: 16px;
        background: #c41e3a;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      #close-omikuji:hover {
        background: #a01830;
        transform: scale(1.05);
      }

      /* Ë™¨Êòé„Éë„Éç„É´ */
      #info {
        position: fixed;
        top: 100px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        max-width: 260px;
        z-index: 1000;
        border: 2px solid #d4a017;
      }

      #info h2 {
        margin-bottom: 10px;
        color: #c41e3a;
        font-size: 18px;
      }

      #info p {
        margin: 8px 0;
        color: #333;
        font-size: 13px;
        line-height: 1.5;
      }

      #status {
        margin-top: 12px;
        padding: 8px 12px;
        background: #f0f0f0;
        border-radius: 6px;
        font-weight: bold;
        color: #666;
        text-align: center;
        font-size: 14px;
      }

      #status.active {
        background: #d4edda;
        color: #155724;
      }

      #status.throwing {
        background: #fff3cd;
        color: #856404;
      }

      #status.blocked {
        background: #f8d7da;
        color: #721c24;
      }

      /* „Çπ„Ç≥„Ç¢Ë°®Á§∫ */
      #score-display {
        margin-top: 10px;
        padding: 8px;
        background: linear-gradient(135deg, #ffd700, #f0c000);
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        color: #333;
      }

      /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 10000;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #c41e3a;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà */
      .sparkle {
        position: fixed;
        pointer-events: none;
        font-size: 30px;
        animation: sparkle 1s ease-out forwards;
        z-index: 1500;
      }

      @keyframes sparkle {
        0% {
          opacity: 1;
          transform: scale(0) rotate(0deg);
        }
        50% {
          opacity: 1;
          transform: scale(1.2) rotate(180deg);
        }
        100% {
          opacity: 0;
          transform: scale(0.5) rotate(360deg);
        }
      }

      /* Â§±Êïó„Ç®„Éï„Çß„ÇØ„Éà */
      .miss-effect {
        position: fixed;
        font-size: 60px;
        pointer-events: none;
        z-index: 1500;
        animation: missAnim 1s ease-out forwards;
      }

      @keyframes missAnim {
        0% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
        100% {
          opacity: 0;
          transform: scale(1.5) translateY(-50px);
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p>„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...</p>
    </div>

    <div id="background"></div>
    <div id="success-light"></div>

    <div id="container">
      <div id="top-banner">
        <h1>„ÅäË≥ΩÈä≠„ÇíÊäï„ÅíÂÖ•„Çå„ÇçÔºÅ</h1>
      </div>

      <div id="info">
        <h2>‰∏¶Ê≤≥Á®≤Ëç∑ „ÅäË≥ΩÈä≠„Ç≤„Éº„É†</h2>
        <p>‚úã <strong>Êâã„Çí‰∏ä„Å´‰∏ä„Åí„Å¶</strong>Ê∫ñÂÇô</p>
        <p>üëá <strong>ÊåØ„Çä‰∏ã„Çç„Åô</strong>„Å®„ÅäË≥ΩÈä≠„ÇíÊäï„Åí„Åæ„Åô</p>
        <p>üê± <strong>Áå´„Å´Ê≥®ÊÑèÔºÅ</strong>ÈÇ™È≠î„Åó„Å¶„Åç„Åæ„Åô</p>
        <div id="status">ÂæÖÊ©ü‰∏≠...</div>
        <div id="score-display">„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
      </div>

      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <div id="hand-indicator">‚úã</div>

      <div id="shrine-area">
        <img id="torii-image" src="osaisen-images/tobira.png" alt="È≥•Â±Ö" />
        <div id="saisenbox-area">
          <img id="saisenbox-image" src="osaisen-images/box.png" alt="Ë≥ΩÈä≠ÁÆ±" />
        </div>

        <img id="dog-character" src="osaisen-images/dog.png" alt="Áä¨" />
        <img id="cat-character" src="osaisen-images/cat.png" alt="Áå´" />
      </div>
    </div>

    <!-- „Åä„Åø„Åè„Åò„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="omikuji-overlay">
      <div id="omikuji-paper">
        <div id="omikuji-result"></div>
        <div id="omikuji-message"></div>
        <button id="close-omikuji">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âºï„Åè</button>
      </div>
    </div>

    <!-- Èü≥Â£∞ÁîüÊàê -->
    <script>
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBellSound() {
        const oscillator1 = audioCtx.createOscillator();
        const oscillator2 = audioCtx.createOscillator();
        const oscillator3 = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator1.type = "sine";
        oscillator1.frequency.setValueAtTime(2500, audioCtx.currentTime);
        oscillator1.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.8);

        oscillator2.type = "sine";
        oscillator2.frequency.setValueAtTime(3500, audioCtx.currentTime);
        oscillator2.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.8);

        oscillator3.type = "triangle";
        oscillator3.frequency.setValueAtTime(1800, audioCtx.currentTime);
        oscillator3.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.6);

        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);

        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        oscillator3.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator1.start();
        oscillator2.start();
        oscillator3.start();
        oscillator1.stop(audioCtx.currentTime + 1.2);
        oscillator2.stop(audioCtx.currentTime + 1.2);
        oscillator3.stop(audioCtx.currentTime + 1.2);
      }

      function playCoinSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sine";
        oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);

        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
      }

      function playMeowSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sawtooth";
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
        oscillator.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.4);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
      }

      function playMissSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
      }
    </script>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const handIndicator = document.getElementById("hand-indicator");
      const status = document.getElementById("status");
      const loading = document.getElementById("loading");
      const bell = document.getElementById("bell");
      const saisenboxArea = document.getElementById("saisenbox-area");
      const omikujiOverlay = document.getElementById("omikuji-overlay");
      const omikujiResult = document.getElementById("omikuji-result");
      const omikujiMessage = document.getElementById("omikuji-message");
      const closeOmikuji = document.getElementById("close-omikuji");
      const successLight = document.getElementById("success-light");
      const catCharacter = document.getElementById("cat-character");
      const dogCharacter = document.getElementById("dog-character");
      const scoreElement = document.getElementById("score");

      let handLandmarker = null;
      let lastVideoTime = -1;

      // „Ç≤„Éº„É†Áä∂ÊÖã
      let handYHistory = [];
      let handXHistory = [];
      const historyLength = 10;
      let canThrow = true;
      let throwCooldown = false;
      let score = 0;
      let throwCount = 0;

      // Áå´„ÅÆÈÇ™È≠îÊ©üËÉΩ
      let catActive = false;
      let catBlockingActive = false;

      // Áä¨„ÅÆÈÇ™È≠îÊ©üËÉΩ
      let dogActive = false;
      let dogBlockingActive = false;

      // ÈÇ™È≠î„Ç≠„É£„É©„ÅÆÂá∫ÁèæÈ†ªÂ∫¶Ôºà„Åã„Å™„ÇäÈ´ò„ÇÅÔºâ
      let interferenceChance = 0.7;

      // „Åä„Åø„Åè„Åò„Éá„Éº„Çø
      const omikujiData = [
        { result: "Â§ßÂêâ", color: "#ff0000", message: "ÊúÄÈ´ò„ÅÆÈÅãÂã¢ÔºÅ\nÈ°ò„ÅÑ‰∫ã„ÅåÂè∂„ÅÜ„Åß„Åó„Çá„ÅÜ„ÄÇ\nÁ©çÊ•µÁöÑ„Å´Ë°åÂãï„Çí„ÄÇ" },
        { result: "‰∏≠Âêâ", color: "#ff6600", message: "ËâØ„ÅÑÈÅãÂã¢„Åß„Åô„ÄÇ\nÂä™Âäõ„ÅåÂÆü„ÇíÁµê„Å≥„Åæ„Åô„ÄÇ\nÁÑ¶„Çâ„ÅöÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
        { result: "Â∞èÂêâ", color: "#ffcc00", message: "„Åæ„Åö„Åæ„Åö„ÅÆÈÅãÂã¢„ÄÇ\nÂ∞è„Åï„Å™Âπ∏„Åõ„ÇíÂ§ßÂàá„Å´„ÄÇ\nÊÑüË¨ù„ÇíÂøò„Çå„Åö„Å´„ÄÇ" },
        { result: "Âêâ", color: "#33cc33", message: "ÊôÆÈÄö„ÅÆÈÅãÂã¢„ÄÇ\nÂπ≥Á©è„Å™Êó•„ÄÖ„ÅåÁ∂ö„Åç„Åæ„Åô„ÄÇ\nÂÅ•Â∫∑„Å´Ê≥®ÊÑè„Çí„ÄÇ" },
        { result: "Êú´Âêâ", color: "#3399ff", message: "„Åì„Çå„Åã„Çâ‰∏äÂêë„Åç„ÄÇ\nËæõÊä±Âº∑„ÅèÂæÖ„Å¶„Å∞\nËâØ„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ" },
        { result: "Âá∂", color: "#9933ff", message: "Ê≥®ÊÑè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\nÊÖéÈáç„Å´Ë°åÂãï„Åó\nÁÑ°ÁêÜ„ÅØÁ¶ÅÁâ©„ÄÇ" },
      ];

      // Áå´„ÅåÁ™ÅÁÑ∂Âá∫„Å¶„Åç„Å¶ÈÇ™È≠î„Çí„Åô„Çã
      function triggerCatInterference() {
        if (catActive || dogActive || !canThrow) return;

        catActive = true;

        // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Åã„ÇâÂá∫ÁèæÔºàÂ∑¶ÂÅ¥„ÅãÂè≥ÂÅ¥„Åã‰∏≠Â§ÆÔºâ
        const positions = ["left", "center", "right"];
        const pos = positions[Math.floor(Math.random() * positions.length)];

        if (pos === "left") {
          catCharacter.style.left = "calc(50% - 150px)";
        } else if (pos === "right") {
          catCharacter.style.left = "calc(50% + 100px)";
        } else {
          catCharacter.style.left = "calc(50% - 20px)";
        }

        catCharacter.classList.add("active");

        // „Åô„Åê„Å´„Éñ„É≠„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´
        setTimeout(() => {
          catBlockingActive = true;
          catCharacter.classList.add("blocking");
        }, 300);

        // Áå´„ÅåÂéª„ÇãÔºàÁü≠„ÇÅÔºâ
        setTimeout(() => {
          catCharacter.classList.remove("active", "blocking");
          catActive = false;
          catBlockingActive = false;
        }, 2500);
      }

      // Áä¨„ÅåÁõ¥Á∑öÁöÑ„Å´Âãï„ÅÑ„Å¶ÈÇ™È≠î„Çí„Åô„Çã
      function triggerDogInterference() {
        if (dogActive || catActive || !canThrow) return;

        dogActive = true;

        dogCharacter.classList.add("active");

        // „Åô„Åê„Å´„Éñ„É≠„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´ÔºàÂ∑¶Âè≥„Å´Âãï„ÅèÔºâ
        setTimeout(() => {
          dogBlockingActive = true;
          dogCharacter.classList.add("blocking");
        }, 200);

        // Áä¨„ÅåÂéª„Çã
        setTimeout(() => {
          dogCharacter.classList.remove("active", "blocking");
          dogActive = false;
          dogBlockingActive = false;
        }, 3000);
      }

      // ÂÆöÊúüÁöÑ„Å´Áå´„ÅãÁä¨„ÅåÈÇ™È≠î„Åó„Å´Êù•„ÇãÔºàÈ†ªÁπÅ„Å´Ôºâ
      setInterval(() => {
        if (canThrow && !throwCooldown && Math.random() < interferenceChance) {
          // „É©„É≥„ÉÄ„É†„ÅßÁå´„ÅãÁä¨
          if (Math.random() < 0.5) {
            triggerCatInterference();
          } else {
            triggerDogInterference();
          }
        }
      }, 2000);

      // „Åä„Åø„Åè„Åò„ÇíÈñâ„Åò„Çã
      closeOmikuji.addEventListener("click", () => {
        omikujiOverlay.classList.remove("show");
        canThrow = true;
      });

      // MediaPipeÂàùÊúüÂåñ
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.7,
          minHandPresenceConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });

        console.log("Hand LandmarkerÂàùÊúüÂåñÂÆå‰∫Ü");
      }

      // ÊàêÂäüÊôÇ„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà
      function triggerSuccessEffect(x, y) {
        successLight.classList.add("active");
        setTimeout(() => successLight.classList.remove("active"), 1000);

        // ÂÖâ„ÅÆÁ≤íÂ≠ê„ÇíÁîüÊàê
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const particle = document.createElement("div");
            particle.className = "light-particle";
            particle.style.left = `${x + (Math.random() - 0.5) * 200}px`;
            particle.style.top = `${y + Math.random() * 50}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
          }, i * 50);
        }
      }

      // Â∞èÈä≠„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÂº∑„Åï„Å®ÊñπÂêë„Å´ÂØæÂøúÔºâ
      // power: 0.5„Äú1.5ÔºàÂº±„ÄúÂº∑Ôºâ
      // direction: -1„Äú+1ÔºàÂ∑¶„ÄúÂè≥Ôºâ
      function throwCoin(startX, startY, power = 1, direction = 0) {
        throwCount++;

        const coin = document.createElement("div");
        coin.className = "coin";
        coin.textContent = "ü™ô";
        coin.style.left = `${startX}px`;
        coin.style.top = `${startY}px`;
        document.body.appendChild(coin);

        // Ë≥ΩÈä≠ÁÆ±„ÅÆ‰ΩçÁΩÆ
        const boxRect = saisenboxArea.getBoundingClientRect();
        const boxCenterX = boxRect.left + boxRect.width / 2;
        const boxCenterY = boxRect.top + 30;

        // Âº∑„Åï„Å´Âøú„Åò„ÅüÂºß„ÅÆÈ´ò„ÅïÔºàÂº±„ÅÑ=‰Ωé„ÅÑÂºß„ÄÅÂº∑„ÅÑ=È´ò„ÅÑÂºßÔºâ
        const arcHeight = 80 + power * 100; // 80„Äú230px

        // Âº∑„Åï„Å´Âøú„Åò„ÅüÈ£õË∑ùÈõ¢ÔºàÂº±„ÅÑ„Å®ÊâãÂâç„Å´ËêΩ„Å°„Çã„ÄÅÂº∑„ÅÑ„Å®Â••„Å´È£õ„Å∂Ôºâ
        // ÈÅ©Ê≠£ÂÄ§„ÅØ0.95„Äú1.05„Åè„Çâ„ÅÑ
        const distanceMultiplier = 0.5 + power * 0.5; // 0.5„Äú1.25

        // ÊñπÂêë„Å´Âøú„Åò„ÅüÊ®™„Åö„ÇåÔºà-120„Äú+120pxÔºâÂ∞ë„Å™„ÇÅ„Å´
        const horizontalOffset = direction * 120;

        // ÁõÆÊ®ôÂú∞ÁÇπ„ÇíË®àÁÆó
        let targetX = boxCenterX + horizontalOffset;
        let targetY = boxCenterY;

        // ÊúÄÁµÇÁùÄÂú∞ÁÇπ„ÇíË®àÁÆó
        const finalLandX = boxCenterX + horizontalOffset;
        const finalLandY = boxCenterY + (1 - distanceMultiplier) * 150; // Âº±„ÅÑ„Å®ÊâãÂâç„ÄÅÂº∑„ÅÑ„Å®Â••

        // ÂΩì„Åü„ÇäÂà§ÂÆöÔºöË≥ΩÈä≠ÁÆ±„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const hitBoxLeft = boxRect.left + 30;
        const hitBoxRight = boxRect.right - 30;
        const hitBoxTop = boxRect.top;
        const hitBoxBottom = boxRect.top + 60;

        // XÊñπÂêë„ÅÆÂà§ÂÆöÔºàÁØÑÂõ≤„ÇíÂ∫É„Åí„ÅüÔºâ
        const isOnTargetX = finalLandX >= hitBoxLeft - 30 && finalLandX <= hitBoxRight + 30;
        // YÊñπÂêëÔºàË∑ùÈõ¢Ôºâ„ÅÆÂà§ÂÆöÔºöÈÅ©Ê≠£„Éë„ÉØ„Éº„ÅØ0.6„Äú1.4Ôºà„Åã„Å™„ÇäÂ∫É„ÇÅÔºâ
        const isOnTargetY = power >= 0.6 && power <= 1.4;
        const isOnTarget = isOnTargetX && isOnTargetY;

        // Â§±ÊïóÁêÜÁî±„ÇíË®òÈå≤
        let missReason = "";
        if (!isOnTargetX) {
          missReason = direction > 0 ? "Âè≥„Å´„Åö„Çå„ÅüÔºÅ" : "Â∑¶„Å´„Åö„Çå„ÅüÔºÅ";
        } else if (power < 0.6) {
          missReason = "Âº±„Åô„Åé„ÅüÔºÅÊâãÂâç„Å´ËêΩ„Å°„Åü...";
        } else if (power > 1.4) {
          missReason = "Âº∑„Åô„Åé„ÅüÔºÅÂ••„Å´È£õ„Çì„Å†...";
        }

        // Áå´„ÅãÁä¨„ÅåÈÇ™È≠î„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
        let hitAnimal = false;
        let hitAnimalName = "";
        if (catBlockingActive) {
          const catRect = catCharacter.getBoundingClientRect();
          // „Ç≥„Ç§„É≥„ÅåÁå´„ÅÆÁØÑÂõ≤„ÇíÈÄöÈÅé„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if (finalLandX >= catRect.left - 50 && finalLandX <= catRect.right + 50) {
            targetX = catRect.left + catRect.width / 2;
            targetY = catRect.top + catRect.height / 2;
            hitAnimal = true;
            hitAnimalName = "Áå´";
          }
        }
        if (dogBlockingActive && !hitAnimal) {
          const dogRect = dogCharacter.getBoundingClientRect();
          // „Ç≥„Ç§„É≥„ÅåÁä¨„ÅÆÁØÑÂõ≤„ÇíÈÄöÈÅé„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if (finalLandX >= dogRect.left - 50 && finalLandX <= dogRect.right + 50) {
            targetX = dogRect.left + dogRect.width / 2;
            targetY = dogRect.top + dogRect.height / 2;
            hitAnimal = true;
            hitAnimalName = "Áä¨";
          }
        }

        // ÊîæÁâ©Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const duration = 500 + (1.5 - power) * 300; // Âº∑„ÅÑ„Å®ÈÄü„ÅÑÔºà500„Äú800msÔºâ
        const rotation = 360 + power * 540; // Âº∑„ÅÑ„Å®Â§ö„ÅèÂõûËª¢
        const startTime = Date.now();

        function animateCoin() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // ÊîæÁâ©Á∑ö„ÅÆË®àÁÆó
          let x, y;
          if (hitAnimal) {
            x = startX + (targetX - startX) * progress;
            y = startY + (targetY - startY) * progress - Math.sin(progress * Math.PI) * arcHeight;
          } else {
            x = startX + (finalLandX - startX) * progress;
            y = startY + (finalLandY - startY) * progress - Math.sin(progress * Math.PI) * arcHeight;
          }

          coin.style.left = `${x}px`;
          coin.style.top = `${y}px`;
          coin.style.transform = `rotate(${progress * rotation}deg) scale(${1 - progress * 0.3})`;

          if (progress < 1) {
            requestAnimationFrame(animateCoin);
          } else {
            coin.remove();

            if (hitAnimal) {
              // ÂãïÁâ©„Å´ÂΩì„Åü„Å£„Åü
              showMissEffect(targetX, targetY);
              status.textContent = hitAnimalName === "Áå´" ? "Áå´„Å´ÈÇ™È≠î„Åï„Çå„ÅüÔºÅüòø" : "Áä¨„Å´ÈÇ™È≠î„Åï„Çå„ÅüÔºÅüêï";
              status.className = "blocked";
              setTimeout(() => {
                canThrow = true;
                throwCooldown = false;
              }, 1500);
            } else if (!isOnTarget) {
              // Ë≥ΩÈä≠ÁÆ±„ÇíÂ§ñ„Åó„Åü
              showMissEffect(finalLandX, finalLandY);
              status.textContent = missReason;
              status.className = "blocked";
              setTimeout(() => {
                canThrow = true;
                throwCooldown = false;
              }, 1500);
            } else {
              // ÊàêÂäüÔºÅ
              createSparkles(boxCenterX, boxCenterY);
              triggerSuccessEffect(boxCenterX, boxCenterY);

              // „Éë„ÉØ„Éº„ÅåÈÅ©Ê≠£‰∏≠Â§Æ„Å´Ëøë„ÅÑ„Åª„Å©„Éú„Éº„Éä„Çπ
              const accuracy = 1 - Math.abs(power - 1) * 2; // 0„Äú1
              const bonus = Math.floor(accuracy * 15);
              score += 10 + bonus;
              scoreElement.textContent = score;

              // Èà¥„ÇíÈ≥¥„Çâ„ÅôÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„ÅøÔºâ
              setTimeout(() => {
                bell.classList.add("ringing");
                setTimeout(() => bell.classList.remove("ringing"), 500);

                // „Åä„Åø„Åè„ÅòË°®Á§∫
                setTimeout(showOmikuji, 800);
              }, 300);
            }
          }
        }

        animateCoin();
      }

      // Â§±Êïó„Ç®„Éï„Çß„ÇØ„Éà
      function showMissEffect(x, y) {
        const miss = document.createElement("div");
        miss.className = "miss-effect";
        miss.textContent = "‚ùå";
        miss.style.left = `${x}px`;
        miss.style.top = `${y}px`;
        document.body.appendChild(miss);
        setTimeout(() => miss.remove(), 1000);
      }

      // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
      function createSparkles(x, y) {
        const sparkles = ["‚ú®", "‚≠ê", "üí´", "üåü"];
        for (let i = 0; i < 12; i++) {
          const sparkle = document.createElement("div");
          sparkle.className = "sparkle";
          sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
          sparkle.style.left = `${x + (Math.random() - 0.5) * 150}px`;
          sparkle.style.top = `${y + (Math.random() - 0.5) * 150}px`;
          document.body.appendChild(sparkle);
          setTimeout(() => sparkle.remove(), 1000);
        }
      }

      // „Åä„Åø„Åè„ÅòË°®Á§∫
      function showOmikuji() {
        const fortune = omikujiData[Math.floor(Math.random() * omikujiData.length)];
        omikujiResult.textContent = fortune.result;
        omikujiResult.style.color = fortune.color;
        omikujiMessage.textContent = fortune.message;
        omikujiOverlay.classList.add("show");
      }

      // Êâã„ÅÆÂãï„Åç„ÇíÂá¶ÁêÜ
      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
          drawHandSkeleton(landmarks);

          // ÊâãÈ¶ñ„ÅÆ‰ΩçÁΩÆÔºàlandmark 0Ôºâ
          const wrist = landmarks[0];
          const handX = (1.0 - wrist.x) * window.innerWidth;
          const handY = wrist.y * window.innerHeight;

          // Êâã„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÁßªÂãï
          handIndicator.style.left = `${handX}px`;
          handIndicator.style.top = `${handY}px`;
          handIndicator.style.display = "block";

          // X,YÂ∫ßÊ®ô„ÅÆÂ±•Ê≠¥„ÇíË®òÈå≤
          handYHistory.push(handY);
          handXHistory.push(handX);
          if (handYHistory.length > historyLength) {
            handYHistory.shift();
            handXHistory.shift();
          }

          // ÊåØ„Çä‰∏ã„Çç„Åó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÊ§úÂá∫
          if (handYHistory.length >= historyLength && canThrow && !throwCooldown) {
            const firstY = handYHistory[0];
            const lastY = handYHistory[handYHistory.length - 1];
            const firstX = handXHistory[0];
            const lastX = handXHistory[handXHistory.length - 1];

            const movementY = lastY - firstY; // ‰∏ãÊñπÂêë„ÅÆÁßªÂãïÈáè
            const movementX = lastX - firstX; // Â∑¶Âè≥„ÅÆÁßªÂãïÈáèÔºàÂè≥„Åå„Éó„É©„ÇπÔºâ

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫
            console.log(`Y: ${movementY.toFixed(0)}px, X: ${movementX.toFixed(0)}px`);

            // ‰∏ä„Åã„Çâ‰∏ã„Å∏„ÅÆÂãï„ÅçÔºà100px‰ª•‰∏äÔºâ„ÇíÊ§úÂá∫
            if (movementY > 100 && firstY < window.innerHeight * 0.5) {
              canThrow = false;
              throwCooldown = true;

              // Êäï„Åí„ÅÆÂº∑„Åï„ÇíË®àÁÆóÔºà100„Äú400px„ÅÆÂãï„Åç„Çí0.5„Äú1.5„Å´Â§âÊèõÔºâ
              const throwPower = Math.min(Math.max(movementY / 200, 0.5), 1.5);

              // Êäï„Åí„ÅÆÊñπÂêë„ÇíË®àÁÆóÔºà-200„Äú+200px„ÅÆÂãï„Åç„Çí-1„Äú+1„Å´Â§âÊèõÔºâ
              const throwDirection = Math.min(Math.max(movementX / 200, -1), 1);

              status.textContent = `Êäï„Åí„ÅüÔºÅüí™${(throwPower * 100).toFixed(0)}%`;
              status.className = "throwing";

              // Â∞èÈä≠„ÇíÊäï„Åí„ÇãÔºàÂº∑„Åï„Å®ÊñπÂêë„ÇíÊ∏°„ÅôÔºâ
              throwCoin(handX, handY, throwPower, throwDirection);

              // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥
              setTimeout(() => {
                throwCooldown = false;
              }, 3000);
            }
          }

          // Êâã„Åå‰∏ä„Å´„ÅÇ„Çã„Å®„Åç
          if (handY < window.innerHeight * 0.5 && canThrow) {
            if (catBlockingActive || dogBlockingActive) {
              const animal = catBlockingActive ? "Áå´" : "Áä¨";
              status.textContent = `${animal}„ÅåÈÇ™È≠î„Åó„Å¶„ÇãÔºÅ„Çø„Ç§„Éü„É≥„Ç∞„ÇíË¶ã„Å¶ÔºÅ`;
              status.className = "blocked";
            } else {
              const currentMovement =
                handYHistory.length > 1 ? handYHistory[handYHistory.length - 1] - handYHistory[0] : 0;
              status.textContent = `Ê∫ñÂÇôOKÔºÅÊåØ„Çä‰∏ã„Çç„Åó„Å¶ÔºÅ(${Math.max(0, currentMovement).toFixed(0)}px)`;
              status.className = "active";
            }
          } else if (canThrow && !throwCooldown) {
            status.textContent = "Êâã„Çí‰∏ä„Å´‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ";
            status.className = "";
          }
        } else {
          handIndicator.style.display = "none";
          if (canThrow) {
            status.textContent = "Êâã„ÅåË¶ã„Åà„Åæ„Åõ„Çì...";
            status.className = "";
          }
          handYHistory = [];
          handXHistory = [];
        }

        canvasCtx.restore();
      }

      // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
      function drawHandSkeleton(landmarks) {
        canvasCtx.strokeStyle = "#ffd700";
        canvasCtx.lineWidth = 2;

        const connections = [
          [0, 1],
          [1, 2],
          [2, 3],
          [3, 4],
          [0, 5],
          [5, 6],
          [6, 7],
          [7, 8],
          [0, 9],
          [9, 10],
          [10, 11],
          [11, 12],
          [0, 13],
          [13, 14],
          [14, 15],
          [15, 16],
          [0, 17],
          [17, 18],
          [18, 19],
          [19, 20],
          [5, 9],
          [9, 13],
          [13, 17],
        ];

        connections.forEach(([start, end]) => {
          const startPoint = landmarks[start];
          const endPoint = landmarks[end];
          canvasCtx.beginPath();
          canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
          canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
          canvasCtx.stroke();
        });

        landmarks.forEach((landmark) => {
          const x = landmark.x * canvasElement.width;
          const y = landmark.y * canvasElement.height;
          canvasCtx.beginPath();
          canvasCtx.arc(x, y, 4, 0, 2 * Math.PI);
          canvasCtx.fillStyle = "#ffd700";
          canvasCtx.fill();
        });
      }

      // „Ç´„É°„É©Ëµ∑Âãï
      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "„Ç´„É°„É©API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            console.log("„Ç´„É°„É©Ëµ∑ÂãïÂÆå‰∫Ü");

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          console.error("„Ç´„É°„É©„Ç®„É©„Éº:", error);
          loading.querySelector("p").textContent = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó: " + error.message;
        }
      }

      startCamera();
    </script>
  </body>
</html>
