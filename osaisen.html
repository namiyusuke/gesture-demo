<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„ÅäË≥ΩÈä≠„Ç∏„Çß„Çπ„ÉÅ„É£„Éº - ‰∏¶Ê≤≥Á®≤Ëç∑</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Hiragino Kaku Gothic ProN", "„É°„Ç§„É™„Ç™", sans-serif;
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      /* ÈáëËâ≤„ÅÆÂ∏ÇÊùæÊ®°ÊßòËÉåÊôØ */
      #background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-conic-gradient(from 0deg at 50% 50%, #d4a017 0deg 90deg, #c49a15 90deg 180deg);
        background-size: 60px 60px;
        z-index: -2;
      }

      #video-container {
        position: fixed;
        top: 100px;
        right: 20px;
        width: 240px;
        height: 180px;
        border: 3px solid #ffd700;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        background: #000;
        z-index: 1000;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* Á•ûÁ§æ„ÅÆ„É°„Ç§„É≥„Ç®„É™„Ç¢ */
      #shrine-area {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: calc(100% - 80px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }

      /* È≥•Â±ÖÁîªÂÉè */
      #torii-image {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 100%;

        z-index: 5;
      }

      /* Ë≥ΩÈä≠ÁÆ±„Ç®„É™„Ç¢ */
      #saisenbox-area {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        transition: transform 0.3s ease;
      }

      #saisenbox-image {
        width: 250px;
        transition: transform 0.5s ease;
      }

      /* Áä¨„Ç≠„É£„É©„ÇØ„Çø„Éº */
      #dog-character {
        position: absolute;
        bottom: 100px;
        left: calc(50% - 280px);
        width: 140px;
        height: auto;
        z-index: 25;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #dog-character.active {
        opacity: 1;
      }

      #dog-character.blocking {
        animation: dogRun 2.5s ease-in-out forwards;
      }

      @keyframes dogRun {
        0% {
          transform: translateX(0) translateY(0) scaleX(1);
        }
        10% {
          transform: translateX(40px) translateY(-8px) scaleX(1);
        }
        20% {
          transform: translateX(90px) translateY(0) scaleX(1);
        }
        30% {
          transform: translateX(150px) translateY(-8px) scaleX(1);
        }
        40% {
          transform: translateX(210px) translateY(0) scaleX(1);
        }
        50% {
          transform: translateX(280px) translateY(-5px) scaleX(1);
        }
        60% {
          transform: translateX(350px) translateY(0) scaleX(1);
        }
        70% {
          transform: translateX(400px) translateY(-8px) scaleX(1);
        }
        80% {
          transform: translateX(460px) translateY(0) scaleX(1);
        }
        90% {
          transform: translateX(510px) translateY(-5px) scaleX(1);
        }
        100% {
          transform: translateX(560px) translateY(0) scaleX(1);
        }
      }

      /* Áå´„Ç≠„É£„É©„ÇØ„Çø„ÉºÔºàÈÇ™È≠îÂΩπÔºâ */
      #cat-character {
        position: absolute;
        bottom: 80px;
        left: calc(50% + 60px);
        width: 120px;
        height: auto;
        z-index: 30;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        opacity: 0;
        transition: all 0.3s ease;
        transform: translateY(50px);
      }

      #cat-character.active {
        opacity: 1;
        transform: translateY(0);
      }

      #cat-character.blocking {
        animation: catBlock 0.3s ease-in-out infinite;
      }

      @keyframes catBlock {
        0%,
        100% {
          transform: translateX(0) rotate(0deg) scale(1);
        }
        25% {
          transform: translateX(-50px) rotate(-15deg) scale(1.1);
        }
        50% {
          transform: translateX(0) rotate(0deg) scale(1.2);
        }
        75% {
          transform: translateX(50px) rotate(15deg) scale(1.1);
        }
      }

      /* Èà¥ */
      #bell {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 60px;
        z-index: 15;
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        transition: transform 0.1s;
      }

      #bell.ringing {
        animation: ring 0.5s ease-in-out;
      }

      @keyframes ring {
        0%,
        100% {
          transform: translateX(-50%) rotate(0deg);
        }
        20% {
          transform: translateX(-50%) rotate(20deg);
        }
        40% {
          transform: translateX(-50%) rotate(-20deg);
        }
        60% {
          transform: translateX(-50%) rotate(15deg);
        }
        80% {
          transform: translateX(-50%) rotate(-15deg);
        }
      }

      /* Êâã„ÅÆ‰ΩçÁΩÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
      #hand-indicator {
        position: fixed;
        width: 60px;
        height: 60px;
        font-size: 50px;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        transition: transform 0.05s;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      /* Â∞èÈä≠ */
      .coin {
        position: fixed;
        font-size: 40px;
        pointer-events: none;
        z-index: 500;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
      }

      /* ÊàêÂäüÊôÇ„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
      #success-light {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 70%, rgba(255, 215, 0, 0.8) 0%, transparent 50%);
        opacity: 0;
        pointer-events: none;
        z-index: 100;
        transition: opacity 0.3s;
      }

      #success-light.active {
        animation: lightBurst 1s ease-out;
      }

      @keyframes lightBurst {
        0% {
          opacity: 0;
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* ÂÖâ„ÅÆÁ≤íÂ≠ê */
      .light-particle {
        position: fixed;
        width: 10px;
        height: 10px;
        background: radial-gradient(circle, #fff 0%, #ffd700 50%, transparent 100%);
        border-radius: 50%;
        pointer-events: none;
        z-index: 150;
        animation: particleRise 2s ease-out forwards;
      }

      @keyframes particleRise {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-200px) scale(0);
        }
      }

      /* „Åä„Åø„Åè„Åò */
      #omikuji-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #omikuji-overlay.show {
        display: flex;
        opacity: 1;
      }

      #omikuji-paper {
        background: linear-gradient(180deg, #fff8e7 0%, #f5e6c8 100%);
        width: 80%;
        max-width: 500px;
        padding: 40px 30px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0) rotate(-10deg);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid #d4a017;
      }

      #result-image {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      #omikuji-overlay.show #omikuji-paper {
        transform: scale(1) rotate(0deg);
      }

      /* Â§±Êïó„Ç™„Éº„Éê„Éº„É¨„Ç§ */
      #fail-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #fail-overlay.show {
        display: flex;
        opacity: 1;
      }

      #fail-paper {
        background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%);
        width: 300px;
        padding: 40px 30px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0) rotate(-10deg);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 3px solid #888;
      }

      #fail-overlay.show #fail-paper {
        transform: scale(1) rotate(0deg);
      }

      #fail-title {
        font-size: 48px;
        font-weight: bold;
        color: #ff6b6b;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      #fail-reason {
        font-size: 24px;
        color: #fff;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      #close-fail {
        padding: 12px 35px;
        font-size: 16px;
        background: #666;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      #close-fail:hover {
        background: #888;
        transform: scale(1.05);
      }

      #omikuji-result {
        font-size: 72px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      #omikuji-message {
        font-size: 16px;
        color: #333;
        line-height: 1.8;
        white-space: pre-line;
      }

      #close-omikuji {
        margin-top: 30px;
        padding: 12px 35px;
        font-size: 16px;
        background: #c41e3a;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      #close-omikuji:hover {
        background: #a01830;
        transform: scale(1.05);
      }

      /* Ë™¨Êòé„Éë„Éç„É´ */
      #info {
        position: fixed;
        top: 100px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        max-width: 260px;
        z-index: 1000;
        border: 2px solid #d4a017;
      }

      #info h2 {
        margin-bottom: 10px;
        color: #c41e3a;
        font-size: 18px;
      }

      #info p {
        margin: 8px 0;
        color: #333;
        font-size: 13px;
        line-height: 1.5;
      }

      #status {
        margin-top: 12px;
        padding: 8px 12px;
        background: #f0f0f0;
        border-radius: 6px;
        font-weight: bold;
        color: #666;
        text-align: center;
        font-size: 14px;
      }

      #status.active {
        background: #d4edda;
        color: #155724;
      }

      #status.throwing {
        background: #fff3cd;
        color: #856404;
      }

      #status.blocked {
        background: #f8d7da;
        color: #721c24;
      }

      /* „Çπ„Ç≥„Ç¢Ë°®Á§∫ */
      #score-display {
        margin-top: 10px;
        padding: 8px;
        background: linear-gradient(135deg, #ffd700, #f0c000);
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        color: #333;
      }

      /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 10000;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #c41e3a;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà */
      .particle {
        position: fixed;
        pointer-events: none;
        border-radius: 50%;
        animation: particleBurst 1s ease-out forwards;
        z-index: 1500;
      }

      @keyframes particleBurst {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(var(--tx), var(--ty)) scale(0);
        }
      }

      /* Â§±Êïó„Ç®„Éï„Çß„ÇØ„Éà */
      .miss-effect {
        position: fixed;
        font-size: 28px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        z-index: 1500;
        white-space: nowrap;
        transform: translate(-50%, -50%);
        animation: missAnim 2s ease-out forwards;
      }

      @keyframes missAnim {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(0.5);
        }
        20% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.2);
        }
        40% {
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100%) scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p>„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...</p>
    </div>

    <div id="background"></div>
    <div id="success-light"></div>

    <div id="container">
      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <div id="hand-indicator">‚úã</div>

      <div id="shrine-area">
        <img id="torii-image" src="osaisen-images/tobira.png" alt="È≥•Â±Ö" />
        <div id="saisenbox-area">
          <img id="saisenbox-image" src="osaisen-images/box.png" alt="Ë≥ΩÈä≠ÁÆ±" />
        </div>

        <img id="dog-character" src="osaisen-images/dog.png" alt="Áä¨" />
        <img id="cat-character" src="osaisen-images/cat.png" alt="Áå´" />
      </div>
    </div>

    <!-- ÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="omikuji-overlay">
      <div id="omikuji-paper">
        <img id="result-image" src="" alt="ÁµêÊûú" />
        <button id="close-omikuji">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäï„Åí„Çã</button>
      </div>
    </div>

    <!-- Â§±Êïó„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="fail-overlay">
      <div id="fail-paper">
        <div id="fail-title">ÊÆãÂøµÔºÅ</div>
        <div id="fail-reason"></div>
        <button id="close-fail">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäï„Åí„Çã</button>
      </div>
    </div>

    <!-- Èü≥Â£∞ÁîüÊàê -->
    <script>
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBellSound() {
        const oscillator1 = audioCtx.createOscillator();
        const oscillator2 = audioCtx.createOscillator();
        const oscillator3 = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator1.type = "sine";
        oscillator1.frequency.setValueAtTime(2500, audioCtx.currentTime);
        oscillator1.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.8);

        oscillator2.type = "sine";
        oscillator2.frequency.setValueAtTime(3500, audioCtx.currentTime);
        oscillator2.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.8);

        oscillator3.type = "triangle";
        oscillator3.frequency.setValueAtTime(1800, audioCtx.currentTime);
        oscillator3.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.6);

        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);

        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        oscillator3.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator1.start();
        oscillator2.start();
        oscillator3.start();
        oscillator1.stop(audioCtx.currentTime + 1.2);
        oscillator2.stop(audioCtx.currentTime + 1.2);
        oscillator3.stop(audioCtx.currentTime + 1.2);
      }

      function playCoinSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sine";
        oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);

        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
      }

      function playMeowSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "sawtooth";
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
        oscillator.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.4);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
      }

      function playMissSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
      }
    </script>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const handIndicator = document.getElementById("hand-indicator");
      const status = document.getElementById("status");
      const loading = document.getElementById("loading");
      const bell = document.getElementById("bell");
      const saisenboxArea = document.getElementById("saisenbox-area");
      const omikujiOverlay = document.getElementById("omikuji-overlay");
      const resultImage = document.getElementById("result-image");
      const closeOmikuji = document.getElementById("close-omikuji");
      const failOverlay = document.getElementById("fail-overlay");
      const failReason = document.getElementById("fail-reason");
      const closeFail = document.getElementById("close-fail");
      const successLight = document.getElementById("success-light");
      const catCharacter = document.getElementById("cat-character");
      const dogCharacter = document.getElementById("dog-character");
      const scoreElement = document.getElementById("score");

      let handLandmarker = null;
      let lastVideoTime = -1;

      // „Ç≤„Éº„É†Áä∂ÊÖã
      let handYHistory = [];
      let handXHistory = [];
      const historyLength = 10;
      let canThrow = true;
      let throwCooldown = false;
      let score = 0;
      let throwCount = 0;

      // Áå´„ÅÆÈÇ™È≠îÊ©üËÉΩ
      let catActive = false;
      let catBlockingActive = false;

      // Áä¨„ÅÆÈÇ™È≠îÊ©üËÉΩ
      let dogActive = false;
      let dogBlockingActive = false;

      // ÈÇ™È≠î„Ç≠„É£„É©„ÅÆÂá∫ÁèæÈ†ªÂ∫¶Ôºà„Åã„Å™„ÇäÈ´ò„ÇÅÔºâ
      let interferenceChance = 0.7;

      // ÁµêÊûúÁîªÂÉèÔºà10ÊûöÔºâ
      const resultImages = [
        "osaisen-images/result01.jpg",
        "osaisen-images/result02.jpg",
        "osaisen-images/result03.jpg",
        "osaisen-images/result04.jpg",
        "osaisen-images/result05.jpg",
        "osaisen-images/result06.jpg",
        "osaisen-images/result07.jpg",
        "osaisen-images/result08.jpg",
        "osaisen-images/result09.jpg",
        "osaisen-images/result10.jpg",
      ];

      // „Ç≥„Ç§„É≥„ÇíÊ®™Âèñ„Çä„Åô„ÇãÂãïÁâ©„ÅÆÊÉÖÂ†±
      let interceptor = null; // { type: 'cat' | 'dog', timing: number, x: number, y: number }

      // Áå´„Åå„Ç∏„É£„É≥„Éó„Åó„Å¶„Ç≥„Ç§„É≥„ÇíÂèñ„Çã
      function catIntercept(targetX, targetY, callback) {
        catActive = true;

        // Áå´„ÅÆÈñãÂßã‰ΩçÁΩÆÔºàÂ∑¶Âè≥„É©„É≥„ÉÄ„É†Ôºâ
        const fromLeft = Math.random() < 0.5;
        const startX = fromLeft ? targetX - 150 : targetX + 150;

        catCharacter.style.left = `${startX}px`;
        catCharacter.style.bottom = "auto";
        catCharacter.style.top = `${targetY + 50}px`;
        catCharacter.style.transform = fromLeft ? "scaleX(1)" : "scaleX(-1)";

        catCharacter.classList.add("active");

        // „Ç∏„É£„É≥„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        setTimeout(() => {
          catCharacter.style.transition = "all 0.3s ease-out";
          catCharacter.style.left = `${targetX - 60}px`;
          catCharacter.style.top = `${targetY - 30}px`;
          catBlockingActive = true;
        }, 50);

        // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„Ç≥„Ç§„É≥„ÇíÂèñ„Å£„ÅüÔºâ
        setTimeout(() => {
          callback();
        }, 300);

        // Áå´„ÅåÂéª„Çã
        setTimeout(() => {
          catCharacter.style.transition = "all 0.4s ease-in";
          catCharacter.style.top = `${targetY + 200}px`;
          catCharacter.style.opacity = "0";
        }, 600);

        setTimeout(() => {
          catCharacter.classList.remove("active");
          catCharacter.style.transition = "";
          catCharacter.style.opacity = "";
          catCharacter.style.transform = "";
          catActive = false;
          catBlockingActive = false;
        }, 1000);
      }

      // Áä¨„Åå„Ç∏„É£„É≥„Éó„Åó„Å¶„Ç≥„Ç§„É≥„ÇíÂèñ„Çã
      function dogIntercept(targetX, targetY, callback) {
        dogActive = true;

        // Áä¨„ÅÆÈñãÂßã‰ΩçÁΩÆÔºàÂ∑¶Âè≥„É©„É≥„ÉÄ„É†Ôºâ
        const fromLeft = Math.random() < 0.5;
        const startX = fromLeft ? targetX - 150 : targetX + 150;

        dogCharacter.style.left = `${startX}px`;
        dogCharacter.style.bottom = "auto";
        dogCharacter.style.top = `${targetY + 50}px`;
        dogCharacter.style.transform = fromLeft ? "scaleX(1)" : "scaleX(-1)";

        dogCharacter.classList.add("active");

        // „Ç∏„É£„É≥„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        setTimeout(() => {
          dogCharacter.style.transition = "all 0.3s ease-out";
          dogCharacter.style.left = `${targetX - 70}px`;
          dogCharacter.style.top = `${targetY - 30}px`;
          dogBlockingActive = true;
        }, 50);

        // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„Ç≥„Ç§„É≥„ÇíÂèñ„Å£„ÅüÔºâ
        setTimeout(() => {
          callback();
        }, 300);

        // Áä¨„ÅåÂéª„Çã
        setTimeout(() => {
          dogCharacter.style.transition = "all 0.4s ease-in";
          dogCharacter.style.top = `${targetY + 200}px`;
          dogCharacter.style.opacity = "0";
        }, 600);

        setTimeout(() => {
          dogCharacter.classList.remove("active");
          dogCharacter.style.transition = "";
          dogCharacter.style.opacity = "";
          dogCharacter.style.transform = "";
          dogActive = false;
          dogBlockingActive = false;
        }, 1000);
      }

      // „Åä„Åø„Åè„Åò„ÇíÈñâ„Åò„Çã
      closeOmikuji.addEventListener("click", () => {
        omikujiOverlay.classList.remove("show");
        canThrow = true;
      });

      // Â§±Êïó„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      closeFail.addEventListener("click", () => {
        failOverlay.classList.remove("show");
        canThrow = true;
        throwCooldown = false;
      });

      // MediaPipeÂàùÊúüÂåñ
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.7,
          minHandPresenceConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });

        console.log("Hand LandmarkerÂàùÊúüÂåñÂÆå‰∫Ü");
      }

      // ÊàêÂäüÊôÇ„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà
      function triggerSuccessEffect(x, y) {
        successLight.classList.add("active");
        setTimeout(() => successLight.classList.remove("active"), 1000);

        // ÂÖâ„ÅÆÁ≤íÂ≠ê„ÇíÁîüÊàê
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const particle = document.createElement("div");
            particle.className = "light-particle";
            particle.style.left = `${x + (Math.random() - 0.5) * 200}px`;
            particle.style.top = `${y + Math.random() * 50}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
          }, i * 50);
        }
      }

      // Â∞èÈä≠„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÂº∑„Åï„Å®ÊñπÂêë„Å´ÂØæÂøúÔºâ
      // power: 0.5„Äú1.5ÔºàÂº±„ÄúÂº∑Ôºâ
      // direction: -1„Äú+1ÔºàÂ∑¶„ÄúÂè≥Ôºâ
      function throwCoin(startX, startY, power = 1, direction = 0) {
        throwCount++;

        const coin = document.createElement("div");
        coin.className = "coin";
        coin.textContent = "ü™ô";
        coin.style.left = `${startX}px`;
        coin.style.top = `${startY}px`;
        document.body.appendChild(coin);

        // Ë≥ΩÈä≠ÁÆ±„ÅÆ‰ΩçÁΩÆ
        const boxRect = saisenboxArea.getBoundingClientRect();
        const boxCenterX = boxRect.left + boxRect.width / 2;
        const boxCenterY = boxRect.top + 30;

        // Âº∑„Åï„Å´Âøú„Åò„ÅüÂºß„ÅÆÈ´ò„Åï
        const arcHeight = 80 + power * 100;

        // Âº∑„Åï„Å´Âøú„Åò„ÅüÈ£õË∑ùÈõ¢
        const distanceMultiplier = 0.5 + power * 0.5;

        // ÊñπÂêë„Å´Âøú„Åò„ÅüÊ®™„Åö„Çå
        const horizontalOffset = direction * 120;

        // ÊúÄÁµÇÁùÄÂú∞ÁÇπ„ÇíË®àÁÆó
        const finalLandX = boxCenterX + horizontalOffset;
        const finalLandY = boxCenterY + (1 - distanceMultiplier) * 150;

        // ÂΩì„Åü„ÇäÂà§ÂÆö
        const hitBoxLeft = boxRect.left + 30;
        const hitBoxRight = boxRect.right - 30;
        const isOnTargetX = finalLandX >= hitBoxLeft - 30 && finalLandX <= hitBoxRight + 30;
        const isOnTargetY = power >= 0.6 && power <= 1.4;
        const isOnTarget = isOnTargetX && isOnTargetY;

        // Â§±ÊïóÁêÜÁî±
        let missReason = "";
        if (!isOnTargetX) {
          missReason = direction > 0 ? "Âè≥„Å´„Åö„Çå„ÅüÔºÅ" : "Â∑¶„Å´„Åö„Çå„ÅüÔºÅ";
        } else if (power < 0.6) {
          missReason = "Âº±„Åô„Åé„ÅüÔºÅ";
        } else if (power > 1.4) {
          missReason = "Âº∑„Åô„Åé„ÅüÔºÅ";
        }

        // ÂãïÁâ©„ÅåÊ®™Âèñ„Çä„Åô„Çã„Åã„Å©„ÅÜ„ÅãÔºàÊàêÂäüÊôÇ„ÅÆ„ÅøÁô∫Âãï„ÄÅ70%„ÅÆÁ¢∫ÁéáÔºâ
        const willIntercept = isOnTarget && Math.random() < interferenceChance;
        const interceptType = Math.random() < 0.5 ? "cat" : "dog";
        const interceptTiming = 0.4 + Math.random() * 0.3; // 40%„Äú70%„ÅÆ‰ΩçÁΩÆ„ÅßÊ®™Âèñ„Çä
        let intercepted = false;
        let interceptTriggered = false;

        // ÊîæÁâ©Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const duration = 500 + (1.5 - power) * 300;
        const rotation = 360 + power * 540;
        const startTime = Date.now();

        function animateCoin() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // ÊîæÁâ©Á∑ö„ÅÆË®àÁÆó
          const x = startX + (finalLandX - startX) * progress;
          const y = startY + (finalLandY - startY) * progress - Math.sin(progress * Math.PI) * arcHeight;

          coin.style.left = `${x}px`;
          coin.style.top = `${y}px`;
          coin.style.transform = `rotate(${progress * rotation}deg) scale(${1 - progress * 0.3})`;

          // Ê®™Âèñ„Çä„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞
          if (willIntercept && !interceptTriggered && progress >= interceptTiming) {
            interceptTriggered = true;
            const interceptX = x;
            const interceptY = y;

            if (interceptType === "cat") {
              catIntercept(interceptX, interceptY, () => {
                intercepted = true;
                coin.remove();
                showMissEffect(interceptX, interceptY, "Áå´„Å´Âèñ„Çâ„Çå„ÅüÔºÅ");
              });
            } else {
              dogIntercept(interceptX, interceptY, () => {
                intercepted = true;
                coin.remove();
                showMissEffect(interceptX, interceptY, "Áä¨„Å´Âèñ„Çâ„Çå„ÅüÔºÅ");
              });
            }
          }

          if (intercepted) {
            return; // Ê®™Âèñ„Çä„Åï„Çå„Åü„Çâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫Ü
          }

          if (progress < 1) {
            requestAnimationFrame(animateCoin);
          } else {
            coin.remove();

            // Ê®™Âèñ„Çä„Åå„Éà„É™„Ç¨„Éº„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÊàêÂäüÂà§ÂÆö„Åó„Å™„ÅÑ
            if (interceptTriggered) {
              return;
            }

            if (!isOnTarget) {
              // Ë≥ΩÈä≠ÁÆ±„ÇíÂ§ñ„Åó„Åü
              showMissEffect(finalLandX, finalLandY, missReason);
            } else {
              // ÊàêÂäüÔºÅ
              createSparkles(boxCenterX, boxCenterY);
              triggerSuccessEffect(boxCenterX, boxCenterY);

              const accuracy = 1 - Math.abs(power - 1) * 2;
              const bonus = Math.floor(accuracy * 15);
              score += 10 + bonus;
              if (scoreElement) scoreElement.textContent = score;

              setTimeout(() => {
                showOmikuji();
              }, 500);
            }
          }
        }

        animateCoin();
      }

      // Â§±Êïó„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      function showMissEffect(x, y, reason) {
        failReason.textContent = reason;
        failOverlay.classList.add("show");
      }

      // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà
      function createSparkles(x, y) {
        const colors = ["#ffd700", "#ffec8b", "#fff", "#ffa500", "#ff6347"];
        for (let i = 0; i < 20; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          const size = 5 + Math.random() * 10;
          const color = colors[Math.floor(Math.random() * colors.length)];
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          particle.style.setProperty("--tx", `${(Math.random() - 0.5) * 200}px`);
          particle.style.setProperty("--ty", `${(Math.random() - 0.5) * 200}px`);
          document.body.appendChild(particle);
          setTimeout(() => particle.remove(), 1000);
        }
      }

      // ÁµêÊûúÁîªÂÉè„ÇíË°®Á§∫
      function showOmikuji() {
        const randomIndex = Math.floor(Math.random() * resultImages.length);
        const imagePath = resultImages[randomIndex] + "?t=" + Date.now();
        console.log("ÈÅ∏„Å∞„Çå„ÅüÁîªÂÉè:", randomIndex + 1, imagePath);
        resultImage.src = imagePath;
        omikujiOverlay.classList.add("show");
      }

      // Êâã„ÅÆÂãï„Åç„ÇíÂá¶ÁêÜ
      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
          drawHandSkeleton(landmarks);

          // ÊâãÈ¶ñ„ÅÆ‰ΩçÁΩÆÔºàlandmark 0Ôºâ
          const wrist = landmarks[0];
          const handX = (1.0 - wrist.x) * window.innerWidth;
          const handY = wrist.y * window.innerHeight;

          // Êâã„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÁßªÂãï
          handIndicator.style.left = `${handX}px`;
          handIndicator.style.top = `${handY}px`;
          handIndicator.style.display = "block";

          // X,YÂ∫ßÊ®ô„ÅÆÂ±•Ê≠¥„ÇíË®òÈå≤
          handYHistory.push(handY);
          handXHistory.push(handX);
          if (handYHistory.length > historyLength) {
            handYHistory.shift();
            handXHistory.shift();
          }

          // ÊåØ„Çä‰∏ã„Çç„Åó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÊ§úÂá∫
          if (handYHistory.length >= historyLength && canThrow && !throwCooldown) {
            const firstY = handYHistory[0];
            const lastY = handYHistory[handYHistory.length - 1];
            const firstX = handXHistory[0];
            const lastX = handXHistory[handXHistory.length - 1];

            const movementY = lastY - firstY; // ‰∏ãÊñπÂêë„ÅÆÁßªÂãïÈáè
            const movementX = lastX - firstX; // Â∑¶Âè≥„ÅÆÁßªÂãïÈáèÔºàÂè≥„Åå„Éó„É©„ÇπÔºâ

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫
            console.log(`Y: ${movementY.toFixed(0)}px, X: ${movementX.toFixed(0)}px`);

            // ‰∏ä„Åã„Çâ‰∏ã„Å∏„ÅÆÂãï„ÅçÔºà100px‰ª•‰∏äÔºâ„ÇíÊ§úÂá∫
            if (movementY > 100 && firstY < window.innerHeight * 0.5) {
              canThrow = false;
              throwCooldown = true;

              // Êäï„Åí„ÅÆÂº∑„Åï„ÇíË®àÁÆóÔºà100„Äú400px„ÅÆÂãï„Åç„Çí0.5„Äú1.5„Å´Â§âÊèõÔºâ
              const throwPower = Math.min(Math.max(movementY / 200, 0.5), 1.5);

              // Êäï„Åí„ÅÆÊñπÂêë„ÇíË®àÁÆóÔºà-200„Äú+200px„ÅÆÂãï„Åç„Çí-1„Äú+1„Å´Â§âÊèõÔºâ
              const throwDirection = Math.min(Math.max(movementX / 200, -1), 1);

              if (status) {
                status.textContent = `Êäï„Åí„ÅüÔºÅüí™${(throwPower * 100).toFixed(0)}%`;
                status.className = "throwing";
              }

              // Â∞èÈä≠„ÇíÊäï„Åí„ÇãÔºàÂº∑„Åï„Å®ÊñπÂêë„ÇíÊ∏°„ÅôÔºâ
              throwCoin(handX, handY, throwPower, throwDirection);

              // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥
              setTimeout(() => {
                throwCooldown = false;
              }, 3000);
            }
          }

          // Êâã„Åå‰∏ä„Å´„ÅÇ„Çã„Å®„Åç
          if (handY < window.innerHeight * 0.5 && canThrow) {
            const currentMovement =
              handYHistory.length > 1 ? handYHistory[handYHistory.length - 1] - handYHistory[0] : 0;
            if (status) {
              status.textContent = `Ê∫ñÂÇôOKÔºÅÊåØ„Çä‰∏ã„Çç„Åó„Å¶ÔºÅ(${Math.max(0, currentMovement).toFixed(0)}px)`;
              status.className = "active";
            }
          } else if (canThrow && !throwCooldown) {
            if (status) {
              status.textContent = "Êâã„Çí‰∏ä„Å´‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ";
              status.className = "";
            }
          }
        } else {
          handIndicator.style.display = "none";
          if (canThrow && status) {
            status.textContent = "Êâã„ÅåË¶ã„Åà„Åæ„Åõ„Çì...";
            status.className = "";
          }
          handYHistory = [];
          handXHistory = [];
        }

        canvasCtx.restore();
      }

      // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
      function drawHandSkeleton(landmarks) {
        canvasCtx.strokeStyle = "#ffd700";
        canvasCtx.lineWidth = 2;

        const connections = [
          [0, 1],
          [1, 2],
          [2, 3],
          [3, 4],
          [0, 5],
          [5, 6],
          [6, 7],
          [7, 8],
          [0, 9],
          [9, 10],
          [10, 11],
          [11, 12],
          [0, 13],
          [13, 14],
          [14, 15],
          [15, 16],
          [0, 17],
          [17, 18],
          [18, 19],
          [19, 20],
          [5, 9],
          [9, 13],
          [13, 17],
        ];

        connections.forEach(([start, end]) => {
          const startPoint = landmarks[start];
          const endPoint = landmarks[end];
          canvasCtx.beginPath();
          canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
          canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
          canvasCtx.stroke();
        });

        landmarks.forEach((landmark) => {
          const x = landmark.x * canvasElement.width;
          const y = landmark.y * canvasElement.height;
          canvasCtx.beginPath();
          canvasCtx.arc(x, y, 4, 0, 2 * Math.PI);
          canvasCtx.fillStyle = "#ffd700";
          canvasCtx.fill();
        });
      }

      // „Ç´„É°„É©Ëµ∑Âãï
      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "„Ç´„É°„É©API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            console.log("„Ç´„É°„É©Ëµ∑ÂãïÂÆå‰∫Ü");

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          console.error("„Ç´„É°„É©„Ç®„É©„Éº:", error);
          loading.querySelector("p").textContent = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó: " + error.message;
        }
      }

      startCamera();
    </script>
  </body>
</html>
