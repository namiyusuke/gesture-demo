<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„ÅäË≥ΩÈä≠„Ç∏„Çß„Çπ„ÉÅ„É£„Éº - „Åä„Åø„Åè„Åò</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Hiragino Kaku Gothic ProN", "„É°„Ç§„É™„Ç™", sans-serif;
        background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      #video-container {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 280px;
        height: 210px;
        border: 3px solid #ffd700;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        background: #000;
        z-index: 1000;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* Á•ûÁ§æ„ÅÆËÉåÊôØ */
      #shrine {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
      }

      /* È≥•Â±Ö */
      #torii {
        font-size: 200px;
        color: #c41e3a;
        text-shadow: 0 0 30px rgba(196, 30, 58, 0.5);
        margin-bottom: -30px;
      }

      /* Ë≥ΩÈä≠ÁÆ± */
      #saisenbox {
        width: 300px;
        height: 120px;
        background: linear-gradient(180deg, #8b4513 0%, #654321 50%, #4a3218 100%);
        border: 4px solid #daa520;
        border-radius: 8px 8px 0 0;
        margin: 0 auto;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      #saisenbox::before {
        content: "Ë≥ΩÈä≠";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        color: #ffd700;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      #saisenbox::after {
        content: "";
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 15px;
        background: #1a1a1a;
        border-radius: 2px;
      }

      /* Èà¥ */
      #bell {
        font-size: 80px;
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        transition: transform 0.1s;
      }

      #bell.ringing {
        animation: ring 0.5s ease-in-out;
      }

      @keyframes ring {
        0%, 100% { transform: translateX(-50%) rotate(0deg); }
        20% { transform: translateX(-50%) rotate(15deg); }
        40% { transform: translateX(-50%) rotate(-15deg); }
        60% { transform: translateX(-50%) rotate(10deg); }
        80% { transform: translateX(-50%) rotate(-10deg); }
      }

      /* Êâã„ÅÆ‰ΩçÁΩÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
      #hand-indicator {
        position: fixed;
        width: 60px;
        height: 60px;
        font-size: 50px;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        transition: transform 0.05s;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      /* Â∞èÈä≠ */
      .coin {
        position: fixed;
        font-size: 40px;
        pointer-events: none;
        z-index: 500;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
      }

      /* „Åä„Åø„Åè„Åò */
      #omikuji-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #omikuji-overlay.show {
        display: flex;
        opacity: 1;
      }

      #omikuji-paper {
        background: linear-gradient(180deg, #fff8e7 0%, #f5e6c8 100%);
        width: 200px;
        padding: 40px 30px;
        border-radius: 4px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0) rotate(-10deg);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      #omikuji-overlay.show #omikuji-paper {
        transform: scale(1) rotate(0deg);
      }

      #omikuji-result {
        font-size: 72px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      #omikuji-message {
        font-size: 16px;
        color: #333;
        line-height: 1.8;
      }

      #close-omikuji {
        margin-top: 30px;
        padding: 10px 30px;
        font-size: 16px;
        background: #c41e3a;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
      }

      #close-omikuji:hover {
        background: #a01830;
      }

      /* Ë™¨Êòé„Éë„Éç„É´ */
      #info {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        max-width: 280px;
        z-index: 1000;
      }

      #info h2 {
        margin-bottom: 10px;
        color: #c41e3a;
        font-size: 20px;
      }

      #info p {
        margin: 8px 0;
        color: #333;
        font-size: 14px;
        line-height: 1.5;
      }

      #status {
        margin-top: 12px;
        padding: 8px 12px;
        background: #f0f0f0;
        border-radius: 6px;
        font-weight: bold;
        color: #666;
        text-align: center;
      }

      #status.active {
        background: #d4edda;
        color: #155724;
      }

      #status.throwing {
        background: #fff3cd;
        color: #856404;
      }

      /* „Ç≤„Éº„Ç∏ */
      #throw-gauge {
        margin-top: 10px;
        height: 10px;
        background: #ddd;
        border-radius: 5px;
        overflow: hidden;
      }

      #throw-gauge-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ffd700, #ff6b6b);
        transition: width 0.1s;
      }

      /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 10000;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #c41e3a;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà */
      .sparkle {
        position: fixed;
        pointer-events: none;
        font-size: 30px;
        animation: sparkle 1s ease-out forwards;
        z-index: 1500;
      }

      @keyframes sparkle {
        0% {
          opacity: 1;
          transform: scale(0) rotate(0deg);
        }
        50% {
          opacity: 1;
          transform: scale(1.2) rotate(180deg);
        }
        100% {
          opacity: 0;
          transform: scale(0.5) rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p>„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...</p>
    </div>

    <div id="container">
      <div id="info">
        <h2>‚õ©Ô∏è „ÅäË≥ΩÈä≠„Ç∏„Çß„Çπ„ÉÅ„É£„Éº</h2>
        <p>‚úã <strong>Êâã„Çí‰∏ä„Å´‰∏ä„Åí„Å¶</strong>Ê∫ñÂÇô</p>
        <p>üëá <strong>Êâã„ÇíÊåØ„Çä‰∏ã„Çç„Åô</strong>„Å®„ÅäË≥ΩÈä≠„ÇíÊäï„Åí„Åæ„Åô</p>
        <p>üîî Èà¥„ÅåÈ≥¥„Å£„Å¶„Åä„Åø„Åè„Åò„ÅåÂá∫„Åæ„ÅôÔºÅ</p>
        <div id="status">ÂæÖÊ©ü‰∏≠...</div>
        <div id="throw-gauge">
          <div id="throw-gauge-fill"></div>
        </div>
      </div>

      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <div id="hand-indicator">‚úã</div>

      <div id="shrine">
        <div id="bell">üîî</div>
        <div id="torii">‚õ©Ô∏è</div>
        <div id="saisenbox"></div>
      </div>
    </div>

    <!-- „Åä„Åø„Åè„Åò„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="omikuji-overlay">
      <div id="omikuji-paper">
        <div id="omikuji-result"></div>
        <div id="omikuji-message"></div>
        <button id="close-omikuji">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âºï„Åè</button>
      </div>
    </div>

    <!-- Èà¥„ÅÆÈü≥ÔºàWeb Audio APIÔºâ -->
    <script>
      // Èà¥„ÅÆÈü≥„ÇíÁîüÊàê
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBellSound() {
        const oscillator1 = audioCtx.createOscillator();
        const oscillator2 = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator1.type = 'sine';
        oscillator1.frequency.setValueAtTime(2000, audioCtx.currentTime);
        oscillator1.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.5);

        oscillator2.type = 'sine';
        oscillator2.frequency.setValueAtTime(3000, audioCtx.currentTime);
        oscillator2.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.5);

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);

        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator1.start();
        oscillator2.start();
        oscillator1.stop(audioCtx.currentTime + 1);
        oscillator2.stop(audioCtx.currentTime + 1);
      }

      function playCoinSound() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
      }
    </script>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const handIndicator = document.getElementById("hand-indicator");
      const status = document.getElementById("status");
      const loading = document.getElementById("loading");
      const bell = document.getElementById("bell");
      const saisenbox = document.getElementById("saisenbox");
      const omikujiOverlay = document.getElementById("omikuji-overlay");
      const omikujiResult = document.getElementById("omikuji-result");
      const omikujiMessage = document.getElementById("omikuji-message");
      const closeOmikuji = document.getElementById("close-omikuji");
      const throwGaugeFill = document.getElementById("throw-gauge-fill");

      let handLandmarker = null;
      let lastVideoTime = -1;

      // „Ç∏„Çß„Çπ„ÉÅ„É£„ÉºÊ§úÂá∫Áî®
      let handYHistory = [];
      const historyLength = 10;
      let canThrow = true;
      let throwCooldown = false;

      // „Åä„Åø„Åè„Åò„Éá„Éº„Çø
      const omikujiData = [
        { result: "Â§ßÂêâ", color: "#ff0000", message: "ÊúÄÈ´ò„ÅÆÈÅãÂã¢ÔºÅ\nÈ°ò„ÅÑ‰∫ã„ÅåÂè∂„ÅÜ„Åß„Åó„Çá„ÅÜ„ÄÇ\nÁ©çÊ•µÁöÑ„Å´Ë°åÂãï„Çí„ÄÇ" },
        { result: "‰∏≠Âêâ", color: "#ff6600", message: "ËâØ„ÅÑÈÅãÂã¢„Åß„Åô„ÄÇ\nÂä™Âäõ„ÅåÂÆü„ÇíÁµê„Å≥„Åæ„Åô„ÄÇ\nÁÑ¶„Çâ„ÅöÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
        { result: "Â∞èÂêâ", color: "#ffcc00", message: "„Åæ„Åö„Åæ„Åö„ÅÆÈÅãÂã¢„ÄÇ\nÂ∞è„Åï„Å™Âπ∏„Åõ„ÇíÂ§ßÂàá„Å´„ÄÇ\nÊÑüË¨ù„ÇíÂøò„Çå„Åö„Å´„ÄÇ" },
        { result: "Âêâ", color: "#33cc33", message: "ÊôÆÈÄö„ÅÆÈÅãÂã¢„ÄÇ\nÂπ≥Á©è„Å™Êó•„ÄÖ„ÅåÁ∂ö„Åç„Åæ„Åô„ÄÇ\nÂÅ•Â∫∑„Å´Ê≥®ÊÑè„Çí„ÄÇ" },
        { result: "Êú´Âêâ", color: "#3399ff", message: "„Åì„Çå„Åã„Çâ‰∏äÂêë„Åç„ÄÇ\nËæõÊä±Âº∑„ÅèÂæÖ„Å¶„Å∞\nËâØ„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ" },
        { result: "Âá∂", color: "#9933ff", message: "Ê≥®ÊÑè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\nÊÖéÈáç„Å´Ë°åÂãï„Åó\nÁÑ°ÁêÜ„ÅØÁ¶ÅÁâ©„ÄÇ" },
      ];

      // „Åä„Åø„Åè„Åò„ÇíÈñâ„Åò„Çã
      closeOmikuji.addEventListener("click", () => {
        omikujiOverlay.classList.remove("show");
        canThrow = true;
      });

      // MediaPipeÂàùÊúüÂåñ
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.7,
          minHandPresenceConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });

        console.log("Hand LandmarkerÂàùÊúüÂåñÂÆå‰∫Ü");
      }

      // Â∞èÈä≠„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      function throwCoin(startX, startY) {
        const coin = document.createElement("div");
        coin.className = "coin";
        coin.textContent = "ü™ô";
        coin.style.left = `${startX}px`;
        coin.style.top = `${startY}px`;
        document.body.appendChild(coin);

        // Ë≥ΩÈä≠ÁÆ±„ÅÆ‰ΩçÁΩÆ
        const boxRect = saisenbox.getBoundingClientRect();
        const targetX = boxRect.left + boxRect.width / 2;
        const targetY = boxRect.top + 30;

        // ÊîæÁâ©Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const duration = 800;
        const startTime = Date.now();

        function animateCoin() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // ÊîæÁâ©Á∑ö„ÅÆË®àÁÆó
          const x = startX + (targetX - startX) * progress;
          const y = startY + (targetY - startY) * progress - Math.sin(progress * Math.PI) * 150;

          coin.style.left = `${x}px`;
          coin.style.top = `${y}px`;
          coin.style.transform = `rotate(${progress * 720}deg)`;

          if (progress < 1) {
            requestAnimationFrame(animateCoin);
          } else {
            // ÁùÄÂú∞
            playCoinSound();
            coin.remove();

            // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
            createSparkles(targetX, targetY);

            // Èà¥„ÇíÈ≥¥„Çâ„Åô
            setTimeout(() => {
              bell.classList.add("ringing");
              playBellSound();
              setTimeout(() => bell.classList.remove("ringing"), 500);

              // „Åä„Åø„Åè„ÅòË°®Á§∫
              setTimeout(showOmikuji, 800);
            }, 300);
          }
        }

        animateCoin();
      }

      // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
      function createSparkles(x, y) {
        const sparkles = ["‚ú®", "‚≠ê", "üí´"];
        for (let i = 0; i < 8; i++) {
          const sparkle = document.createElement("div");
          sparkle.className = "sparkle";
          sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
          sparkle.style.left = `${x + (Math.random() - 0.5) * 100}px`;
          sparkle.style.top = `${y + (Math.random() - 0.5) * 100}px`;
          document.body.appendChild(sparkle);
          setTimeout(() => sparkle.remove(), 1000);
        }
      }

      // „Åä„Åø„Åè„ÅòË°®Á§∫
      function showOmikuji() {
        const fortune = omikujiData[Math.floor(Math.random() * omikujiData.length)];
        omikujiResult.textContent = fortune.result;
        omikujiResult.style.color = fortune.color;
        omikujiMessage.textContent = fortune.message;
        omikujiOverlay.classList.add("show");
      }

      // Êâã„ÅÆÂãï„Åç„ÇíÂá¶ÁêÜ
      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
          drawHandSkeleton(landmarks);

          // ÊâãÈ¶ñ„ÅÆ‰ΩçÁΩÆÔºàlandmark 0Ôºâ
          const wrist = landmarks[0];
          const handX = (1.0 - wrist.x) * window.innerWidth;
          const handY = wrist.y * window.innerHeight;

          // Êâã„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÁßªÂãï
          handIndicator.style.left = `${handX}px`;
          handIndicator.style.top = `${handY}px`;
          handIndicator.style.display = "block";

          // YÂ∫ßÊ®ô„ÅÆÂ±•Ê≠¥„ÇíË®òÈå≤
          handYHistory.push(handY);
          if (handYHistory.length > historyLength) {
            handYHistory.shift();
          }

          // ÊåØ„Çä‰∏ã„Çç„Åó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÊ§úÂá∫
          if (handYHistory.length >= historyLength && canThrow && !throwCooldown) {
            const firstY = handYHistory[0];
            const lastY = handYHistory[handYHistory.length - 1];
            const movement = lastY - firstY;

            // „Ç≤„Éº„Ç∏„ÇíÊõ¥Êñ∞
            const gaugeProgress = Math.min(Math.max(movement / 200, 0), 1) * 100;
            throwGaugeFill.style.width = `${gaugeProgress}%`;

            // ‰∏ä„Åã„Çâ‰∏ã„Å∏„ÅÆÂ§ß„Åç„Å™Âãï„ÅçÔºà200px‰ª•‰∏äÔºâ„ÇíÊ§úÂá∫
            if (movement > 200 && firstY < window.innerHeight * 0.4) {
              canThrow = false;
              throwCooldown = true;
              status.textContent = "Êäï„Åí„ÅüÔºÅü™ô";
              status.className = "throwing";

              // Â∞èÈä≠„ÇíÊäï„Åí„Çã
              throwCoin(handX, handY);

              // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥
              setTimeout(() => {
                throwCooldown = false;
                throwGaugeFill.style.width = "0%";
              }, 3000);
            }
          }

          // Êâã„Åå‰∏ä„Å´„ÅÇ„Çã„Å®„Åç
          if (handY < window.innerHeight * 0.4 && canThrow) {
            status.textContent = "Ê∫ñÂÇôOKÔºÅÊåØ„Çä‰∏ã„Çç„Åó„Å¶ÔºÅ";
            status.className = "active";
          } else if (canThrow && !throwCooldown) {
            status.textContent = "Êâã„Çí‰∏ä„Å´‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ";
            status.className = "";
          }

        } else {
          handIndicator.style.display = "none";
          status.textContent = "Êâã„ÅåË¶ã„Åà„Åæ„Åõ„Çì...";
          status.className = "";
          handYHistory = [];
        }

        canvasCtx.restore();
      }

      // Êâã„ÅÆÈ™®Ê†º„ÇíÊèèÁîª
      function drawHandSkeleton(landmarks) {
        canvasCtx.strokeStyle = "#ffd700";
        canvasCtx.lineWidth = 2;

        const connections = [
          [0, 1], [1, 2], [2, 3], [3, 4],
          [0, 5], [5, 6], [6, 7], [7, 8],
          [0, 9], [9, 10], [10, 11], [11, 12],
          [0, 13], [13, 14], [14, 15], [15, 16],
          [0, 17], [17, 18], [18, 19], [19, 20],
          [5, 9], [9, 13], [13, 17],
        ];

        connections.forEach(([start, end]) => {
          const startPoint = landmarks[start];
          const endPoint = landmarks[end];
          canvasCtx.beginPath();
          canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
          canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
          canvasCtx.stroke();
        });

        landmarks.forEach((landmark) => {
          const x = landmark.x * canvasElement.width;
          const y = landmark.y * canvasElement.height;
          canvasCtx.beginPath();
          canvasCtx.arc(x, y, 4, 0, 2 * Math.PI);
          canvasCtx.fillStyle = "#ffd700";
          canvasCtx.fill();
        });
      }

      // „Ç´„É°„É©Ëµ∑Âãï
      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "„Ç´„É°„É©API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            console.log("„Ç´„É°„É©Ëµ∑ÂãïÂÆå‰∫Ü");

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          console.error("„Ç´„É°„É©„Ç®„É©„Éº:", error);
          loading.querySelector("p").textContent = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó: " + error.message;
        }
      }

      startCamera();
    </script>
  </body>
</html>
