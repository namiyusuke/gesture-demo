<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°„çš„ã‚²ãƒ¼ãƒ  - çš„ã‚’ã­ã‚‰ãˆï¼</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: #fff;
        min-height: 100vh;
        overflow: hidden;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background-image: url("shooting_game-images/shooting-bg.png");
        background-size: contain;
        background-position: center calc(100 / 1440 * 100vw);
        background-repeat: no-repeat;
      }

      /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã‚’å›ºå®šã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã§è¡¨ç¤º */
      #game-area {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        aspect-ratio: 4 / 3;
        max-width: 100vw;
        max-height: 100vh;
        width: 100%;
        height: auto;
      }

      /* ã‚¹ãƒãƒ›å‘ã‘èª¿æ•´ */
      @media (max-width: 768px) {
        #video-container {
          width: 80px !important;
          height: 60px !important;
        }
        #crosshair {
          width: 60px !important;
          height: 60px !important;
        }
      }

      /* ç¸¦é•·ç”»é¢ï¼ˆã‚¹ãƒãƒ›ç¸¦æŒã¡ï¼‰å‘ã‘ */
      @media (max-aspect-ratio: 1/1) {
        #container {
          background-size: 100% auto;
        }
      }

      #game-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      #video-container {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 240px;
        height: 180px;
        border: 3px solid #ffd700;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        background: #000;
        z-index: 1000;
      }

      #input_video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #output_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* ç…§æº–ï¼ˆæŒ‡ã‚«ãƒ¼ã‚½ãƒ«ï¼‰ */
      #crosshair {
        position: fixed;
        width: 100px;
        height: 100px;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        background-image: url("shooting_game-images/target-mouse.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }

      #crosshair.shooting {
        animation: recoil 0.1s ease-out;
      }

      @keyframes recoil {
        0% {
          transform: translate(-50%, -50%) scale(1);
        }
        50% {
          transform: translate(-50%, -50%) scale(1.3);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
        }
      }

      #score {
        font-size: 28px;
        font-weight: bold;
        color: #ffd700;
        margin-top: 10px;
      }

      #ammo {
        font-size: 18px;
        color: #ff6b6b;
        margin-top: 5px;
      }

      #gesture-status {
        margin-top: 10px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 14px;
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 12px;
        border: 2px solid #ffd700;
        text-align: center;
        z-index: 10000;
        color: white;
      }

      #loading.hidden {
        display: none;
      }

      .spinner {
        border: 4px solid #333;
        border-top: 4px solid #ffd700;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ãƒã‚ºãƒ«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
      #muzzle-flash {
        position: fixed;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(255, 200, 0, 0.8) 0%, rgba(255, 100, 0, 0.4) 50%, transparent 70%);
        pointer-events: none;
        z-index: 9998;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: opacity 0.05s;
      }

      #muzzle-flash.flash {
        opacity: 1;
      }

      /* ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
      .hit-effect {
        position: fixed;
        font-size: 30px;
        font-weight: bold;
        color: #ffd700;
        pointer-events: none;
        z-index: 9000;
        animation: hitPop 0.5s ease-out forwards;
      }

      @keyframes hitPop {
        0% {
          transform: translate(-50%, -50%) scale(0);
          opacity: 1;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -80%) scale(1);
          opacity: 0;
        }
      }

      /* ãƒ”ã‚¹ãƒˆãƒ«ã‚¢ã‚¤ã‚³ãƒ³ */
      #pistol-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-size: 60px;
        z-index: 1000;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        transition: transform 0.1s;
      }

      #pistol-indicator.ready {
        color: #ffd700;
      }

      #pistol-indicator.shooting {
        transform: rotate(-20deg);
      }

      /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« */
      #tutorial-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 20000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #tutorial-modal.hidden {
        display: none;
      }

      .tutorial-content {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        color: white;
        border: #fff solid 1px;
      }

      .tutorial-content h1 {
        font-size: 32px;
        color: #fff;
        margin-bottom: 30px;
      }

      .slides-container {
        position: relative;
        width: 100%;
        height: 320px;
        overflow: hidden;
      }

      .slide {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.5s ease,
          transform 0.5s ease;
      }

      .slide.active {
        opacity: 1;
        transform: translateX(0);
      }

      .slide.prev {
        opacity: 0;
        transform: translateX(-100%);
      }
      .slide-subtitle {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .hand-icons {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 25px;
      }

      .hand-icon {
        width: 100px;
        height: 120px;
      }

      .hand-icon svg {
        width: 100%;
        height: 100%;
        fill: white;
      }

      .arrow-icon {
        font-size: 30px;
        color: rgba(255, 255, 255, 0.7);
      }

      .slide-description {
        font-size: 18px;
        line-height: 1.8;
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
      }

      .slide-note {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 15px;
      }

      .slide .icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .slide .text {
        font-size: 20px;
        line-height: 1.6;
        text-align: center;
      }

      .slide .text strong {
        color: #ffd700;
        font-size: 24px;
      }

      .slide-indicators {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 25px 0;
      }

      .slide-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition:
          background 0.3s,
          transform 0.3s;
      }

      .slide-indicator.active {
        background: #ffd700;
        transform: scale(1.2);
      }

      .tutorial-button {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        color: #2a1a0a;
        background: #fff;
        border: none;
        border-radius: 2px;
        cursor: pointer;
      }

      .tutorial-button:active {
        transform: scale(0.98);
      }

      /* ã‚²ãƒ¼ãƒ UIï¼ˆã‚¿ã‚¤ãƒãƒ¼ãƒ»ã‚¹ã‚³ã‚¢ï¼‰ */
      #game-ui {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: none;
      }

      #timer-display {
        font-size: 28px;
        font-weight: bold;
        color: #212121;
        margin-bottom: 10px;
      }

      #timer-display.warning {
        color: #ff4444;
        animation: pulse 0.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      #score-display {
        font-size: 22px;
        font-weight: bold;
        color: #212121;
      }

      /* çµæœç”»é¢ */
      #result-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 20000;
        display: none;
        justify-content: center;
        align-items: center;
      }

      #result-modal.show {
        display: flex;
      }

      .result-content {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        color: white;
        border: #fff solid 1px;
      }

      .result-content h1 {
        font-size: 36px;
        color: #ffd700;
        margin-bottom: 30px;
      }

      .result-score {
        font-size: 72px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 20px;
      }

      .result-label {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 40px;
      }

      .result-button {
        padding: 15px 40px;
        font-size: 20px;
        font-weight: bold;
        color: #2a1a0a;
        background: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .result-button:active {
        transform: scale(0.98);
      }

      @media (max-width: 768px) {
        .tutorial-content {
          padding: 25px;
        }
        .tutorial-content h1 {
          font-size: 24px;
        }
        .slides-container {
          height: 280px;
        }
        .slide-subtitle {
          font-size: 20px;
        }
        .hand-icon {
          width: 70px;
          height: 90px;
        }
        .slide-description {
          font-size: 15px;
        }
        .slide .icon {
          font-size: 60px;
        }
        .slide .text {
          font-size: 16px;
        }
        .slide .text strong {
          font-size: 20px;
        }
        .tutorial-button {
          font-size: 20px;
          padding: 12px 40px;
        }
      }
    </style>
  </head>
  <body>
    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tutorial-modal">
      <div class="tutorial-content">
        <h1>å°„çš„ã‚²ãƒ¼ãƒ </h1>
        <!-- SVGã‚·ãƒ³ãƒœãƒ«å®šç¾© -->
        <svg style="display: none">
          <symbol id="iconHandPoint" viewBox="0 0 343 462">
            <path
              d="M134.481,127.994c17.968-18.744,46.291-12.336,56.471,10.897,21.305-14.465,47.742-1.696,51.531,23.1,13.395-6.933,28.206-2.017,36.962,9.528,9.451,12.46,6.757,41.393,6.984,57.016.628,43.112,1.447,87.798-15.474,128.444-5.608,13.47-14.573,26.124-17.231,40.769-3.612,19.895,1.056,42.323-1.235,61.765-1.043,8.851-11.758,8.477-12.956.919,1.365-24.534-3.597-52.367,3.904-75.97,3.829-12.046,12.009-24.043,16.78-36.22,14.02-35.787,13.476-74.242,13.243-112.242l-6.509,18.976c-7.91,21.438-34.993,24.355-49.119,7.09-14.464,12.716-35.157,11.567-45.895-5.073-10.998,8.723-23.877,11.9-36.789,4.826-5.27-2.887-5.917-5.509-9.384-9.552-.615-.717.035-1.891-2.288-1.266l-2.011,15.992c29.155,3.373,54.41,23.049,63.29,51.219,1.527,4.843,6.125,18.821.695,21.256-11.772,5.28-11.097-11.752-13.708-19.243-7.607-21.826-28.124-35.947-50.03-40.97-5.197-1.192-15.403.671-16.009-6.928-.093-1.169,4.013-12.812,4.513-16.086.712-4.667-.194-13.156,1.76-17.24,1.624-3.393,9.924-3.578,13.297-4.703,18.041-6.022,40.511-17.147,38.192-39.803-.351-3.432-.983-7.443-5.358-6.446-21.376,7.082-46.606,8.381-67.644,15.439-10.198,3.422-12.063,7.658-16.008,16.992-5.171,12.237-20.651,56.611-20.004,67.978.793,13.932,19.66,41.988,27.604,54.453,14.543,22.822,31.762,39.027,33.457,67.543.588,9.883,1.338,43.998-1.286,51.798-1.949,5.796-11.607,5.105-12.693-1.819-2.03-12.944,1.643-30.156.979-43.979-.549-11.41-1.864-21.456-7.621-31.379-17.855-30.779-58.958-72.696-51.977-110.136,4.471-23.979,17.384-54.882,28.501-76.499l.016-162.984c5.326-37.714,54.467-36.138,58.024,2.056l5.026,90.484ZM84.471,34.494v156.5l38.256-7.991,1.568-3.462-8.273-142.598c-3.403-21.805-28.602-20.228-31.551-2.449ZM174.46,183.993c.663-13.151,8.58-34.6.447-45.935-9.055-12.621-30.107-9.858-34.374,5.498-1.621,5.832-2.704,19.48-3.052,25.948-.188,3.485.094,7.011,0,10.49,9.607-2.107,23.701-9.634,32.225-2.016,1.92,1.716,2.294,4.88,4.755,6.015ZM206.204,146.236c-6.278,1.055-12.652,6.431-14.448,12.544-2.572,25.065-10.3,53.885-11.274,78.724-.884,22.537,23.112,27.673,32.04,8.042,2.428-24.048,16.06-54.777,16.96-78.093.506-13.112-10.026-23.442-23.278-21.216ZM252.207,172.234c-6.54,1.062-10.063,4.8-12.21,10.786-4.553,12.694-12.376,47.328-13.413,60.604-1.42,18.178,19.718,22.454,27.439,8.423,3.63-6.597,17.847-53.33,18.386-60.693.838-11.463-8.654-20.994-20.202-19.119ZM168.483,221.002c-3.991,6.952-11.816,13.705-18.97,17.535-2.228,1.193-13.569,4.571-13.03,6.932,10.002,12.139,26.066,8.563,30.505-6.457,1.132-3.831,2.149-10.51,2.47-14.538.087-1.097.738-3.726-.975-3.472Z"
            ></path>
          </symbol>
          <symbol id="iconHandFist" viewBox="0 0 100 100">
            <path
              d="M25 35 Q20 40 20 50 L20 65 Q20 80 35 85 L60 85 Q75 85 80 70 L80 50 Q80 35 65 30 L55 30 Q55 25 50 22 Q45 19 40 22 Q35 25 35 30 L30 30 Q25 30 25 35 Z M30 40 Q30 35 35 35 L40 35 Q40 30 45 28 Q50 26 55 28 Q60 30 60 35 L65 35 Q70 35 72 40 Q75 45 75 50 L75 65 Q75 75 65 78 L40 78 Q30 78 27 70 Q25 65 25 55 L25 45 Q25 40 30 40 Z"
            ></path>
          </symbol>
        </svg>

        <div class="slides-container">
          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰1: ç…§æº–ã®å‹•ã‹ã—æ–¹ -->
          <div class="slide active" data-slide="0">
            <div class="slide-subtitle">ç…§æº–ã®æ“ä½œ</div>
            <div class="hand-icons">
              <div class="hand-icon">
                <svg><use href="#iconHandPoint"></use></svg>
              </div>
            </div>
            <div class="slide-description">äººå·®ã—æŒ‡ã‚’ç«‹ã¦ã¦<br />ç…§æº–ã‚’å‹•ã‹ã—ã¾ã™</div>
          </div>

          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰2: æ’ƒã¡æ–¹ -->
          <div class="slide" data-slide="1">
            <div class="slide-title">ãƒãƒ³ãƒ‰ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã«ã‚ˆã‚‹</div>
            <div class="slide-subtitle">ç™ºå°„</div>
            <div class="hand-icons">
              <div class="hand-icon">
                <svg><use href="#iconHandPoint"></use></svg>
              </div>
              <div class="arrow-icon">â‡¨</div>
              <div class="hand-icon">
                <svg><use href="#iconHandFist"></use></svg>
              </div>
            </div>
            <div class="slide-description">äººå·®ã—æŒ‡ã‚’æ›²ã’ã‚‹ã¨<br />ç™ºå°„ã—ã¾ã™</div>
          </div>

          <!-- ã‚¹ãƒ©ã‚¤ãƒ‰3: éŠã³æ–¹ -->
          <div class="slide" data-slide="2">
            <div class="slide-subtitle">çš„ã‚’æ’ƒã£ã¦éŠã¼ã†ï¼</div>
            <div class="icon">ğŸ¯</div>
            <div class="slide-description">æ£šã®ä¸Šã®çš„ã‚’ç‹™ã£ã¦<br />é«˜å¾—ç‚¹ã‚’ç›®æŒ‡ãã†ï¼</div>
          </div>
        </div>
        <div class="slide-indicators">
          <div class="slide-indicator active" data-slide="0"></div>
          <div class="slide-indicator" data-slide="1"></div>
          <div class="slide-indicator" data-slide="2"></div>
        </div>
        <button id="next-button" class="tutorial-button">æ¬¡ã¸</button>
        <button id="start-button" class="tutorial-button" style="display: none">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div id="loading" class="hidden">
      <div class="spinner"></div>
      <p>ã‚«ãƒ¡ãƒ©ã¨MediaPipeã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div id="container">
      <canvas id="game-canvas"></canvas>

      <div id="video-container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
      </div>

      <div id="crosshair"></div>

      <div id="muzzle-flash"></div>
      <div id="pistol-indicator">â˜ï¸</div>

      <!-- ã‚²ãƒ¼ãƒ UI -->
      <div id="game-ui">
        <div id="timer-display">60</div>
        <div id="score-display">ã‚¹ã‚³ã‚¢: 0</div>
      </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="result-modal">
      <div class="result-content">
        <h1>ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼</h1>
        <div class="result-label">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢</div>
        <div class="result-score" id="final-score">0</div>
        <button class="result-button" id="retry-button">ã‚‚ã†ä¸€åº¦éŠã¶</button>
      </div>
    </div>

    <script type="module">
      import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const crosshair = document.getElementById("crosshair");
      const loading = document.getElementById("loading");
      const gameCanvas = document.getElementById("game-canvas");
      const gameCtx = gameCanvas.getContext("2d");
      const scoreElement = document.getElementById("score");
      const gestureStatus = document.getElementById("gesture-status");
      const muzzleFlash = document.getElementById("muzzle-flash");
      const pistolIndicator = document.getElementById("pistol-indicator");

      let handLandmarker = null;
      let lastVideoTime = -1;
      let smoothX = window.innerWidth / 2;
      let smoothY = window.innerHeight / 2;

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
      let score = 0;
      let targets = [];
      let lastShootTime = 0;
      let gameTime = 60; // åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
      let gameTimerId = null;
      let isGameRunning = false;

      // UIè¦ç´ 
      const gameUI = document.getElementById("game-ui");
      const timerDisplay = document.getElementById("timer-display");
      const scoreDisplay = document.getElementById("score-display");
      const resultModal = document.getElementById("result-modal");
      const finalScoreElement = document.getElementById("final-score");
      const retryButton = document.getElementById("retry-button");

      // ã‚¹ã‚³ã‚¢æ›´æ–°
      function updateScoreDisplay() {
        scoreDisplay.textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
      }

      // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
      function updateTimerDisplay() {
        timerDisplay.textContent = gameTime;
        if (gameTime <= 10) {
          timerDisplay.classList.add("warning");
        } else {
          timerDisplay.classList.remove("warning");
        }
      }

      // ã‚²ãƒ¼ãƒ é–‹å§‹
      function startGame() {
        score = 0;
        gameTime = 60;
        isGameRunning = true;
        gameUI.style.display = "block";
        resultModal.classList.remove("show");
        updateScoreDisplay();
        updateTimerDisplay();
        initTargets();

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        gameTimerId = setInterval(() => {
          gameTime--;
          updateTimerDisplay();
          if (gameTime <= 0) {
            endGame();
          }
        }, 1000);
      }

      // ã‚²ãƒ¼ãƒ çµ‚äº†
      function endGame() {
        isGameRunning = false;
        if (gameTimerId) {
          clearInterval(gameTimerId);
          gameTimerId = null;
        }
        // çµæœç”»é¢ã‚’è¡¨ç¤º
        finalScoreElement.textContent = score;
        resultModal.classList.add("show");
      }

      // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
      retryButton.addEventListener("click", () => {
        startGame();
      });

      // ç™ºå°„æ¤œå‡ºç”¨ï¼ˆäººå·®ã—æŒ‡ã‚’æ›²ã’ã¦ç™ºå°„ï¼‰
      let indexExtendedHistory = []; // äººå·®ã—æŒ‡ã®çŠ¶æ…‹å±¥æ­´
      const HISTORY_LENGTH = 5; // å±¥æ­´ã®é•·ã•
      let canShoot = true; // ç™ºå°„å¯èƒ½ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ï¼‰

      // åŠ¹æœéŸ³ç”¨AudioContext
      let audioContext = null;

      // ã€Œã±ã‚“ã€ã¨ã„ã†åŠ¹æœéŸ³ã‚’ç”Ÿæˆãƒ»å†ç”Ÿ
      function playHitSound() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // ãƒã‚¤ã‚ºã‚’ç”Ÿæˆ
        const bufferSize = audioContext.sampleRate * 0.6; // 0.1ç§’
        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
          // æ¸›è¡°ã™ã‚‹ãƒã‚¤ã‚ºã§ã€Œã±ã‚“ã€ã¨ã„ã†éŸ³ã‚’è¡¨ç¾
          const decay = Math.exp(-i / (bufferSize * 0.1));
          data[i] = (Math.random() * 2 - 1) * decay;
        }

        const source = audioContext.createBufferSource();
        source.buffer = buffer;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§éŸ³è³ªã‚’èª¿æ•´
        const filter = audioContext.createBiquadFilter();
        filter.type = "bandpass";
        filter.frequency.value = 2000;
        filter.Q.value = 1;

        // ã‚²ã‚¤ãƒ³ï¼ˆéŸ³é‡ï¼‰
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0.2;

        source.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);

        source.start();
      }

      // çš„ã®ç¨®é¡ï¼ˆç”»åƒã‚’ä½¿ç”¨ï¼‰- ã‚µã‚¤ã‚ºãŒå°ã•ã„ã»ã©é«˜å¾—ç‚¹ï¼ˆåŸºæº–: 200pxï¼‰
      const targetTypes = [
        { image: "shooting_game-images/target01.png", points: 300, size: 440 },
        { image: "shooting_game-images/target02.png", points: 120, size: 320 },
        { image: "shooting_game-images/target03.png", points: 150, size: 300 },
        { image: "shooting_game-images/target04.png", points: 180, size: 290 },
        { image: "shooting_game-images/target05.png", points: 200, size: 280 },
        { image: "shooting_game-images/target06.png", points: 220, size: 270 },
        { image: "shooting_game-images/target07.png", points: 250, size: 260 },
        { image: "shooting_game-images/target08.png", points: 280, size: 250 },
        { image: "shooting_game-images/target09.png", points: 300, size: 240 },
        { image: "shooting_game-images/target10.png", points: 350, size: 230 },
        { image: "shooting_game-images/target11.png", points: 400, size: 180 },
        { image: "shooting_game-images/target12.png", points: 500, size: 200 },
        { image: "shooting_game-images/target13.png", points: 500, size: 200 },
      ];

      // çš„ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
      const targetImages = {};
      targetTypes.forEach((type) => {
        const img = new Image();
        img.src = type.image;
        targetImages[type.image] = img;
      });

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆé«˜è§£åƒåº¦å¯¾å¿œï¼‰
      let currentDpr = 1;
      function resizeCanvas() {
        currentDpr = window.devicePixelRatio || 1;
        gameCanvas.width = window.innerWidth * currentDpr;
        gameCanvas.height = window.innerHeight * currentDpr;
        gameCanvas.style.width = window.innerWidth + "px";
        gameCanvas.style.height = window.innerHeight + "px";
        gameCtx.setTransform(currentDpr, 0, 0, currentDpr, 0, 0);
        // ç”»åƒã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å“è³ªã‚’é«˜ãè¨­å®š
        gameCtx.imageSmoothingEnabled = true;
        gameCtx.imageSmoothingQuality = "high";
      }

      // ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°ã‚’å–å¾—ï¼ˆCSSåº§æ¨™ç³»ã§è¨ˆç®—ï¼‰
      function getScale() {
        const baseWidth = 1440;
        const baseHeight = 900;
        const scaleX = window.innerWidth / baseWidth;
        const scaleY = window.innerHeight / baseHeight;
        return Math.min(scaleX, scaleY);
      }

      // èƒŒæ™¯ç”»åƒã®Yã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—ï¼ˆCSSã® calc(100 / 1440 * 100vw) ã«å¯¾å¿œï¼‰
      function getBgOffsetY() {
        return (100 / 1440) * window.innerWidth;
      }

      // çš„ã‚’åˆæœŸåŒ–ï¼ˆå›ºå®šé…ç½®ï¼‰
      function initTargets() {
        targets = [];

        // å›ºå®šé…ç½®: ç”»åƒã®é€šã‚Šã«ä¸¦ã¹ã‚‹
        const fixedLayout = [
          // ä¸Šæ®µï¼ˆ2å€‹ï¼‰: ãƒˆãƒ©ãƒƒã‚¯ã€çŠ¬
          { y: 0.15, sizeMultiplier: 1, items: [9, 8, 11] }, // target01, target02
          // ä¸­æ®µï¼ˆ5å€‹ï¼‰: ç¦è¢‹ã€ç¾½å­æ¿ã€ã‚¯ãƒã€èµ¤ã¹ã“ã€ãŠè“å­
          { y: 0.25, sizeMultiplier: 1, items: [5, 6] }, // target03-07
          // ä¸‹æ®µï¼ˆ5å€‹ï¼‰: äººå½¢ã€ã‚²ãƒ¼ãƒ æ©Ÿã€é¡é¤…ã€ã‚³ãƒã€ã‚¹ãƒãƒ¼ãƒ‰ãƒ¼ãƒ 
          { y: 0.4, sizeMultiplier: 1.0, items: [4, 0, 7] }, // target08-12
          { y: 0.5, sizeMultiplier: 1.0, items: [2, 12, 3, 10, 1] }, // target08-12
        ];

        fixedLayout.forEach((shelf, shelfIndex) => {
          const count = shelf.items.length;
          // çš„ã®é–“éš”ã‚’å›ºå®šï¼ˆ0.16ï¼‰ã—ã¦ä¸­å¤®æƒãˆ
          const spacingX = 0.16;
          const totalWidth = spacingX * (count - 1);
          const startX = 0.5 - totalWidth / 2; // ä¸­å¤®æƒãˆã®é–‹å§‹ä½ç½®

          shelf.items.forEach((typeIndex, i) => {
            const type = targetTypes[typeIndex];
            // å‹•ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¸Šæ®µã»ã©é€Ÿãå‹•ãï¼‰
            const moveSpeed = (0.002 + Math.random() * 0.002) * (3 - shelfIndex);
            const moveRange = 0.02 + Math.random() * 0.02;
            const xPos = startX + i * spacingX;
            targets.push({
              // æ­£è¦åŒ–åº§æ¨™ï¼ˆ0-1ï¼‰ã§ä¿æŒ - ä¸­å¤®æƒãˆ
              nx: xPos,
              ny: shelf.y,
              baseX: xPos, // å…ƒã®ä½ç½®
              baseSize: type.size * shelf.sizeMultiplier,
              image: type.image,
              points: type.points,
              isHit: false,
              hitTime: 0,
              // ç‰©ç†æ¼”ç®—ç”¨ï¼ˆæ­£è¦åŒ–é€Ÿåº¦ï¼‰
              nvx: 0,
              nvy: 0,
              rotation: 0,
              rotationSpeed: 0,
              // å·¦å³æºã‚Œç”¨
              moveSpeed: moveSpeed,
              moveRange: moveRange,
              movePhase: Math.random() * Math.PI * 2, // ãƒ©ãƒ³ãƒ€ãƒ ãªåˆæœŸä½ç›¸
            });
          });
        });
      }

      // èƒŒæ™¯ã¯ç”»åƒã§è¡¨ç¤ºï¼ˆCSSã§è¨­å®šæ¸ˆã¿ï¼‰

      // çš„ã‚’æç”»ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒï¼‰+ é£›ã‚“ã§ã„ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + å·¦å³æºã‚Œ
      function drawTargets() {
        const scale = getScale();
        const gravity = 0.0005; // æ­£è¦åŒ–ã•ã‚ŒãŸé‡åŠ›
        const offsetY = getBgOffsetY(); // èƒŒæ™¯ç”»åƒã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
        const time = Date.now() * 0.001; // ç§’å˜ä½ã®æ™‚é–“

        targets.forEach((target) => {
          const img = targetImages[target.image];
          if (!img || !img.complete) return;

          // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚µã‚¤ã‚º
          const size = target.baseSize * scale;

          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
          const aspectRatio = img.naturalWidth / img.naturalHeight;
          let drawWidth, drawHeight;
          if (aspectRatio > 1) {
            drawWidth = size;
            drawHeight = size / aspectRatio;
          } else {
            drawHeight = size;
            drawWidth = size * aspectRatio;
          }

          if (target.isHit) {
            const elapsed = Date.now() - target.hitTime;

            // ç‰©ç†æ¼”ç®—ï¼šæ­£è¦åŒ–é€Ÿåº¦ã‚’æ›´æ–°
            target.nvy += gravity;
            target.nx += target.nvx;
            target.ny += target.nvy;
            target.rotation += target.rotationSpeed;

            // æ­£è¦åŒ–åº§æ¨™ã‹ã‚‰å®Ÿåº§æ¨™ã«å¤‰æ›ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆé©ç”¨ï¼‰
            const x = target.nx * window.innerWidth;
            const y = target.ny * window.innerHeight + offsetY;

            // ç”»é¢å¤–ã«å‡ºãŸã‚‰æç”»ã—ãªã„
            if (y > window.innerHeight + 200) return;

            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ãªãŒã‚‰é£›ã‚“ã§ã„ã
            const alpha = Math.max(0, 1 - elapsed / 1500);
            if (alpha <= 0) return;

            gameCtx.save();
            gameCtx.globalAlpha = alpha;
            gameCtx.translate(x, y);
            gameCtx.rotate(target.rotation);
            gameCtx.drawImage(img, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
            gameCtx.restore();
          } else {
            // å·¦å³æºã‚Œã‚’é©ç”¨
            const swayOffset = Math.sin(time * target.moveSpeed * 50 + target.movePhase) * target.moveRange;
            target.nx = target.baseX + swayOffset;

            // æ­£è¦åŒ–åº§æ¨™ã‹ã‚‰å®Ÿåº§æ¨™ã«å¤‰æ›ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆé©ç”¨ï¼‰
            const x = target.nx * window.innerWidth;
            const y = target.ny * window.innerHeight + offsetY;
            // ä¸‹æƒãˆ: çš„ã®ä¸‹ç«¯ã‚’åŸºæº–yåº§æ¨™ã«æƒãˆã‚‹
            gameCtx.drawImage(img, x - drawWidth / 2, y - drawHeight, drawWidth, drawHeight);
          }
        });
      }

      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function render() {
        gameCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        drawTargets();
        updateParticles();
        drawParticles();
        requestAnimationFrame(render);
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      let particles = [];

      function createParticles(x, y, color, count) {
        for (let i = 0; i < count; i++) {
          const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
          const speed = 3 + Math.random() * 5;
          particles.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: 1,
            color: color,
            size: 3 + Math.random() * 4,
          });
        }
      }

      function updateParticles() {
        particles = particles.filter((p) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2; // é‡åŠ›
          p.life -= 0.03;
          return p.life > 0;
        });
      }

      function drawParticles() {
        particles.forEach((p) => {
          gameCtx.globalAlpha = p.life;
          gameCtx.fillStyle = p.color;
          gameCtx.beginPath();
          gameCtx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
          gameCtx.fill();
        });
        gameCtx.globalAlpha = 1;
      }

      // ç”»é¢æºã‚Œã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      function shakeScreen(intensity = 10) {
        const container = document.getElementById("container");
        const duration = 150;
        const startTime = Date.now();

        function shake() {
          const elapsed = Date.now() - startTime;
          if (elapsed < duration) {
            const remaining = 1 - elapsed / duration;
            const offsetX = (Math.random() - 0.5) * intensity * remaining;
            const offsetY = (Math.random() - 0.5) * intensity * remaining;
            container.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            requestAnimationFrame(shake);
          } else {
            container.style.transform = "";
          }
        }
        shake();
      }

      // ç™ºå°„å‡¦ç†
      function shoot(x, y) {
        if (!isGameRunning) return; // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯ç™ºå°„ä¸å¯
        const now = Date.now();
        if (now - lastShootTime < 300) return; // é€£å°„åˆ¶é™
        lastShootTime = now;

        // ãƒã‚ºãƒ«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        muzzleFlash.style.left = `${x}px`;
        muzzleFlash.style.top = `${y}px`;
        muzzleFlash.classList.add("flash");
        crosshair.classList.add("shooting");
        pistolIndicator.classList.add("shooting");

        // ç™ºå°„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        createParticles(x, y, "#ffaa00", 8);

        setTimeout(() => {
          muzzleFlash.classList.remove("flash");
          crosshair.classList.remove("shooting");
          pistolIndicator.classList.remove("shooting");
        }, 100);

        // å½“ãŸã‚Šåˆ¤å®š
        let hit = false;
        const scale = getScale();
        const offsetY = getBgOffsetY();
        targets.forEach((target) => {
          if (target.isHit) return;
          // æ­£è¦åŒ–åº§æ¨™ã‹ã‚‰å®Ÿåº§æ¨™ã«å¤‰æ›ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆé©ç”¨ï¼‰
          const targetX = target.nx * window.innerWidth;
          const baseY = target.ny * window.innerHeight + offsetY;
          const size = target.baseSize * scale;
          // ä¸‹æƒãˆãªã®ã§ã€çš„ã®ä¸­å¿ƒã¯ baseY - size/2
          const targetY = baseY - size / 2;

          const dx = x - targetX;
          const dy = y - targetY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < size * 0.4) {
            target.isHit = true;
            target.hitTime = now;
            score += target.points;
            updateScoreDisplay();

            hit = true;

            // ã€Œã±ã‚“ã€ã¨ã„ã†åŠ¹æœéŸ³ã‚’å†ç”Ÿ
            playHitSound();

            // çš„ãŒé£›ã‚“ã§ã„ãé€Ÿåº¦ã‚’è¨­å®šï¼ˆæ­£è¦åŒ–é€Ÿåº¦ï¼‰
            const hitAngle = Math.atan2(dy, dx);
            const knockbackSpeed = 0.008 + Math.random() * 0.004;
            target.nvx = -Math.cos(hitAngle) * knockbackSpeed + (Math.random() - 0.5) * 0.004;
            target.nvy = -Math.abs(Math.sin(hitAngle)) * knockbackSpeed - 0.005 - Math.random() * 0.003;
            target.rotationSpeed = (Math.random() - 0.5) * 0.3;

            // ãƒ’ãƒƒãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆæ´¾æ‰‹ã«ï¼‰
            createParticles(targetX, targetY, "#ff4444", 12);
            createParticles(targetX, targetY, "#ffff00", 8);
          }
        });

        // å…¨éƒ¨å€’ã—ãŸã‚‰å†ç”Ÿæˆ
        if (targets.every((t) => t.isHit)) {
          setTimeout(initTargets, 1500);
        }
      }

      // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ¤œå‡ºï¼ˆäººå·®ã—æŒ‡ã‚’æ›²ã’ã¦ç™ºå°„ï¼‰- å®‰å®šåŒ–ç‰ˆ
      function detectGesture(landmarks) {
        // äººå·®ã—æŒ‡ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
        const indexTip = landmarks[8]; // å…ˆç«¯
        const indexDip = landmarks[7]; // ç¬¬ä¸€é–¢ç¯€
        const indexPip = landmarks[6]; // ç¬¬äºŒé–¢ç¯€
        const indexMcp = landmarks[5]; // ä»˜ã‘æ ¹

        // æŒ‡ã®æ›²ã’å…·åˆã‚’æ•°å€¤åŒ–ï¼ˆ0=å®Œå…¨ã«ä¼¸ã³ã¦ã„ã‚‹ã€1=å®Œå…¨ã«æ›²ãŒã£ã¦ã„ã‚‹ï¼‰
        const bendAmount = (indexTip.y - indexPip.y) / 0.1; // æ­£è¦åŒ–
        const clampedBend = Math.max(0, Math.min(1, bendAmount + 0.5));

        // å±¥æ­´ã«è¿½åŠ 
        indexExtendedHistory.push(clampedBend);
        if (indexExtendedHistory.length > HISTORY_LENGTH) {
          indexExtendedHistory.shift();
        }

        // å±¥æ­´ã®å¹³å‡ã‚’è¨ˆç®—ï¼ˆã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
        const avgBend = indexExtendedHistory.reduce((a, b) => a + b, 0) / indexExtendedHistory.length;

        // é–¾å€¤ã§åˆ¤å®š
        const isExtended = avgBend < 0.3; // ä¼¸ã³ã¦ã„ã‚‹
        const isBent = avgBend > 0.6; // æ›²ãŒã£ã¦ã„ã‚‹

        // æ§‹ãˆçŠ¶æ…‹ï¼šäººå·®ã—æŒ‡ãŒä¼¸ã³ã¦ã„ã‚‹
        const isReady = isExtended;

        // ç™ºå°„åˆ¤å®šï¼šä¼¸ã³ã¦ã„ã‚‹çŠ¶æ…‹ã‹ã‚‰æ›²ãŒã£ãŸçŠ¶æ…‹ã¸ã®é·ç§»ã‚’æ¤œå‡º
        let isTrigger = false;
        if (canShoot && indexExtendedHistory.length >= HISTORY_LENGTH) {
          // å±¥æ­´ã®å‰åŠã¨å¾ŒåŠã‚’æ¯”è¼ƒ
          const firstHalf = indexExtendedHistory.slice(0, Math.floor(HISTORY_LENGTH / 2));
          const secondHalf = indexExtendedHistory.slice(Math.floor(HISTORY_LENGTH / 2));
          const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
          const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

          // å‰åŠãŒä¼¸ã³ã¦ã„ã¦ã€å¾ŒåŠãŒæ›²ãŒã£ã¦ã„ã‚‹å ´åˆã«ç™ºå°„
          if (firstAvg < 0.35 && secondAvg > 0.55) {
            isTrigger = true;
            canShoot = false;
            // ç™ºå°„å¾Œã€æŒ‡ã‚’ä¼¸ã°ã™ã¾ã§å†ç™ºå°„ä¸å¯
            setTimeout(() => {
              if (avgBend < 0.3) canShoot = true;
            }, 200);
          }
        }

        // æŒ‡ãŒä¼¸ã³ãŸã‚‰å†ç™ºå°„å¯èƒ½ã«
        if (isExtended && !canShoot) {
          canShoot = true;
        }

        return {
          isReady: isReady,
          isTrigger: isTrigger,
          indexBent: isBent,
          bendAmount: avgBend, // ãƒ‡ãƒãƒƒã‚°ç”¨
        };
      }

      // MediaPipeåˆæœŸåŒ–
      async function initializeHandLandmarker() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 1,
          minHandDetectionConfidence: 0.7,
          minHandPresenceConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });
      }

      function processHandLandmarks(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const landmarks = results.landmarks[0];

          // æ‰‹ã®éª¨æ ¼ã‚’æç”»
          canvasCtx.strokeStyle = "#ffd700";
          canvasCtx.lineWidth = 2;

          const connections = [
            [0, 1],
            [1, 2],
            [2, 3],
            [3, 4],
            [0, 5],
            [5, 6],
            [6, 7],
            [7, 8],
            [0, 9],
            [9, 10],
            [10, 11],
            [11, 12],
            [0, 13],
            [13, 14],
            [14, 15],
            [15, 16],
            [0, 17],
            [17, 18],
            [18, 19],
            [19, 20],
            [5, 9],
            [9, 13],
            [13, 17],
          ];

          connections.forEach(([start, end]) => {
            const startPoint = landmarks[start];
            const endPoint = landmarks[end];
            canvasCtx.beginPath();
            canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
            canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
            canvasCtx.stroke();
          });

          // äººå·®ã—æŒ‡ã®å…ˆç«¯ã§ç…§æº–ã‚’å‹•ã‹ã™
          const indexFingerTip = landmarks[8];
          const targetX = (1.0 - indexFingerTip.x) * window.innerWidth;
          const targetY = indexFingerTip.y * window.innerHeight;

          smoothX += (targetX - smoothX) * 0.3;
          smoothY += (targetY - smoothY) * 0.3;

          crosshair.style.left = `${smoothX}px`;
          crosshair.style.top = `${smoothY}px`;
          crosshair.style.display = "block";

          // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ¤œå‡ºï¼ˆäººå·®ã—æŒ‡ã‚’æ›²ã’ã¦ç™ºå°„ï¼‰
          const gesture = detectGesture(landmarks);

          // æ›²ã’å…·åˆã®ãƒãƒ¼è¡¨ç¤º
          const bendPercent = Math.round(gesture.bendAmount * 100);
          const bendBar = "â–ˆ".repeat(Math.round(bendPercent / 10)) + "â–‘".repeat(10 - Math.round(bendPercent / 10));

          // if (gesture.isReady) {
          //   pistolIndicator.classList.add("ready");
          //   gestureStatus.innerHTML = `â˜ï¸ æ§‹ãˆä¸­ï¼<br><small>${bendBar} ${bendPercent}%</small>`;
          //   gestureStatus.style.color = "#ffd700";
          // } else if (gesture.indexBent) {
          //   gestureStatus.innerHTML = `ğŸ‘† æ›²ã’ãŸï¼<br><small>${bendBar} ${bendPercent}%</small>`;
          //   gestureStatus.style.color = "#ff6b6b";
          // } else {
          //   pistolIndicator.classList.remove("ready");
          //   gestureStatus.innerHTML = `â˜ï¸ æŒ‡ã‚’ä¼¸ã°ã—ã¦...<br><small>${bendBar} ${bendPercent}%</small>`;
          //   gestureStatus.style.color = "#888";
          // }

          // ç™ºå°„åˆ¤å®š
          if (gesture.isTrigger) {
            shoot(smoothX, smoothY);
          }
        }
        canvasCtx.restore();
      }

      async function startCamera() {
        await initializeHandLandmarker();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
          });
          videoElement.srcObject = stream;

          videoElement.addEventListener("loadeddata", () => {
            loading.classList.add("hidden");
            startGame(); // ã‚²ãƒ¼ãƒ é–‹å§‹

            function onFrame() {
              if (!handLandmarker) return;

              const startTimeMs = performance.now();

              if (videoElement.currentTime !== lastVideoTime) {
                lastVideoTime = videoElement.currentTime;
                const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                processHandLandmarks(results);
              }

              requestAnimationFrame(onFrame);
            }
            onFrame();
          });
        } catch (error) {
          loading.querySelector("p").textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—: " + error.message;
        }
      }

      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
      const tutorialModal = document.getElementById("tutorial-modal");
      const startButton = document.getElementById("start-button");
      const nextButton = document.getElementById("next-button");
      const slides = document.querySelectorAll(".slide");
      const indicators = document.querySelectorAll(".slide-indicator");
      let currentSlide = 0;
      const totalSlides = slides.length;

      function goToSlide(index) {
        // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’prevã«
        slides[currentSlide].classList.remove("active");
        slides[currentSlide].classList.add("prev");
        indicators[currentSlide].classList.remove("active");

        // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’activeã«
        currentSlide = index;
        slides[currentSlide].classList.remove("prev");
        slides[currentSlide].classList.add("active");
        indicators[currentSlide].classList.add("active");

        // æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ãªã‚‰ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (currentSlide === totalSlides - 1) {
          nextButton.style.display = "none";
          startButton.style.display = "inline-block";
        }
      }

      nextButton.addEventListener("click", () => {
        if (currentSlide < totalSlides - 1) {
          goToSlide(currentSlide + 1);
        }
      });

      startButton.addEventListener("click", () => {
        tutorialModal.classList.add("hidden");
        loading.classList.remove("hidden");
        startCamera();
      });

      // åˆæœŸåŒ–
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      initTargets();
      render();
    </script>
  </body>
</html>
